<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>VoiceScribe Pro - æœ¬åœ°ä¼˜å…ˆè¯­éŸ³è½¬å†™</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --bg: #0f172a;
            --surface: #1e293b;
            --surface-light: #334155;
            --text: #f8fafc;
            --text-secondary: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --glass: rgba(30, 41, 59, 0.9);
            --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            position: relative;
        }

        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .bg-animation::before {
            content: '';
            position: absolute;
            width: 150%;
            height: 150%;
            background: radial-gradient(circle at 20% 80%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(236, 72, 153, 0.15) 0%, transparent 50%);
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translate(-10%, -10%) rotate(0deg); }
            50% { transform: translate(10%, 10%) rotate(180deg); }
        }

        .app-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom);
        }

        .header {
            padding: 16px 0;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 22px;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header .subtitle {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .connection-status {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-secondary);
            background: var(--surface);
            padding: 6px 12px;
            border-radius: 20px;
        }

        .connection-status.online {
            color: var(--success);
        }

        .connection-status.offline {
            color: var(--error);
        }

        .status-dot-small {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        .lang-selector {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            padding: 4px;
            background: var(--surface);
            border-radius: 16px;
        }

        .lang-option {
            flex: 1;
            padding: 10px 4px;
            text-align: center;
            border-radius: 12px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .lang-option.active {
            color: var(--text);
            background: var(--surface-light);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .mode-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .mode-badge {
            padding: 4px 12px;
            border-radius: 20px;
            background: var(--surface);
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .mode-badge.recording {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
            animation: pulse 2s infinite;
        }

        .transcript-container {
            flex: 1;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 16px;
            overflow-y: auto;
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: var(--shadow);
            position: relative;
        }

        .transcript-container::-webkit-scrollbar {
            width: 4px;
        }

        .transcript-container::-webkit-scrollbar-thumb {
            background: var(--surface-light);
            border-radius: 2px;
        }

        .empty-state {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--text-secondary);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .empty-state.show {
            opacity: 1;
        }

        .empty-state svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .transcript-content {
            font-size: 17px;
            line-height: 1.6;
            min-height: 100%;
        }

        .transcript-segment {
            margin-bottom: 16px;
            animation: slideIn 0.3s ease;
            position: relative;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .segment-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .segment-time {
            font-family: monospace;
            background: rgba(255,255,255,0.1);
            padding: 2px 8px;
            border-radius: 4px;
        }

        .segment-type {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .segment-type.final {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .segment-type.interim {
            background: rgba(59, 130, 246, 0.2);
            color: var(--info);
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .segment-text {
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            border-left: 3px solid var(--primary);
            word-wrap: break-word;
            transition: all 0.3s;
        }

        .segment-text.interim {
            border-left-color: var(--info);
            opacity: 0.9;
        }

        .segment-text:hover {
            background: rgba(255,255,255,0.08);
        }

        .audio-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: auto;
            font-size: 10px;
            color: var(--success);
        }

        .wave-mini {
            display: flex;
            align-items: center;
            gap: 2px;
            height: 12px;
        }

        .wave-bar-mini {
            width: 2px;
            background: currentColor;
            border-radius: 1px;
            animation: wave 1s ease-in-out infinite;
        }

        .wave-bar-mini:nth-child(2) { animation-delay: 0.1s; }
        .wave-bar-mini:nth-child(3) { animation-delay: 0.2s; }

        @keyframes wave {
            0%, 100% { height: 4px; }
            50% { height: 12px; }
        }

        .controls {
            background: var(--surface);
            border-radius: 20px;
            padding: 16px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .main-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .control-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: var(--surface-light);
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            position: relative;
        }

        .control-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .control-btn:active:not(:disabled) {
            transform: scale(0.92);
        }

        .control-btn.record {
            width: 64px;
            height: 64px;
            background: var(--gradient-1);
            box-shadow: 0 8px 20px -5px rgba(99, 102, 241, 0.5);
        }

        .control-btn.record.recording {
            background: var(--gradient-2);
            animation: recording-pulse 2s infinite;
        }

        @keyframes recording-pulse {
            0%, 100% { box-shadow: 0 8px 20px -5px rgba(236, 72, 153, 0.5); }
            50% { box-shadow: 0 8px 30px -5px rgba(236, 72, 153, 0.8); }
        }

        .control-btn svg {
            width: 20px;
            height: 20px;
        }

        .control-btn.record svg {
            width: 24px;
            height: 24px;
        }

        .secondary-controls {
            display: flex;
            justify-content: space-around;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .icon-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 11px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.3s;
            padding: 8px 12px;
            border-radius: 12px;
            position: relative;
        }

        .icon-btn:active {
            background: rgba(255,255,255,0.1);
            color: var(--text);
        }

        .icon-btn.active {
            color: var(--primary);
        }

        .icon-btn svg {
            width: 18px;
            height: 18px;
        }

        .icon-btn .badge {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 8px;
            height: 8px;
            background: var(--error);
            border-radius: 50%;
            display: none;
        }

        .icon-btn.has-recording .badge {
            display: block;
        }

        .visualizer-container {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .visualizer-container.active {
            opacity: 1;
        }

        .visualizer {
            display: flex;
            align-items: flex-end;
            gap: 3px;
            height: 100%;
        }

        .bar {
            width: 4px;
            background: var(--primary);
            border-radius: 2px;
            transition: height 0.05s ease;
            min-height: 4px;
        }

        .stats-bar {
            display: flex;
            justify-content: space-around;
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            padding: 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-weight: 600;
            color: var(--text);
            font-size: 12px;
        }

        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: var(--surface);
            color: var(--text);
            padding: 16px 24px;
            border-radius: 16px;
            font-size: 14px;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
            z-index: 1000;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,0.1);
            max-width: 80%;
            text-align: center;
        }

        .toast.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .toast.error {
            border-color: var(--error);
            color: var(--error);
        }

        .toast.success {
            border-color: var(--success);
            color: var(--success);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 24px;
            padding: 24px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .close-modal {
            background: var(--surface-light);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .recording-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .recording-item {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .recording-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .recording-info {
            flex: 1;
        }

        .recording-name {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .recording-meta {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .recording-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: var(--surface-light);
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            background: var(--primary);
        }

        .empty-recordings {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 3px;
            background: var(--gradient-1);
            width: 0%;
            transition: width 0.3s;
            z-index: 1001;
        }

        .progress-bar.active {
            animation: progress 2s infinite;
        }

        @keyframes progress {
            0% { width: 0%; opacity: 1; }
            50% { width: 70%; opacity: 1; }
            100% { width: 100%; opacity: 0; }
        }

        @media (min-width: 768px) {
            .app-container {
                max-width: 600px;
                margin: 0 auto;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    <div class="progress-bar" id="progressBar"></div>
    
    <div class="app-container">
        <header class="header">
            <h1>VoiceScribe Pro</h1>
            <div class="subtitle">æœ¬åœ°ä¼˜å…ˆ Â· ç¦»çº¿å¯ç”¨</div>
            <div class="connection-status online" id="connectionStatus">
                <div class="status-dot-small"></div>
                <span id="connectionText">åœ¨çº¿</span>
            </div>
        </header>

        <div class="lang-selector">
            <button class="lang-option active" data-lang="zh-CN" onclick="setLanguage('zh-CN')">ğŸ‡¨ğŸ‡³ æ™®é€šè¯</button>
            <button class="lang-option" data-lang="en-US" onclick="setLanguage('en-US')">ğŸ‡ºğŸ‡¸ English</button>
            <button class="lang-option" data-lang="zh-CN,en-US" onclick="setLanguage('zh-CN,en-US')">ğŸŒ æ··åˆ</button>
        </div>

        <div class="mode-indicator">
            <div class="mode-badge" id="modeBadge">
                <span>ğŸ¤</span>
                <span>ç‚¹å‡»å¼€å§‹å½•éŸ³</span>
            </div>
            <div style="font-size: 11px; opacity: 0.7;">
                å½•éŸ³æ—¶é•¿: <span id="recordTime">00:00</span>
            </div>
        </div>

        <div class="transcript-container" id="transcriptContainer">
            <div class="empty-state show" id="emptyState">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z"></path>
                </svg>
                <div>å‡†å¤‡å°±ç»ª</div>
                <div style="font-size: 11px; margin-top: 8px; opacity: 0.6;">
                    æœ¬åœ°å½•éŸ³ + äº‘ç«¯è¯†åˆ«åŒä¿é™©<br>
                    ç½‘ç»œä¸ç¨³å®šæ—¶è‡ªåŠ¨é™çº§
                </div>
            </div>
            <div class="transcript-content" id="transcriptContent"></div>
        </div>

        <div class="controls">
            <div class="stats-bar" id="statsBar" style="display: none;">
                <div class="stat-item">
                    <div class="stat-value" id="statSegments">0</div>
                    <div>ç‰‡æ®µ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statChars">0</div>
                    <div>å­—æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statAccuracy">--</div>
                    <div>å‡†ç¡®ç‡</div>
                </div>
            </div>

            <div class="visualizer-container" id="visualizerContainer">
                <div class="visualizer" id="visualizer"></div>
            </div>
            
            <div class="main-controls">
                <button class="control-btn" id="clearBtn" onclick="clearTranscript()" disabled title="æ¸…ç©º">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>

                <button class="control-btn record" id="recordBtn" onclick="toggleRecording()" title="å½•éŸ³">
                    <svg id="micIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                        <line x1="12" y1="19" x2="12" y2="23"></line>
                        <line x1="8" y1="23" x2="16" y2="23"></line>
                    </svg>
                    <svg id="stopIcon" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
                        <rect x="6" y="6" width="12" height="12" rx="2"></rect>
                    </svg>
                </button>

                <button class="control-btn" id="saveBtn" onclick="saveCurrentSession()" disabled title="ä¿å­˜">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                </button>
            </div>

            <div class="secondary-controls">
                <button class="icon-btn" onclick="showRecordings()" id="recordingsBtn">
                    <div class="badge"></div>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    <span>å½•éŸ³åº“</span>
                </button>
                <button class="icon-btn" onclick="copyTranscript()" id="copyBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path>
                    </svg>
                    <span>å¤åˆ¶</span>
                </button>
                <button class="icon-btn" onclick="exportContent()" id="exportBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    <span>å¯¼å‡º</span>
                </button>
                <button class="icon-btn" onclick="toggleAutoSave()" id="autoSaveBtn" title="è‡ªåŠ¨ä¿å­˜å½•éŸ³">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                    </svg>
                    <span>è‡ªåŠ¨å­˜</span>
                </button>
            </div>
        </div>
    </div>

    <!-- å½•éŸ³åº“æ¨¡æ€æ¡† -->
    <div class="modal" id="recordingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ğŸ“ å½•éŸ³åº“</div>
                <button class="close-modal" onclick="closeRecordings()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="recording-list" id="recordingList">
                <div class="empty-recordings">
                    <div style="font-size: 48px; margin-bottom: 16px;">ğŸµ</div>
                    <div>æš‚æ— ä¿å­˜çš„å½•éŸ³</div>
                    <div style="font-size: 12px; margin-top: 8px; opacity: 0.7;">
                        å½•éŸ³ä¼šè‡ªåŠ¨ä¿å­˜åˆ°è¿™é‡Œ
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // å…¨å±€çŠ¶æ€
        let recognition = null;
        let isRecording = false;
        let currentLang = 'zh-CN';
        let mediaRecorder = null;
        let audioChunks = [];
        let audioBlob = null;
        let audioUrl = null;
        let recordStartTime = null;
        let recordTimer = null;
        let recognitionRetryCount = 0;
        let maxRetries = 3;
        let transcriptSegments = [];
        let interimSegment = null;
        let autoSave = false;
        let savedRecordings = JSON.parse(localStorage.getItem('voiceScribe_recordings') || '[]');
        
        // DOM å…ƒç´ 
        const recordBtn = document.getElementById('recordBtn');
        const micIcon = document.getElementById('micIcon');
        const stopIcon = document.getElementById('stopIcon');
        const modeBadge = document.getElementById('modeBadge');
        const recordTime = document.getElementById('recordTime');
        const transcriptContent = document.getElementById('transcriptContent');
        const emptyState = document.getElementById('emptyState');
        const clearBtn = document.getElementById('clearBtn');
        const saveBtn = document.getElementById('saveBtn');
        const visualizerContainer = document.getElementById('visualizerContainer');
        const connectionStatus = document.getElementById('connectionStatus');
        const connectionText = document.getElementById('connectionText');
        const progressBar = document.getElementById('progressBar');

        // åˆå§‹åŒ–
        async function init() {
            checkNetworkStatus();
            initVisualizer();
            updateRecordingBadge();
            
            // ç›‘å¬ç½‘ç»œçŠ¶æ€
            window.addEventListener('online', () => updateNetworkStatus(true));
            window.addEventListener('offline', () => updateNetworkStatus(false));
            
            // å®šæœŸæ¸…ç†æ—§å½•éŸ³ï¼ˆä¿ç•™æœ€è¿‘20ä¸ªï¼‰
            cleanupOldRecordings();
            
            // é¢„è¯·æ±‚éº¦å…‹é£æƒé™
            try {
                await navigator.mediaDevices.getUserMedia({ audio: true });
            } catch (e) {
                console.log('Initial mic permission check:', e);
            }
        }

        // ç½‘ç»œçŠ¶æ€ç®¡ç†
        function checkNetworkStatus() {
            updateNetworkStatus(navigator.onLine);
        }

        function updateNetworkStatus(isOnline) {
            if (isOnline) {
                connectionStatus.classList.remove('offline');
                connectionStatus.classList.add('online');
                connectionText.textContent = 'åœ¨çº¿';
            } else {
                connectionStatus.classList.remove('online');
                connectionStatus.classList.add('offline');
                connectionText.textContent = 'ç¦»çº¿';
                showToast('è¿›å…¥ç¦»çº¿æ¨¡å¼ï¼Œä»…ä¿å­˜å½•éŸ³', 'warning');
            }
        }

        // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                showToast('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œå°†ä»…ä¿å­˜å½•éŸ³', 'error');
                return null;
            }

            const rec = new SpeechRecognition();
            rec.continuous = true;
            rec.interimResults = true;
            rec.lang = currentLang;
            rec.maxAlternatives = 1;

            rec.onstart = () => {
                recognitionRetryCount = 0;
                showProgress(false);
            };

            rec.onresult = (event) => {
                handleRecognitionResult(event);
            };

            rec.onerror = (event) => {
                handleRecognitionError(event);
            };

            rec.onend = () => {
                if (isRecording && recognitionRetryCount < maxRetries) {
                    recognitionRetryCount++;
                    console.log(`Recognition ended, retrying... (${recognitionRetryCount}/${maxRetries})`);
                    setTimeout(() => {
                        if (isRecording) startRecognition();
                    }, 500);
                }
            };

            return rec;
        }

        // å¤„ç†è¯†åˆ«ç»“æœ - ä¼˜åŒ–å“åº”é€Ÿåº¦
        function handleRecognitionResult(event) {
            const results = event.results;
            const lastResult = results[results.length - 1];
            const transcript = lastResult[0].transcript;
            const confidence = lastResult[0].confidence || 0.8;
            const isFinal = lastResult.isFinal;

            // ç«‹å³éšè—ç©ºçŠ¶æ€
            if (emptyState.classList.contains('show')) {
                emptyState.classList.remove('show');
                document.getElementById('statsBar').style.display = 'flex';
            }

            if (isFinal) {
                // æœ€ç»ˆç»“æœ - ç«‹å³æäº¤
                addFinalSegment(transcript, confidence);
                interimSegment = null;
            } else {
                // ä¸­é—´ç»“æœ - å®æ—¶æ›´æ–°ï¼Œä¸ç­‰å¾…
                updateInterimSegment(transcript);
            }

            updateStats();
        }

        // æ·»åŠ æœ€ç»ˆç‰‡æ®µ
        function addFinalSegment(text, confidence) {
            const segment = {
                id: Date.now(),
                text: text,
                confidence: confidence,
                time: new Date().toLocaleTimeString('zh-CN'),
                timestamp: Date.now(),
                type: 'final'
            };
            
            transcriptSegments.push(segment);
            renderSegment(segment, true);
            
            // è‡ªåŠ¨æ»šåŠ¨
            scrollToBottom();
        }

        // æ›´æ–°ä¸­é—´ç‰‡æ®µï¼ˆå®æ—¶ï¼‰
        function updateInterimSegment(text) {
            if (!interimSegment) {
                interimSegment = {
                    id: 'interim-' + Date.now(),
                    text: text,
                    time: new Date().toLocaleTimeString('zh-CN'),
                    type: 'interim'
                };
                renderSegment(interimSegment, false);
            } else {
                interimSegment.text = text;
                updateInterimRender();
            }
            scrollToBottom();
        }

        // æ¸²æŸ“ç‰‡æ®µ
        function renderSegment(segment, isFinal) {
            const div = document.createElement('div');
            div.className = 'transcript-segment';
            div.id = 'segment-' + segment.id;
            
            const confidencePercent = Math.round((segment.confidence || 0.8) * 100);
            
            div.innerHTML = `
                <div class="segment-header">
                    <span class="segment-time">${segment.time}</span>
                    <span class="segment-type ${segment.type}">${isFinal ? 'âœ“ å®Œæˆ' : 'Â·Â·Â· è¯†åˆ«ä¸­'}</span>
                    ${isFinal ? `<span style="margin-left: auto; font-size: 10px; opacity: 0.6;">${confidencePercent}%</span>` : ''}
                </div>
                <div class="segment-text ${segment.type}">${escapeHtml(segment.text)}</div>
            `;
            
            // å¦‚æœæ˜¯ä¸­é—´ç»“æœï¼Œå…ˆç§»é™¤æ—§çš„
            if (!isFinal) {
                const old = document.getElementById('segment-interim');
                if (old) old.remove();
                div.id = 'segment-interim';
            }
            
            transcriptContent.appendChild(div);
        }

        // æ›´æ–°ä¸­é—´æ¸²æŸ“
        function updateInterimRender() {
            const el = document.querySelector('#segment-interim .segment-text');
            if (el && interimSegment) {
                el.textContent = interimSegment.text;
            }
        }

        // å¤„ç†è¯†åˆ«é”™è¯¯ - æ™ºèƒ½é‡è¯•
        function handleRecognitionError(event) {
            console.error('Recognition error:', event.error);
            
            switch(event.error) {
                case 'network':
                    showToast('ç½‘ç»œæ³¢åŠ¨ï¼Œå°è¯•é‡è¿...', 'warning');
                    // ä¸åœæ­¢å½•éŸ³ï¼Œè®© onend å¤„ç†é‡è¯•
                    break;
                case 'no-speech':
                    // æ­£å¸¸æƒ…å†µï¼Œæ— éœ€å¤„ç†
                    break;
                case 'audio-capture':
                    showToast('æ— æ³•è®¿é—®éº¦å…‹é£', 'error');
                    stopRecording();
                    break;
                case 'not-allowed':
                    showToast('è¯·å…è®¸éº¦å…‹é£æƒé™', 'error');
                    stopRecording();
                    break;
                case 'aborted':
                    // ç”¨æˆ·ä¸»åŠ¨åœæ­¢
                    break;
                default:
                    console.log('Recognition error:', event.error);
            }
        }

        // å¼€å§‹è¯†åˆ«
        function startRecognition() {
            if (!recognition) {
                recognition = initSpeechRecognition();
            }
            
            if (!recognition) return; // ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«
            
            try {
                recognition.lang = currentLang;
                recognition.start();
            } catch (e) {
                console.error('Start recognition failed:', e);
            }
        }

        // åœæ­¢è¯†åˆ«
        function stopRecognition() {
            if (recognition) {
                try {
                    recognition.stop();
                } catch (e) {
                    console.error('Stop recognition failed:', e);
                }
            }
        }

        // åˆ‡æ¢å½•éŸ³
        async function toggleRecording() {
            if (isRecording) {
                await stopRecording();
            } else {
                await startRecording();
            }
        }

        // å¼€å§‹å½•éŸ³ï¼ˆåŒä¿é™©ï¼šæœ¬åœ°éŸ³é¢‘ + äº‘ç«¯è¯†åˆ«ï¼‰
        async function startRecording() {
            try {
                // 1. è·å–éº¦å…‹é£æƒé™å¹¶å¯åŠ¨æœ¬åœ°å½•éŸ³
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 16000 // ä¼˜åŒ–è¯†åˆ«ç‡
                    } 
                });
                
                // 2. å¯åŠ¨ MediaRecorderï¼ˆæœ¬åœ°å¤‡ä»½ï¼‰
                audioChunks = [];
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/mp4'
                });
                
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) audioChunks.push(e.data);
                };
                
                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
                    audioUrl = URL.createObjectURL(audioBlob);
                    if (autoSave) saveCurrentSession();
                };
                
                mediaRecorder.start(1000); // æ¯ç§’æ”¶é›†ä¸€æ¬¡æ•°æ®ï¼Œé˜²æ­¢ä¸¢å¤±
                
                // 3. å¯åŠ¨è¯­éŸ³è¯†åˆ«ï¼ˆå¦‚æœåœ¨çº¿ï¼‰
                if (navigator.onLine) {
                    showProgress(true);
                    startRecognition();
                } else {
                    showToast('ç¦»çº¿æ¨¡å¼ï¼šä»…ä¿å­˜å½•éŸ³', 'warning');
                }
                
                // 4. æ›´æ–°çŠ¶æ€
                isRecording = true;
                recordStartTime = Date.now();
                startRecordTimer();
                updateUIState();
                startVisualizer(stream);
                
                // 5. æ˜¾ç¤ºæç¤º
                showToast('å½•éŸ³å¼€å§‹', 'success');
                
            } catch (err) {
                console.error('Start recording failed:', err);
                showToast('å¯åŠ¨å¤±è´¥ï¼š' + err.message, 'error');
            }
        }

        // åœæ­¢å½•éŸ³
        async function stopRecording() {
            isRecording = false;
            
            // åœæ­¢è®¡æ—¶
            stopRecordTimer();
            
            // åœæ­¢è¯­éŸ³è¯†åˆ«
            stopRecognition();
            
            // åœæ­¢ MediaRecorder
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                // åœæ­¢æ‰€æœ‰éŸ³è½¨
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
            
            // åœæ­¢å¯è§†åŒ–
            stopVisualizer();
            
            // æ›´æ–° UI
            updateUIState();
            showProgress(false);
            
            // æ¸…ç†ä¸­é—´ç»“æœ
            removeInterim();
            
            showToast('å½•éŸ³å·²ä¿å­˜', 'success');
            
            // è‡ªåŠ¨ä¿å­˜å¦‚æœå¼€å¯
            if (autoSave && audioBlob) {
                setTimeout(() => saveCurrentSession(), 500);
            }
        }

        // è®¡æ—¶å™¨
        function startRecordTimer() {
            recordTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - recordStartTime) / 1000);
                const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const secs = (elapsed % 60).toString().padStart(2, '0');
                recordTime.textContent = `${mins}:${secs}`;
            }, 1000);
        }

        function stopRecordTimer() {
            if (recordTimer) {
                clearInterval(recordTimer);
                recordTimer = null;
            }
            recordTime.textContent = '00:00';
        }

        // æ›´æ–° UI çŠ¶æ€
        function updateUIState() {
            if (isRecording) {
                recordBtn.classList.add('recording');
                micIcon.style.display = 'none';
                stopIcon.style.display = 'block';
                modeBadge.classList.add('recording');
                modeBadge.innerHTML = '<span>ğŸ”´</span><span>å½•éŸ³ä¸­</span>';
                visualizerContainer.classList.add('active');
                clearBtn.disabled = true;
                saveBtn.disabled = true;
            } else {
                recordBtn.classList.remove('recording');
                micIcon.style.display = 'block';
                stopIcon.style.display = 'none';
                modeBadge.classList.remove('recording');
                modeBadge.innerHTML = '<span>ğŸ¤</span><span>ç‚¹å‡»å¼€å§‹å½•éŸ³</span>';
                visualizerContainer.classList.remove('active');
                clearBtn.disabled = transcriptSegments.length === 0;
                saveBtn.disabled = transcriptSegments.length === 0 && !audioBlob;
            }
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const hasContent = transcriptSegments.length > 0;
            document.getElementById('copyBtn').disabled = !hasContent;
            document.getElementById('exportBtn').disabled = !hasContent;
        }

        // ç§»é™¤ä¸­é—´ç»“æœ
        function removeInterim() {
            const interim = document.getElementById('segment-interim');
            if (interim) {
                interim.remove();
            }
            interimSegment = null;
        }

        // è®¾ç½®è¯­è¨€
        function setLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('.lang-option').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === lang);
            });
            
            if (isRecording) {
                // é‡å¯è¯†åˆ«ä»¥åº”ç”¨æ–°è¯­è¨€
                stopRecognition();
                setTimeout(() => startRecognition(), 300);
            }
            
            showToast(`å·²åˆ‡æ¢: ${getLangName(lang)}`, 'success');
        }

        function getLangName(lang) {
            const names = {
                'zh-CN': 'æ™®é€šè¯',
                'en-US': 'English',
                'zh-CN,en-US': 'æ··åˆ'
            };
            return names[lang] || lang;
        }

        // æ¸…ç©ºè½¬å†™
        function clearTranscript() {
            if (transcriptSegments.length === 0 && !audioBlob) return;
            
            if (confirm('ç¡®å®šæ¸…ç©ºå½“å‰å†…å®¹ï¼Ÿå·²ä¿å­˜çš„å½•éŸ³ä¸ä¼šè¢«åˆ é™¤ã€‚')) {
                transcriptSegments = [];
                transcriptContent.innerHTML = '';
                audioBlob = null;
                audioUrl = null;
                emptyState.classList.add('show');
                document.getElementById('statsBar').style.display = 'none';
                updateUIState();
                showToast('å·²æ¸…ç©º', 'success');
            }
        }

        // ä¿å­˜å½“å‰ä¼šè¯
        function saveCurrentSession() {
            if (!audioBlob && transcriptSegments.length === 0) {
                showToast('æ²¡æœ‰å¯ä¿å­˜çš„å†…å®¹', 'warning');
                return;
            }
            
            const recording = {
                id: Date.now(),
                date: new Date().toLocaleString('zh-CN'),
                duration: recordTime.textContent,
                segments: [...transcriptSegments],
                text: transcriptSegments.map(s => s.text).join('\n'),
                audioSize: audioBlob ? (audioBlob.size / 1024 / 1024).toFixed(2) + ' MB' : '0 MB'
            };
            
            // ä¿å­˜éŸ³é¢‘ blob åˆ° IndexedDBï¼ˆå¤ªå¤§ä¸é€‚åˆ localStorageï¼‰
            if (audioBlob) {
                saveAudioToIndexedDB(recording.id, audioBlob);
            }
            
            savedRecordings.unshift(recording);
            localStorage.setItem('voiceScribe_recordings', JSON.stringify(savedRecordings));
            
            updateRecordingBadge();
            showToast('å·²ä¿å­˜åˆ°å½•éŸ³åº“', 'success');
        }

        // IndexedDB å­˜å‚¨éŸ³é¢‘
        function saveAudioToIndexedDB(id, blob) {
            const request = indexedDB.open('VoiceScribeDB', 1);
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains('audios')) {
                    db.createObjectStore('audios', { keyPath: 'id' });
                }
            };
            
            request.onsuccess = (event) => {
                const db = event.target.result;
                const transaction = db.transaction(['audios'], 'readwrite');
                const store = transaction.objectStore('audios');
                store.put({ id: id, blob: blob, timestamp: Date.now() });
            };
        }

        function getAudioFromIndexedDB(id, callback) {
            const request = indexedDB.open('VoiceScribeDB', 1);
            request.onsuccess = (event) => {
                const db = event.target.result;
                const transaction = db.transaction(['audios'], 'readonly');
                const store = transaction.objectStore('audios');
                const getRequest = store.get(id);
                getRequest.onsuccess = () => callback(getRequest.result?.blob);
            };
        }

        // æ˜¾ç¤ºå½•éŸ³åº“
        function showRecordings() {
            const modal = document.getElementById('recordingsModal');
            const list = document.getElementById('recordingList');
            
            if (savedRecordings.length === 0) {
                list.innerHTML = `
                    <div class="empty-recordings">
                        <div style="font-size: 48px; margin-bottom: 16px;">ğŸµ</div>
                        <div>æš‚æ— ä¿å­˜çš„å½•éŸ³</div>
                        <div style="font-size: 12px; margin-top: 8px; opacity: 0.7;">
                            å½•éŸ³ä¼šè‡ªåŠ¨ä¿å­˜åˆ°è¿™é‡Œ
                        </div>
                    </div>
                `;
            } else {
                list.innerHTML = savedRecordings.map(rec => `
                    <div class="recording-item" onclick="loadRecording(${rec.id})">
                        <div style="font-size: 24px;">ğŸ™ï¸</div>
                        <div class="recording-info">
                            <div class="recording-name">${rec.date}</div>
                            <div class="recording-meta">
                                ${rec.duration} Â· ${rec.segments.length} ç‰‡æ®µ Â· ${rec.audioSize}
                            </div>
                        </div>
                        <div class="recording-actions" onclick="event.stopPropagation()">
                            <button class="action-btn" onclick="playRecording(${rec.id})" title="æ’­æ”¾">â–¶</button>
                            <button class="action-btn" onclick="deleteRecording(${rec.id})" title="åˆ é™¤">ğŸ—‘</button>
                        </div>
                    </div>
                `).join('');
            }
            
            modal.classList.add('show');
        }

        function closeRecordings() {
            document.getElementById('recordingsModal').classList.remove('show');
        }

        // åŠ è½½å½•éŸ³åˆ°å½“å‰è§†å›¾
        function loadRecording(id) {
            const rec = savedRecordings.find(r => r.id === id);
            if (!rec) return;
            
            if (transcriptSegments.length > 0 && !confirm('åŠ è½½å°†æ›¿æ¢å½“å‰å†…å®¹ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                return;
            }
            
            transcriptSegments = [...rec.segments];
            transcriptContent.innerHTML = '';
            
            transcriptSegments.forEach(seg => renderSegment(seg, true));
            
            emptyState.classList.remove('show');
            document.getElementById('statsBar').style.display = 'flex';
            updateStats();
            updateUIState();
            closeRecordings();
            
            showToast('å·²åŠ è½½å½•éŸ³', 'success');
        }

        // æ’­æ”¾å½•éŸ³
        function playRecording(id) {
            getAudioFromIndexedDB(id, (blob) => {
                if (blob) {
                    const url = URL.createObjectURL(blob);
                    const audio = new Audio(url);
                    audio.play();
                } else {
                    showToast('éŸ³é¢‘æ•°æ®ä¸å­˜åœ¨', 'error');
                }
            });
        }

        // åˆ é™¤å½•éŸ³
        function deleteRecording(id) {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤å½•éŸ³ï¼Ÿ')) return;
            
            savedRecordings = savedRecordings.filter(r => r.id !== id);
            localStorage.setItem('voiceScribe_recordings', JSON.stringify(savedRecordings));
            
            // åˆ é™¤ IndexedDB ä¸­çš„éŸ³é¢‘
            const request = indexedDB.open('VoiceScribeDB', 1);
            request.onsuccess = (event) => {
                const db = event.target.result;
                const transaction = db.transaction(['audios'], 'readwrite');
                const store = transaction.objectStore('audios');
                store.delete(id);
            };
            
            updateRecordingBadge();
            showRecordings(); // åˆ·æ–°åˆ—è¡¨
            showToast('å·²åˆ é™¤', 'success');
        }

        // æ›´æ–°å½•éŸ³å¾½ç« 
        function updateRecordingBadge() {
            const btn = document.getElementById('recordingsBtn');
            if (savedRecordings.length > 0) {
                btn.classList.add('has-recording');
            } else {
                btn.classList.remove('has-recording');
            }
        }

        // æ¸…ç†æ—§å½•éŸ³
        function cleanupOldRecordings() {
            if (savedRecordings.length > 20) {
                const toDelete = savedRecordings.slice(20);
                savedRecordings = savedRecordings.slice(0, 20);
                localStorage.setItem('voiceScribe_recordings', JSON.stringify(savedRecordings));
                
                // æ¸…ç†å¯¹åº”çš„éŸ³é¢‘æ–‡ä»¶
                const request = indexedDB.open('VoiceScribeDB', 1);
                request.onsuccess = (event) => {
                    const db = event.target.result;
                    const transaction = db.transaction(['audios'], 'readwrite');
                    const store = transaction.objectStore('audios');
                    toDelete.forEach(rec => store.delete(rec.id));
                };
            }
        }

        // å¤åˆ¶è½¬å†™
        function copyTranscript() {
            if (transcriptSegments.length === 0) return;
            
            const text = transcriptSegments.map(s => s.text).join('\n');
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                }).catch(() => fallbackCopy(text));
            } else {
                fallbackCopy(text);
            }
        }

        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            } catch (err) {
                showToast('å¤åˆ¶å¤±è´¥', 'error');
            }
            
            document.body.removeChild(textarea);
        }

        // å¯¼å‡ºå†…å®¹
        function exportContent() {
            if (transcriptSegments.length === 0) return;
            
            const text = transcriptSegments.map(s => `[${s.time}] ${s.text}`).join('\n');
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `è½¬å†™_${new Date().toLocaleDateString()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('å·²å¯¼å‡ºæ–‡æœ¬', 'success');
        }

        // åˆ‡æ¢è‡ªåŠ¨ä¿å­˜
        function toggleAutoSave() {
            autoSave = !autoSave;
            const btn = document.getElementById('autoSaveBtn');
            btn.classList.toggle('active', autoSave);
            btn.style.color = autoSave ? 'var(--primary)' : 'var(--text-secondary)';
            showToast(autoSave ? 'è‡ªåŠ¨ä¿å­˜å·²å¼€å¯' : 'è‡ªåŠ¨ä¿å­˜å·²å…³é—­', 'success');
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            document.getElementById('statSegments').textContent = transcriptSegments.length;
            const totalChars = transcriptSegments.reduce((sum, seg) => sum + seg.text.length, 0);
            document.getElementById('statChars').textContent = totalChars;
            
            if (transcriptSegments.length > 0) {
                const avgConfidence = transcriptSegments.reduce((sum, seg) => sum + (seg.confidence || 0.8), 0) / transcriptSegments.length;
                document.getElementById('statAccuracy').textContent = Math.round(avgConfidence * 100) + '%';
            }
        }

        // å¯è§†åŒ–
        function initVisualizer() {
            const container = document.getElementById('visualizer');
            for (let i = 0; i < 16; i++) {
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = '4px';
                container.appendChild(bar);
            }
        }

        let visualizerInterval;
        function startVisualizer(stream) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);
            analyser.fftSize = 32;
            
            const bars = document.querySelectorAll('.bar');
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            
            visualizerInterval = setInterval(() => {
                analyser.getByteFrequencyData(dataArray);
                bars.forEach((bar, index) => {
                    const value = dataArray[index] || 0;
                    const height = Math.max(4, (value / 255) * 40);
                    bar.style.height = height + 'px';
                    bar.style.opacity = 0.5 + (value / 255) * 0.5;
                });
            }, 50);
        }

        function stopVisualizer() {
            if (visualizerInterval) {
                clearInterval(visualizerInterval);
                visualizerInterval = null;
            }
            document.querySelectorAll('.bar').forEach(bar => {
                bar.style.height = '4px';
                bar.style.opacity = '1';
            });
        }

        // è¿›åº¦æ¡
        function showProgress(show) {
            if (show) {
                progressBar.classList.add('active');
            } else {
                progressBar.classList.remove('active');
            }
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            const container = document.getElementById('transcriptContainer');
            container.scrollTo({
                top: container.scrollHeight,
                behavior: 'smooth'
            });
        }

        // æ˜¾ç¤ºæç¤º
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // HTML è½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', init);
        
        // é˜²æ­¢æ„å¤–å…³é—­
        window.onbeforeunload = (e) => {
            if (isRecording || transcriptSegments.length > 0) {
                e.preventDefault();
                e.returnValue = '';
            }
        };
    </script>
</body>
</html>
