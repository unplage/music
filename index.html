<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è°æ˜¯å§åº•PRO MAX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            position: fixed;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        .uniform-card {
            background: linear-gradient(135deg, #3b82f6 0%, #6366f1 50%, #8b5cf6 100%) !important;
        }
        
        .card-container {
            perspective: 1000px;
            transform-style: preserve-3d;
            width: 100%;
            height: 100%;
        }
        
        .game-card {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .game-card.flipped {
            transform: rotateY(180deg);
        }
        
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            padding: 2rem;
        }
        
        .card-front {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 2px solid rgba(255,255,255,0.1);
            z-index: 2;
        }
        
        .card-back {
            background: linear-gradient(135deg, #3b82f6 0%, #6366f1 50%, #8b5cf6 100%);
            transform: rotateY(180deg);
            border: 2px solid rgba(255,255,255,0.2);
        }
        
        .privacy-shield {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s;
            cursor: pointer;
        }
        
        .privacy-shield.hidden {
            display: none;
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .btn-press:active {
            transform: scale(0.95);
            opacity: 0.9;
        }
        
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .roulette-container {
            position: relative;
            width: 280px;
            height: 280px;
            margin: 0 auto;
        }
        
        .roulette-wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }
        
        .roulette-segment {
            position: absolute;
            width: 50%;
            height: 50%;
            transform-origin: right bottom;
            left: 0;
            top: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            text-align: center;
            padding-right: 20%;
            padding-bottom: 20%;
            box-sizing: border-box;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            writing-mode: vertical-rl;
            text-orientation: upright;
            letter-spacing: 2px;
        }
        
        .roulette-pointer {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 40px solid #ef4444;
            z-index: 10;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
        }
        
        .speech-bubble {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .screen {
            display: none;
            height: 100%;
            overflow-y: auto;
        }
        .screen.active {
            display: block;
        }
    </style>
</head>
<body class="antialiased">

<div id="app" class="h-full flex flex-col relative bg-slate-900">
    
    <!-- éšç§é®ç½©å±‚ -->
    <div id="privacyShield" class="privacy-shield" onclick="hidePrivacyShield()">
        <div class="text-6xl mb-4 animate-pulse">ğŸ‘†</div>
        <div class="text-2xl font-bold mb-2">PRIVATE MODE</div>
        <div class="text-gray-400 text-sm mb-8">ç‚¹å‡»ç¡®è®¤åªæœ‰ä½ ä¸€äººè§‚çœ‹</div>
        <div class="text-xs text-gray-600 bg-gray-900 px-4 py-2 rounded-full">é˜²çª¥å±ä¿æŠ¤ä¸­</div>
    </div>

    <!-- é¡¶éƒ¨æ  -->
    <header class="glass-panel sticky top-0 z-40 px-4 py-3 flex items-center justify-between border-b border-white/10 shrink-0 h-16">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-xl shadow-lg">
                ğŸ­
            </div>
            <div>
                <h1 class="font-bold text-lg leading-tight">å§åº•<span class="text-blue-400">PRO</span><span class="text-purple-400 text-xs">MAX</span></h1>
                <p class="text-xs text-gray-400" id="gameStatus">å‡†å¤‡å¼€å§‹</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleSound()" id="soundBtn" class="p-2 rounded-lg hover:bg-white/10 text-gray-400 transition-colors text-lg">
                ğŸ”Š
            </button>
            <button onclick="showMenu()" class="p-2 rounded-lg hover:bg-white/10 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
            </button>
        </div>
    </header>

    <main id="mainContent" class="flex-1 overflow-hidden relative">
        
        <!-- é¦–é¡µ -->
        <div id="homeScreen" class="screen active h-full p-4 pb-24 overflow-y-auto hide-scrollbar">
            <div class="max-w-md mx-auto h-full flex flex-col justify-center space-y-6">
                <div class="text-center space-y-4 mb-8">
                    <div class="text-7xl mb-4 animate-float inline-block">ğŸ•µï¸</div>
                    <h2 class="text-4xl font-black bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">è°æ˜¯å§åº•</h2>
                    <p class="text-gray-400 text-sm">é˜²çª¥å± Â· æƒ©ç½šè½¬ç›˜ Â· æ™ºèƒ½è¯åº“</p>
                </div>

                <div class="space-y-3">
                    <button onclick="showSetup()" class="w-full py-4 rounded-2xl bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 font-bold text-lg shadow-xl shadow-blue-500/25 btn-press transition-all flex items-center justify-center gap-2">
                        <span>ğŸš€</span> å¼€å§‹æ¸¸æˆ
                    </button>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="showWordBank()" class="py-3 rounded-2xl glass-panel hover:bg-white/10 font-medium text-gray-300 transition-all btn-press flex items-center justify-center gap-2">
                            <span>ğŸ“š</span> è¯åº“
                        </button>
                        <button onclick="showPunishmentWheel()" class="py-3 rounded-2xl glass-panel hover:bg-white/10 font-medium text-gray-300 transition-all btn-press flex items-center justify-center gap-2">
                            <span>ğŸ¯</span> æƒ©ç½š
                        </button>
                    </div>
                    <button onclick="showHistory()" class="w-full py-3 rounded-2xl glass-panel hover:bg-white/10 font-medium text-gray-300 transition-all btn-press flex items-center justify-center gap-2">
                        <span>ğŸ“Š</span> å†å²è®°å½•
                    </button>
                </div>

                <div class="grid grid-cols-3 gap-3 text-center mt-8">
                    <div class="glass-panel rounded-xl p-3">
                        <div class="text-2xl font-bold text-blue-400" id="totalGames">0</div>
                        <div class="text-xs text-gray-500">æ€»åœºæ¬¡</div>
                    </div>
                    <div class="glass-panel rounded-xl p-3">
                        <div class="text-2xl font-bold text-purple-400" id="wordCount">47</div>
                        <div class="text-xs text-gray-500">è¯åº“æ•°é‡</div>
                    </div>
                    <div class="glass-panel rounded-xl p-3">
                        <div class="text-2xl font-bold text-pink-400" id="punishCount">20</div>
                        <div class="text-xs text-gray-500">æƒ©ç½šé¡¹ç›®</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- è®¾ç½®é¡µé¢ -->
        <div id="setupScreen" class="screen h-full p-4 pb-24 overflow-y-auto hide-scrollbar">
            <div class="max-w-md mx-auto space-y-6 py-4">
                <div class="flex items-center gap-4 mb-6">
                    <button onclick="showScreen('homeScreen')" class="p-2 rounded-lg hover:bg-white/10">â†</button>
                    <h2 class="text-2xl font-bold">æ¸¸æˆè®¾ç½®</h2>
                </div>
                
                <div class="glass-panel rounded-2xl p-5 space-y-6">
                    <div>
                        <label class="flex justify-between text-sm font-medium mb-2 text-gray-300">
                            <span>ç©å®¶äººæ•°</span>
                            <span class="text-blue-400 font-bold" id="playerCountDisplay">6äºº</span>
                        </label>
                        <input type="range" id="playerCount" min="4" max="16" value="6" 
                               class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-500"
                               oninput="updateSetup()">
                    </div>

                    <div>
                        <label class="flex justify-between text-sm font-medium mb-2 text-gray-300">
                            <span>å§åº•æ•°é‡</span>
                            <span class="text-purple-400 font-bold" id="undercoverCountDisplay">1äºº</span>
                        </label>
                        <input type="range" id="undercoverCount" min="1" max="4" value="1" 
                               class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-purple-500"
                               oninput="updateSetup()">
                    </div>

                    <div class="flex items-center justify-between py-2 border-t border-white/10">
                        <div>
                            <div class="font-medium text-gray-200">å¯ç”¨ç™½æ¿</div>
                            <div class="text-xs text-gray-500">ç™½æ¿çŒœå¯¹åŒè¯å³è·èƒœ</div>
                        </div>
                        <button id="blankToggle" onclick="toggleBlank()" class="w-14 h-8 rounded-full bg-gray-700 relative transition-colors duration-300">
                            <div class="w-6 h-6 bg-white rounded-full absolute top-1 left-1 transition-transform duration-300 shadow-md"></div>
                        </button>
                    </div>

                    <div class="flex items-center justify-between py-2 border-t border-white/10">
                        <div>
                            <div class="font-medium text-gray-200">å‘è¨€è®¡æ—¶</div>
                            <div class="text-xs text-gray-500">æ¯äººé™æ—¶60ç§’</div>
                        </div>
                        <button id="timerToggle" onclick="toggleTimer()" class="w-14 h-8 rounded-full bg-blue-600 relative transition-colors duration-300">
                            <div class="w-6 h-6 bg-white rounded-full absolute top-1 left-1 transition-transform duration-300 shadow-md transform translate-x-6"></div>
                        </button>
                    </div>
                </div>

                <div class="glass-panel rounded-2xl p-4">
                    <h3 class="font-bold mb-3 text-sm text-gray-300">è§’è‰²åˆ†é…é¢„è§ˆ</h3>
                    <div class="flex gap-2 flex-wrap justify-center" id="rolePreview"></div>
                    <div class="text-center text-xs text-gray-500 mt-2" id="roleSummary">5å¹³æ°‘ vs 1å§åº•</div>
                </div>

                <!-- å…³é”®ä¿®å¤ï¼šonclickè°ƒç”¨æ­£ç¡®çš„å‡½æ•°å -->
                <button onclick="startDealing()" class="w-full py-4 rounded-2xl bg-gradient-to-r from-green-600 to-emerald-600 font-bold text-lg shadow-xl btn-press transition-all flex items-center justify-center gap-2">
                    <span>ğŸ²</span> å¼€å§‹å‘ç‰Œ
                </button>
            </div>
        </div>

        <!-- å‘ç‰Œé¡µé¢ -->
        <div id="dealingScreen" class="screen h-full p-4 pb-24 overflow-hidden flex flex-col">
            <div class="max-w-md mx-auto w-full h-full flex flex-col">
                <div class="text-center mb-4 shrink-0">
                    <div class="text-sm text-gray-400 mb-1">å½“å‰ç©å®¶</div>
                    <div class="text-3xl font-black text-white" id="currentPlayerName">ç©å®¶ 1</div>
                    <div class="text-xs text-gray-500 mt-1">ç‚¹å‡»å¡ç‰‡ â†’ æŸ¥çœ‹ â†’ ç¡®è®¤ä¼ é€’</div>
                </div>

                <div class="flex-1 flex items-center justify-center min-h-0 py-4">
                    <div class="w-full max-w-sm h-full max-h-[500px] relative card-container">
                        <div id="identityCard" class="game-card w-full h-full cursor-pointer" onclick="flipCard(this)">
                            <!-- æ­£é¢ -->
                            <div class="card-face card-front">
                                <div class="w-24 h-24 rounded-full bg-white/10 flex items-center justify-center text-5xl mb-6 backdrop-blur-sm border-2 border-white/20 animate-pulse">
                                    ğŸ´
                                </div>
                                <div class="text-2xl font-bold text-white mb-2">ç‚¹å‡»ç¿»å¼€</div>
                                <div class="text-sm text-gray-400 mb-8">æŸ¥çœ‹ä½ çš„èº«ä»½ç‰Œ</div>
                                <div class="text-xs text-gray-600 text-center leading-relaxed px-4">
                                    è¯·ç¡®ä¿å‘¨å›´æ— äººçª¥å±<br>
                                    åªæœ‰ä½ èƒ½çœ‹åˆ°å†…å®¹
                                </div>
                            </div>
                            
                            <!-- èƒŒé¢ï¼šç»Ÿä¸€è“ç´«è‰² -->
                            <div class="card-face card-back uniform-card">
                                <div class="w-16 h-16 rounded-full bg-white/20 flex items-center justify-center text-3xl mb-4 backdrop-blur-sm border-2 border-white/30 shadow-inner" id="roleIcon">
                                    ğŸ‘¥
                                </div>
                                <div class="text-xs text-white/80 mb-1 uppercase tracking-widest">ä½ çš„èº«ä»½</div>
                                <div class="text-3xl font-black text-white mb-6 drop-shadow-lg" id="roleTitle">å¹³æ°‘</div>
                                
                                <div class="bg-black/20 rounded-2xl p-4 w-full backdrop-blur-sm border border-white/10 mb-4">
                                    <div class="text-xs text-white/60 mb-1 uppercase tracking-wider">æç¤ºè¯</div>
                                    <div class="text-4xl font-bold text-white tracking-wider" id="roleWord">è‹¹æœ</div>
                                    <div class="text-xs text-white/70 mt-2 font-medium" id="wordHint">è¯·è®°ä½è¿™ä¸ªè¯</div>
                                </div>
                                
                                <div class="text-xs text-white/80 text-center leading-relaxed px-2" id="roleHint">
                                    æè¿°è¿™ä¸ªè¯ï¼Œä½†ä¸è¦ç›´æ¥è¯´å‡ºæ¥
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-3 shrink-0">
                    <button id="nextPlayerBtn" onclick="nextPlayer()" class="hidden w-full py-4 rounded-2xl bg-blue-600 hover:bg-blue-500 font-bold text-lg shadow-xl btn-press transition-all flex items-center justify-center gap-2">
                        <span>ç¡®è®¤å¹¶ä¼ é€’ç»™ä¸‹ä¸€ä½</span>
                        <span>â†’</span>
                    </button>
                    
                    <button id="startGameBtn" onclick="startPlaying()" class="hidden w-full py-4 rounded-2xl bg-gradient-to-r from-green-600 to-emerald-600 font-bold text-lg shadow-xl btn-press transition-all animate-pulse flex items-center justify-center gap-2">
                        <span>ğŸ®</span> æ‰€æœ‰äººå°±ç»ªï¼Œå¼€å§‹æ¸¸æˆï¼
                    </button>
                    
                    <div class="text-center text-sm text-gray-500 font-mono" id="dealingProgress">
                        ç¬¬ 1 / 6 ä½ç©å®¶
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¸¸æˆè¿›è¡Œé¡µé¢ -->
        <div id="gameScreen" class="screen h-full p-4 pb-32 overflow-y-auto hide-scrollbar">
            <div class="max-w-2xl mx-auto space-y-4">
                <div class="glass-panel rounded-2xl p-4 flex items-center justify-between sticky top-0 z-10">
                    <div>
                        <div class="text-xs text-gray-400 mb-1">ç¬¬ <span id="roundNumber" class="text-white font-bold text-lg">1</span> è½®</div>
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                            <span class="text-sm font-bold" id="phaseText">å‘è¨€é˜¶æ®µ</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="text-right hidden sm:block">
                            <div class="text-xs text-gray-400">å½“å‰å‘è¨€</div>
                            <div class="font-bold" id="speakerName">ç©å®¶1</div>
                        </div>
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-lg font-bold shadow-lg" id="speakerAvatar">1</div>
                    </div>
                </div>

                <div id="timerSection" class="glass-panel rounded-2xl p-4">
                    <div class="flex justify-between text-xs text-gray-400 mb-2">
                        <span>å‰©ä½™æ—¶é—´</span>
                        <span id="timerText" class="text-xl font-bold text-white font-mono">60</span>
                    </div>
                    <div class="h-3 bg-gray-700 rounded-full overflow-hidden relative">
                        <div id="timerBar" class="h-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-1000 w-full"></div>
                    </div>
                </div>

                <div id="blankGuessSection" class="hidden glass-panel rounded-2xl p-4 border-2 border-purple-500/50 bg-purple-500/10">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-bold text-purple-300 text-lg">ä½ æ˜¯ç™½æ¿ï¼</div>
                            <div class="text-xs text-gray-400">å¬å–æè¿°åçŒœä¸¤ä¸ªè¯</div>
                        </div>
                        <button onclick="showBlankGuess()" class="px-6 py-3 rounded-xl bg-purple-600 hover:bg-purple-500 text-white font-bold transition-colors shadow-lg btn-press">
                            çŒœè¯
                        </button>
                    </div>
                </div>

                <div class="glass-panel rounded-2xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-sm text-gray-300">ğŸ“ å‘è¨€è®°å½•æ¿</h3>
                        <button onclick="clearRecords()" class="text-xs text-gray-500 hover:text-white btn-press">æ¸…ç©º</button>
                    </div>
                    <div id="speechRecords" class="space-y-2 max-h-32 overflow-y-auto hide-scrollbar">
                        <div class="text-center text-sm text-gray-500 py-4">æš‚æ— è®°å½•ï¼Œç‚¹å‡»ä¸‹æ–¹æ·»åŠ </div>
                    </div>
                    <button onclick="addRecord()" class="w-full mt-3 py-3 rounded-xl bg-white/5 hover:bg-white/10 text-sm text-gray-400 transition-colors border border-dashed border-white/20 btn-press">
                        + è®°å½•å½“å‰å‘è¨€è¦ç‚¹
                    </button>
                </div>

                <div class="glass-panel rounded-2xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-bold text-sm text-gray-300">ç©å®¶çŠ¶æ€</h3>
                        <span class="text-xs text-gray-500" id="aliveCount">å­˜æ´» 6/6</span>
                    </div>
                    <div class="grid grid-cols-4 sm:grid-cols-6 gap-3" id="playerGrid"></div>
                </div>
            </div>
        </div>

        <!-- æŠ•ç¥¨é¡µé¢ -->
        <div id="voteScreen" class="screen h-full p-4 pb-24 overflow-y-auto hide-scrollbar">
            <div class="max-w-md mx-auto py-4">
                <div class="text-center py-4 mb-6">
                    <h2 class="text-3xl font-black mb-2 text-red-400">æŠ•ç¥¨æ—¶åˆ»</h2>
                    <p class="text-gray-400 text-sm">é€‰å‡ºæœ€åƒå§åº•çš„äºº</p>
                </div>
                <div id="voteGrid" class="grid grid-cols-2 gap-3"></div>
            </div>
        </div>

        <!-- ç»“æœé¡µé¢ -->
        <div id="resultScreen" class="screen h-full p-4 pb-24 overflow-y-auto hide-scrollbar">
            <div class="max-w-md mx-auto py-8 text-center space-y-6">
                <div class="text-6xl mb-4 animate-bounce" id="resultEmoji">ğŸ‰</div>
                <h2 class="text-4xl font-black mb-2" id="resultTitle">å¹³æ°‘èƒœåˆ©ï¼</h2>
                <p class="text-gray-400" id="resultDesc"></p>

                <div class="glass-panel rounded-2xl p-6 space-y-3 text-left max-h-64 overflow-y-auto hide-scrollbar">
                    <h3 class="font-bold text-lg mb-4 text-center border-b border-white/10 pb-2">èº«ä»½æ­æ™“</h3>
                    <div id="resultList" class="space-y-2"></div>
                </div>

                <div class="glass-panel rounded-2xl p-4 bg-gradient-to-r from-blue-500/20 to-purple-500/20 border border-white/20">
                    <div class="text-sm text-gray-400 mb-1">æœ¬å±€è¯è¯­</div>
                    <div class="flex items-center justify-center gap-4 text-lg font-bold flex-wrap">
                        <div class="text-green-400">ã€Œ<span id="resultCivilianWord">?</span>ã€</div>
                        <span class="text-gray-600">vs</span>
                        <div class="text-red-400">ã€Œ<span id="resultUndercoverWord">?</span>ã€</div>
                    </div>
                </div>

                <div class="space-y-3">
                    <button onclick="showPunishmentWheel()" class="w-full py-4 rounded-2xl bg-gradient-to-r from-pink-600 to-rose-600 font-bold text-lg shadow-xl btn-press">
                        <span>ğŸ¯</span> æƒ©ç½šè½¬ç›˜
                    </button>
                    <button onclick="location.reload()" class="w-full py-3 rounded-2xl glass-panel hover:bg-white/10 font-bold btn-press">
                        å†æ¥ä¸€å±€ â†º
                    </button>
                </div>
            </div>
        </div>

        <!-- è¯åº“é¡µé¢ -->
        <div id="wordBankScreen" class="screen h-full p-4 pb-24 overflow-y-auto hide-scrollbar">
            <div class="max-w-md mx-auto py-4">
                <div class="flex items-center justify-between mb-4">
                    <button onclick="showScreen('homeScreen')" class="p-2 rounded-lg hover:bg-white/10">â†</button>
                    <h2 class="text-xl font-bold">è¯åº“ç®¡ç†</h2>
                    <button onclick="showAddWord()" class="px-4 py-2 rounded-lg bg-blue-600 text-sm font-bold btn-press">+ æ·»åŠ </button>
                </div>
                <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-2 mb-4" id="categoryTabs">
                    <button class="px-4 py-2 rounded-full bg-blue-600 text-sm font-bold whitespace-nowrap" onclick="filterWords('all', this)">å…¨éƒ¨</button>
                    <button class="px-4 py-2 rounded-full bg-white/10 text-sm whitespace-nowrap" onclick="filterWords('food', this)">ç¾é£Ÿ</button>
                    <button class="px-4 py-2 rounded-full bg-white/10 text-sm whitespace-nowrap" onclick="filterWords('daily', this)">ç”Ÿæ´»</button>
                    <button class="px-4 py-2 rounded-full bg-white/10 text-sm whitespace-nowrap" onclick="filterWords('ent', this)">å¨±ä¹</button>
                    <button class="px-4 py-2 rounded-full bg-white/10 text-sm whitespace-nowrap" onclick="filterWords('custom', this)">è‡ªå®šä¹‰</button>
                </div>
                <div id="wordList" class="space-y-2"></div>
            </div>
        </div>

        <!-- æƒ©ç½šè½¬ç›˜é¡µé¢ -->
        <div id="wheelScreen" class="screen h-full p-4 pb-24 overflow-y-auto hide-scrollbar">
            <div class="max-w-md mx-auto py-4 h-full flex flex-col">
                <div class="flex items-center justify-between mb-4">
                    <button onclick="showScreen('homeScreen')" class="p-2 rounded-lg hover:bg-white/10">â†</button>
                    <h2 class="text-xl font-bold">æƒ©ç½šè½¬ç›˜</h2>
                    <button onclick="editPunishments()" class="text-sm text-blue-400 btn-press">ç¼–è¾‘</button>
                </div>
                <div class="flex-1 flex flex-col items-center justify-center min-h-0 py-8">
                    <div class="roulette-container mb-8 shrink-0">
                        <div class="roulette-pointer"></div>
                        <div id="rouletteWheel" class="roulette-wheel"></div>
                    </div>
                    <button onclick="spinWheel()" class="px-8 py-4 rounded-full bg-gradient-to-r from-red-600 to-pink-600 font-bold text-xl shadow-xl btn-press animate-pulse shrink-0">
                        å¼€å§‹æ—‹è½¬ï¼
                    </button>
                    <div id="punishmentResult" class="mt-8 text-center hidden w-full px-4">
                        <div class="text-sm text-gray-400 mb-2">æƒ©ç½šç»“æœ</div>
                        <div class="text-2xl font-bold text-red-400 px-6 py-4 bg-red-500/10 rounded-xl border border-red-500/30 break-words" id="punishmentText">--</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å†å²è®°å½•é¡µé¢ -->
        <div id="historyScreen" class="screen h-full p-4 pb-24 overflow-y-auto hide-scrollbar">
            <div class="max-w-md mx-auto py-4">
                <div class="flex items-center gap-4 mb-6">
                    <button onclick="showScreen('homeScreen')" class="p-2 rounded-lg hover:bg-white/10">â†</button>
                    <h2 class="text-xl font-bold">å†å²è®°å½•</h2>
                </div>
                <div id="historyList" class="space-y-3"></div>
            </div>
        </div>

    </main>

    <!-- åº•éƒ¨æ“ä½œæ ï¼ˆæ¸¸æˆæ—¶æ˜¾ç¤ºï¼‰ -->
    <div id="gameControls" class="fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-slate-900 via-slate-900/95 to-transparent z-50 hidden">
        <div class="max-w-md mx-auto space-y-2">
            <button id="nextBtn" onclick="nextSpeaker()" class="w-full py-4 rounded-2xl bg-gradient-to-r from-blue-600 to-purple-600 font-bold text-lg shadow-xl btn-press transition-all flex items-center justify-center gap-2">
                <span>ä¸‹ä¸€ä½å‘è¨€</span>
                <span>â†’</span>
            </button>
            <div class="flex gap-2">
                <button onclick="startVoting()" class="flex-1 py-3 rounded-xl bg-gradient-to-r from-orange-600 to-red-600 font-bold text-sm shadow-lg btn-press">
                    å‘èµ·æŠ•ç¥¨
                </button>
                <button onclick="toggleNightMode()" class="px-4 py-3 rounded-xl glass-panel hover:bg-white/10 font-bold text-sm btn-press">
                    ğŸŒ™
                </button>
            </div>
        </div>
    </div>

</div>

<!-- æ¨¡æ€æ¡† -->
<div id="addWordModal" class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="glass-panel rounded-2xl p-6 w-full max-w-md space-y-4">
        <h3 class="text-xl font-bold">æ·»åŠ è‡ªå®šä¹‰è¯è¯­</h3>
        <div class="space-y-3">
            <input type="text" id="newCivilianWord" placeholder="å¹³æ°‘è¯ï¼ˆå¦‚ï¼šè‹¹æœï¼‰" class="w-full bg-white/10 border border-white/20 rounded-xl p-3 text-white placeholder-gray-500 focus:outline-none focus:border-blue-500">
            <input type="text" id="newUndercoverWord" placeholder="å§åº•è¯ï¼ˆå¦‚ï¼šæ¢¨å­ï¼‰" class="w-full bg-white/10 border border-white/20 rounded-xl p-3 text-white placeholder-gray-500 focus:outline-none focus:border-purple-500">
        </div>
        <div class="flex gap-3 mt-6">
            <button onclick="closeAddWord()" class="flex-1 py-3 rounded-xl bg-gray-700 font-bold btn-press">å–æ¶ˆ</button>
            <button onclick="confirmAddWord()" class="flex-1 py-3 rounded-xl bg-blue-600 font-bold btn-press">æ·»åŠ </button>
        </div>
    </div>
</div>

<div id="recordModal" class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="glass-panel rounded-2xl p-6 w-full max-w-md space-y-4">
        <h3 class="text-lg font-bold">è®°å½•å‘è¨€</h3>
        <textarea id="recordContent" rows="3" placeholder="è®°å½•å…³é”®çº¿ç´¢..." class="w-full bg-white/10 border border-white/20 rounded-xl p-3 text-white resize-none focus:outline-none focus:border-blue-500"></textarea>
        <div class="flex gap-3">
            <button onclick="closeRecord()" class="flex-1 py-3 rounded-xl bg-gray-700 font-bold btn-press">å–æ¶ˆ</button>
            <button onclick="saveRecord()" class="flex-1 py-3 rounded-xl bg-blue-600 font-bold btn-press">ä¿å­˜</button>
        </div>
    </div>
</div>

<div id="blankGuessModal" class="hidden fixed inset-0 z-50 bg-black/90 backdrop-blur-md flex items-center justify-center p-4">
    <div class="glass-panel rounded-2xl p-6 w-full max-w-md space-y-4 border-2 border-purple-500/50">
        <h3 class="text-xl font-bold text-purple-400">ç™½æ¿çŒœè¯</h3>
        <p class="text-sm text-gray-400">çŒœå¯¹ä¸¤ä¸ªè¯å³å¯è·èƒœ</p>
        <div class="space-y-3">
            <input type="text" id="guessWord1" placeholder="ç¬¬ä¸€ä¸ªè¯" class="w-full bg-purple-500/10 border border-purple-500/30 rounded-xl p-3 text-white focus:outline-none focus:border-purple-500">
            <input type="text" id="guessWord2" placeholder="ç¬¬äºŒä¸ªè¯" class="w-full bg-purple-500/10 border border-purple-500/30 rounded-xl p-3 text-white focus:outline-none focus:border-purple-500">
        </div>
        <div class="flex gap-3">
            <button onclick="closeBlankGuess()" class="flex-1 py-3 rounded-xl bg-gray-700 font-bold btn-press">å–æ¶ˆ</button>
            <button onclick="confirmBlankGuess()" class="flex-1 py-3 rounded-xl bg-purple-600 font-bold btn-press">æäº¤</button>
        </div>
    </div>
</div>

<script>
// ============ æ•°æ® ============
const wordBank = {
    food: [
        {c:"è‹¹æœ",u:"æ¢¨å­"},{c:"éº¦å½“åŠ³",u:"è‚¯å¾·åŸº"},{c:"ç«é”…",u:"çƒ§çƒ¤"},{c:"å’–å•¡",u:"å¥¶èŒ¶"},
        {c:"è›‹ç³•",u:"é¢åŒ…"},{c:"æ³¡é¢",u:"èºè›³ç²‰"},{c:"é¥ºå­",u:"é¦„é¥¨"},{c:"é¢æ¡",u:"ç±³ç²‰"},
        {c:"å†°æ·‡æ·‹",u:"é›ªç³•"},{c:"è±†æµ†",u:"ç‰›å¥¶"},{c:"å·§å…‹åŠ›",u:"ç³–æœ"},{c:"æ±‰å ¡",u:"ä¸‰æ˜æ²»"}
    ],
    daily: [
        {c:"åœ°é“",u:"å…¬äº¤è½¦"},{c:"å¾®ä¿¡",u:"QQ"},{c:"å£çº¢",u:"å”‡è†"},{c:"æ¯›è¡£",u:"å«è¡£"},
        {c:"çœ¼é•œ",u:"å¢¨é•œ"},{c:"æ‰‹æœº",u:"å¹³æ¿"},{c:"æ´—å‘æ°´",u:"æ²æµ´éœ²"},{c:"ç‰™è†",u:"æ´—é¢å¥¶"},
        {c:"é›¨ä¼",u:"é®é˜³ä¼"},{c:"æ‰‹è¡¨",u:"æ‰‹ç¯"},{c:"é’±åŒ…",u:"å¡åŒ…"},{c:"æ‹–é‹",u:"å‡‰é‹"},
        {c:"æ•å¤´",u:"é å«"},{c:"æ¯›å·¾",u:"æµ´å·¾"},{c:"é•œå­",u:"ç»ç’ƒ"}
    ],
    ent: [
        {c:"ç‹è€…è£è€€",u:"è‹±é›„è”ç›Ÿ"},{c:"æŠ–éŸ³",u:"å¿«æ‰‹"},{c:"ç”µå½±",u:"ç”µè§†å‰§"},{c:"å°è¯´",u:"æ¼«ç”»"},
        {c:"æ¼”å”±ä¼š",u:"éŸ³ä¹èŠ‚"},{c:"å¯†å®¤é€ƒè„±",u:"å‰§æœ¬æ€"},{c:"éº»å°†",u:"æ‰‘å…‹"},{c:"KTV",u:"é…’å§"},
        {c:"ç¯®çƒ",u:"è¶³çƒ"},{c:"å‰ä»–",u:"å°¤å…‹é‡Œé‡Œ"},{c:"çŒ«",u:"ç‹—"},{c:"å¤ªé˜³",u:"æœˆäº®"},
        {c:"çˆ¬å±±",u:"æ¸¸æ³³"},{c:"ç”»ç”»",u:"ä¹¦æ³•"},{c:"é’¢ç´",u:"å°æç´"}
    ],
    custom: []
};

if(localStorage.getItem('customWords')) {
    wordBank.custom = JSON.parse(localStorage.getItem('customWords'));
}

let punishments = ["å”±ä¸€é¦–æƒ…æ­Œ","å­¦ä¸‰ç§åŠ¨ç‰©å«","åš10ä¸ªä¿¯å§æ’‘","è®²ä¸€ä¸ªå†·ç¬‘è¯","æ¨¡ä»¿ä¸€ä½æ˜æ˜Ÿ",
    "è¯´å‡ºä¸‰ä¸ªç§˜å¯†","ç»™é€šè®¯å½•ç¬¬3ä½å‘è¯­éŸ³","åŸåœ°è½¬5åœˆ","ç”¨å±è‚¡å†™å­—","è¡¨ç™½å¢™å£10ç§’",
    "å–ä¸€å£é†‹","åšé¬¼è„¸30ç§’","èƒŒä¸€é¦–å¤è¯—","è·³ä¸€æ®µèˆ","å¤§å£°å–Š'æˆ‘æ˜¯çŒª'ä¸‰æ¬¡",
    "åƒä¸€å£æŸ æª¬","è’™çœ¼è¸æ­¥20ç§’","ä¸å·¦è¾¹çš„äººå¯¹è§†10ç§’","å­¦æ¯é¸¡ä¸‹è›‹","èµç¾è‡ªå·±ä¸€åˆ†é’Ÿ"];
if(localStorage.getItem('punishments')) {
    punishments = JSON.parse(localStorage.getItem('punishments'));
}

// ============ æ¸¸æˆçŠ¶æ€ ============
let gameState = {
    phase:'home',
    players:[],
    currentPlayerIndex:0,
    round:1,
    words:{},
    useBlank:false,
    useTimer:true,
    timer:null,
    votes:{},
    eliminated:[],
    speechRecords:[],
    soundEnabled:true,
    nightMode:false
};

// ============ åˆå§‹åŒ– ============
document.addEventListener('DOMContentLoaded', () => {
    updateWordCount();
    document.getElementById('totalGames').textContent = localStorage.getItem('totalGames') || '0';
    updateSetup();
    
    // ç¡®ä¿æ‰€æœ‰å±å¹•éšè—ï¼Œåªæ˜¾ç¤ºé¦–é¡µ
    showScreen('homeScreen');
});

// ============ æ ¸å¿ƒå¯¼èˆª ============
function showScreen(screenId) {
    // éšè—æ‰€æœ‰å±å¹•
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    // æ˜¾ç¤ºç›®æ ‡å±å¹•
    const target = document.getElementById(screenId);
    if(target) target.classList.add('active');
    
    // æ§åˆ¶åº•éƒ¨æ æ˜¾ç¤º
    const gameControls = document.getElementById('gameControls');
    if(screenId === 'gameScreen') {
        gameControls.classList.remove('hidden');
    } else {
        gameControls.classList.add('hidden');
    }
    
    // æ›´æ–°æ¸¸æˆçŠ¶æ€
    if(screenId === 'homeScreen') gameState.phase = 'home';
    else if(screenId === 'setupScreen') gameState.phase = 'setup';
    else if(screenId === 'dealingScreen') gameState.phase = 'dealing';
    else if(screenId === 'gameScreen') gameState.phase = 'playing';
    else if(screenId === 'voteScreen') gameState.phase = 'voting';
    else if(screenId === 'resultScreen') gameState.phase = 'result';
}

// ============ é¦–é¡µåŠŸèƒ½ ============
function showSetup() {
    showScreen('setupScreen');
}

function toggleSound() {
    gameState.soundEnabled = !gameState.soundEnabled;
    document.getElementById('soundBtn').textContent = gameState.soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
}

function updateWordCount() {
    const total = wordBank.food.length + wordBank.daily.length + wordBank.ent.length + wordBank.custom.length;
    document.getElementById('wordCount').textContent = total;
    document.getElementById('punishCount').textContent = punishments.length;
}

// ============ è®¾ç½®é¡µé¢ ============
function updateSetup() {
    const pc = parseInt(document.getElementById('playerCount').value);
    const uc = parseInt(document.getElementById('undercoverCount').value);
    
    document.getElementById('playerCountDisplay').textContent = pc + 'äºº';
    document.getElementById('undercoverCountDisplay').textContent = uc + 'äºº';
    
    // é™åˆ¶å§åº•æ•°é‡
    const maxU = Math.floor((pc - (gameState.useBlank ? 1 : 0)) / 2);
    if(uc > maxU) {
        document.getElementById('undercoverCount').value = maxU;
    }
    
    const actualUC = parseInt(document.getElementById('undercoverCount').value);
    const cc = pc - actualUC - (gameState.useBlank ? 1 : 0);
    document.getElementById('roleSummary').textContent = `${cc}å¹³æ°‘ vs ${actualUC}å§åº•${gameState.useBlank ? ' vs 1ç™½æ¿' : ''}`;
    
    const preview = document.getElementById('rolePreview');
    preview.innerHTML = '';
    for(let i = 0; i < cc; i++) preview.innerHTML += `<span class="px-2 py-1 rounded bg-blue-500/20 text-blue-400 text-xs border border-blue-500/30">å¹³</span>`;
    for(let i = 0; i < actualUC; i++) preview.innerHTML += `<span class="px-2 py-1 rounded bg-purple-500/20 text-purple-400 text-xs border border-purple-500/30">å§</span>`;
    if(gameState.useBlank) preview.innerHTML += `<span class="px-2 py-1 rounded bg-gray-500/20 text-gray-400 text-xs border border-gray-500/30">ç™½</span>`;
}

function toggleBlank() {
    gameState.useBlank = !gameState.useBlank;
    const btn = document.getElementById('blankToggle');
    const dot = btn.querySelector('div');
    
    if(gameState.useBlank) {
        btn.classList.remove('bg-gray-700');
        btn.classList.add('bg-purple-600');
        dot.style.transform = 'translateX(24px)';
    } else {
        btn.classList.add('bg-gray-700');
        btn.classList.remove('bg-purple-600');
        dot.style.transform = 'translateX(0)';
    }
    updateSetup();
}

function toggleTimer() {
    gameState.useTimer = !gameState.useTimer;
    const btn = document.getElementById('timerToggle');
    const dot = btn.querySelector('div');
    
    if(gameState.useTimer) {
        btn.classList.remove('bg-gray-700');
        btn.classList.add('bg-blue-600');
        dot.style.transform = 'translateX(24px)';
    } else {
        btn.classList.add('bg-gray-700');
        btn.classList.remove('bg-blue-600');
        dot.style.transform = 'translateX(0)';
    }
}

// ============ å‘ç‰Œç³»ç»Ÿï¼ˆå…³é”®ä¿®å¤ï¼‰ ============
function startDealing() {
    const pc = parseInt(document.getElementById('playerCount').value);
    const uc = parseInt(document.getElementById('undercoverCount').value);
    
    // åˆå§‹åŒ–ç©å®¶
    gameState.players = [];
    for(let i = 1; i <= pc; i++) {
        gameState.players.push({
            id: i,
            name: `ç©å®¶${i}`,
            role: 'civilian',
            word: '',
            alive: true
        });
    }
    
    // åˆ†é…è§’è‰²
    const roles = [];
    for(let i = 0; i < pc - uc - (gameState.useBlank ? 1 : 0); i++) roles.push('civilian');
    for(let i = 0; i < uc; i++) roles.push('undercover');
    if(gameState.useBlank) roles.push('blank');
    
    // æ´—ç‰Œ
    for(let i = roles.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [roles[i], roles[j]] = [roles[j], roles[i]];
    }
    
    // é€‰è¯
    const allWords = [...wordBank.food, ...wordBank.daily, ...wordBank.ent, ...wordBank.custom];
    gameState.words = allWords[Math.floor(Math.random() * allWords.length)];
    
    // åˆ†é…è¯è¯­
    gameState.players.forEach((p, i) => {
        p.role = roles[i];
        p.word = p.role === 'civilian' ? gameState.words.civilian : 
                 p.role === 'undercover' ? gameState.words.undercover : null;
    });
    
    // é‡ç½®ç´¢å¼•å¹¶åˆ‡æ¢å±å¹•
    gameState.currentPlayerIndex = 0;
    gameState.speechRecords = [];
    gameState.eliminated = [];
    
    showScreen('dealingScreen');
    
    // å»¶è¿Ÿåˆå§‹åŒ–è§†å›¾ï¼Œç¡®ä¿DOMåˆ‡æ¢å®Œæˆ
    setTimeout(() => {
        updateDealingView();
    }, 100);
}

function updateDealingView() {
    const card = document.getElementById('identityCard');
    card.classList.remove('flipped');
    
    const p = gameState.players[gameState.currentPlayerIndex];
    document.getElementById('currentPlayerName').textContent = p.name;
    document.getElementById('dealingProgress').textContent = `ç¬¬ ${gameState.currentPlayerIndex + 1} / ${gameState.players.length} ä½`;
    
    // æ›´æ–°å¡ç‰‡å†…å®¹ï¼ˆç»Ÿä¸€é¢œè‰²ï¼‰
    document.getElementById('roleIcon').textContent = p.role === 'civilian' ? 'ğŸ‘¥' : p.role === 'undercover' ? 'ğŸ•µï¸' : 'ğŸƒ';
    document.getElementById('roleTitle').textContent = p.role === 'civilian' ? 'å¹³æ°‘' : p.role === 'undercover' ? 'å§åº•' : 'ç™½æ¿';
    document.getElementById('roleWord').textContent = p.word || '?';
    document.getElementById('roleWord').style.opacity = p.word ? '1' : '0.3';
    document.getElementById('wordHint').textContent = p.role === 'blank' ? 'é å¬æè¿°çŒœè¯' : 'è¯·è®°ä½è¿™ä¸ªè¯';
    document.getElementById('roleHint').textContent = p.role === 'undercover' ? 'ä½ çš„è¯å’Œåˆ«äººä¸åŒï¼Œå°å¿ƒéšè—' : 
                                                      p.role === 'blank' ? 'ä½ æ²¡æœ‰è¯ï¼å¬åˆ«äººçš„æè¿°' : 
                                                      'æè¿°è¿™ä¸ªè¯ï¼Œä½†ä¸è¦ç›´æ¥è¯´å‡ºæ¥';
    
    document.getElementById('nextPlayerBtn').classList.add('hidden');
    document.getElementById('startGameBtn').classList.add('hidden');
    
    // æ˜¾ç¤ºéšç§é®ç½©
    document.getElementById('privacyShield').classList.remove('hidden');
}

function hidePrivacyShield() {
    document.getElementById('privacyShield').classList.add('hidden');
}

function flipCard(el) {
    if(el.classList.contains('flipped')) return;
    el.classList.add('flipped');
    if(navigator.vibrate) navigator.vibrate(50);
    
    const isLast = gameState.currentPlayerIndex === gameState.players.length - 1;
    if(isLast) {
        document.getElementById('startGameBtn').classList.remove('hidden');
    } else {
        document.getElementById('nextPlayerBtn').classList.remove('hidden');
    }
}

function nextPlayer() {
    // å…ˆç¿»å›
    document.getElementById('identityCard').classList.remove('flipped');
    document.getElementById('privacyShield').classList.remove('hidden');
    
    setTimeout(() => {
        gameState.currentPlayerIndex++;
        if(gameState.currentPlayerIndex < gameState.players.length) {
            updateDealingView();
        }
    }, 400);
}

function startPlaying() {
    showScreen('gameScreen');
    gameState.phase = 'playing';
    gameState.round = 1;
    gameState.currentPlayerIndex = 0;
    updateGameView();
    if(gameState.useTimer) startTimer(60);
}

// ============ æ¸¸æˆè¿›è¡Œ ============
function updateGameView() {
    const alive = gameState.players.filter(p => p.alive);
    const curr = alive[gameState.currentPlayerIndex % alive.length];
    
    if(!curr) return;
    
    document.getElementById('roundNumber').textContent = gameState.round;
    document.getElementById('speakerName').textContent = curr.name;
    document.getElementById('speakerAvatar').textContent = curr.id;
    document.getElementById('aliveCount').textContent = `å­˜æ´» ${alive.length}/${gameState.players.length}`;
    
    // ç™½æ¿æŒ‰é’®
    document.getElementById('blankGuessSection').classList.toggle('hidden', curr.role !== 'blank');
    
    // ç©å®¶ç½‘æ ¼
    const grid = document.getElementById('playerGrid');
    grid.innerHTML = '';
    gameState.players.forEach(p => {
        if(!p.alive) return;
        const div = document.createElement('div');
        div.className = 'flex flex-col items-center gap-1 p-2 rounded-xl transition-all cursor-pointer hover:bg-white/5';
        div.onclick = () => { if(gameState.phase === 'voting') castVote(p.id); };
        div.innerHTML = `
            <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center font-bold shadow-lg transition-all ${gameState.votes[p.id] ? 'ring-4 ring-yellow-400 scale-110' : ''}">
                ${p.id}
            </div>
            <div class="text-xs text-gray-400 truncate w-full text-center">${p.name}</div>
        `;
        grid.appendChild(div);
    });
    
    updateSpeechRecords();
}

function startTimer(s) {
    if(!gameState.useTimer) {
        document.getElementById('timerSection').classList.add('hidden');
        return;
    }
    document.getElementById('timerSection').classList.remove('hidden');
    
    let r = s;
    const bar = document.getElementById('timerBar');
    const txt = document.getElementById('timerText');
    
    if(gameState.timer) clearInterval(gameState.timer);
    
    bar.style.width = '100%';
    bar.className = 'h-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-1000';
    
    gameState.timer = setInterval(() => {
        r--;
        bar.style.width = (r/s*100) + '%';
        txt.textContent = r;
        
        if(r <= 10) {
            bar.className = 'h-full bg-red-500 transition-all duration-1000';
            if(navigator.vibrate && r % 2 === 0) navigator.vibrate(30);
        }
        if(r <= 0) {
            clearInterval(gameState.timer);
            if(navigator.vibrate) navigator.vibrate([100,50,100]);
        }
    }, 1000);
}

function nextSpeaker() {
    if(gameState.timer) clearInterval(gameState.timer);
    
    const alive = gameState.players.filter(p => p.alive);
    gameState.currentPlayerIndex++;
    
    if(gameState.currentPlayerIndex >= alive.length) {
        gameState.currentPlayerIndex = 0;
        startVoting();
    } else {
        updateGameView();
        if(gameState.useTimer) startTimer(60);
    }
}

// ============ è®°å½•ç³»ç»Ÿ ============
function addRecord() {
    document.getElementById('recordModal').classList.remove('hidden');
    document.getElementById('recordContent').value = '';
    document.getElementById('recordContent').focus();
}

function closeRecord() {
    document.getElementById('recordModal').classList.add('hidden');
}

function saveRecord() {
    const c = document.getElementById('recordContent').value.trim();
    if(!c) return;
    
    gameState.speechRecords.push({
        round: gameState.round,
        speaker: document.getElementById('speakerName').textContent,
        content: c,
        time: new Date().toLocaleTimeString()
    });
    updateSpeechRecords();
    closeRecord();
}

function updateSpeechRecords() {
    const c = document.getElementById('speechRecords');
    if(gameState.speechRecords.length === 0) {
        c.innerHTML = '<div class="text-center text-sm text-gray-500 py-4">æš‚æ— è®°å½•ï¼Œç‚¹å‡»ä¸‹æ–¹æ·»åŠ çº¿ç´¢</div>';
        return;
    }
    c.innerHTML = gameState.speechRecords.map(r => `
        <div class="speech-bubble glass-panel rounded-lg p-3 text-sm border-l-4 border-blue-500 mb-2">
            <div class="flex justify-between text-xs text-gray-500 mb-1">
                <span class="font-bold text-blue-400">ç¬¬${r.round}è½® ${r.speaker}</span>
            </div>
            <div class="text-gray-200 break-words">${r.content}</div>
        </div>
    `).join('');
    c.scrollTop = c.scrollHeight;
}

function clearRecords() {
    if(confirm('æ¸…ç©ºæ‰€æœ‰è®°å½•ï¼Ÿ')) {
        gameState.speechRecords = [];
        updateSpeechRecords();
    }
}

// ============ ç™½æ¿çŒœè¯ ============
function showBlankGuess() {
    document.getElementById('blankGuessModal').classList.remove('hidden');
}

function closeBlankGuess() {
    document.getElementById('blankGuessModal').classList.add('hidden');
}

function confirmBlankGuess() {
    const w1 = document.getElementById('guessWord1').value.trim();
    const w2 = document.getElementById('guessWord2').value.trim();
    
    if(!w1 || !w2) {
        alert('è¯·å¡«å†™ä¸¤ä¸ªè¯');
        return;
    }
    
    const words = [gameState.words.civilian, gameState.words.undercover].sort();
    const guesses = [w1, w2].sort();
    
    if(guesses[0] === words[0] && guesses[1] === words[1]) {
        alert('ğŸ‰ ç™½æ¿çŒœå¯¹äº†ï¼ç™½æ¿è·èƒœï¼');
        showResult('blank', 'ç™½æ¿çŒœå‡ºåŒè¯');
    } else {
        alert(`âŒ é”™è¯¯ï¼æ­£ç¡®ç­”æ¡ˆæ˜¯ï¼š${gameState.words.civilian} å’Œ ${gameState.words.undercover}`);
        closeBlankGuess();
    }
}

// ============ æŠ•ç¥¨ç³»ç»Ÿ ============
function startVoting() {
    if(gameState.timer) clearInterval(gameState.timer);
    gameState.phase = 'voting';
    gameState.votes = {};
    showScreen('voteScreen');
    
    const alive = gameState.players.filter(p => p.alive);
    const grid = document.getElementById('voteGrid');
    grid.innerHTML = '';
    
    alive.forEach(p => {
        const btn = document.createElement('button');
        btn.className = 'flex flex-col items-center gap-2 p-6 rounded-2xl glass-panel hover:bg-white/10 active:scale-95 transition-all btn-press';
        btn.onclick = () => castVote(p.id);
        btn.innerHTML = `
            <div class="w-20 h-20 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-3xl font-bold shadow-lg">${p.id}</div>
            <div class="font-bold text-lg">${p.name}</div>
            <div class="text-xs text-gray-500">ç‚¹å‡»æŠ•ç¥¨</div>
        `;
        grid.appendChild(btn);
    });
}

function castVote(targetId) {
    // æ¨¡æ‹ŸæŠ•ç¥¨ï¼šç›®æ ‡å¾—ç¥¨é«˜
    const alive = gameState.players.filter(p => p.alive);
    const votes = {};
    alive.forEach(p => votes[p.id] = 0);
    
    // ç»™ç›®æ ‡æŠ•ç¥¨
    alive.forEach(p => {
        if(p.id !== targetId) {
            if(Math.random() > 0.3) {
                votes[targetId]++;
            } else {
                const others = alive.filter(x => x.id !== p.id && x.id !== targetId);
                if(others.length > 0) {
                    const rand = others[Math.floor(Math.random() * others.length)];
                    votes[rand.id]++;
                }
            }
        }
    });
    
    // æ‰¾æœ€é«˜ç¥¨
    let max = 0, outId = null;
    for(let id in votes) {
        if(votes[id] > max) {
            max = votes[id];
            outId = parseInt(id);
        }
    }
    
    const out = gameState.players.find(p => p.id === outId);
    if(out) {
        out.alive = false;
        gameState.eliminated.push(out);
        
        const roleText = out.role === 'civilian' ? 'å¹³æ°‘' : out.role === 'undercover' ? 'å§åº•' : 'ç™½æ¿';
        const icon = out.role === 'civilian' ? 'ğŸ‘¥' : out.role === 'undercover' ? 'ğŸ•µï¸' : 'ğŸƒ';
        
        alert(`${out.name} è¢«æ·˜æ±°ï¼\n\n${icon} èº«ä»½ï¼š${roleText}\nğŸ“ è¯è¯­ï¼š${out.word || 'ç™½æ¿æ— è¯'}`);
        
        if(!checkWin()) {
            gameState.round++;
            gameState.phase = 'playing';
            gameState.currentPlayerIndex = 0;
            showScreen('gameScreen');
            updateGameView();
            if(gameState.useTimer) startTimer(60);
        }
    }
}

function checkWin() {
    const alive = gameState.players.filter(p => p.alive);
    const civ = alive.filter(p => p.role === 'civilian').length;
    const und = alive.filter(p => p.role === 'undercover').length;
    
    if(und === 0) {
        showResult('civilian', 'å§åº•å…¨éƒ¨è¢«æ·˜æ±°');
        return true;
    }
    if(und >= civ) {
        showResult('undercover', 'å§åº•äººæ•°ä¸å°‘äºå¹³æ°‘');
        return true;
    }
    return false;
}

function showResult(winner, reason) {
    showScreen('resultScreen');
    
    const titleMap = {
        'civilian': ['å¹³æ°‘èƒœåˆ©ï¼', 'text-green-400', 'ğŸ‰'],
        'undercover': ['å§åº•èƒœåˆ©ï¼', 'text-red-400', 'ğŸ•µï¸'],
        'blank': ['ç™½æ¿èƒœåˆ©ï¼', 'text-purple-400', 'ğŸƒ']
    };
    
    const [title, colorClass, emoji] = titleMap[winner];
    document.getElementById('resultTitle').textContent = title;
    document.getElementById('resultTitle').className = `text-4xl font-black mb-2 ${colorClass}`;
    document.getElementById('resultEmoji').textContent = emoji;
    document.getElementById('resultDesc').textContent = reason;
    
    document.getElementById('resultCivilianWord').textContent = gameState.words.civilian;
    document.getElementById('resultUndercoverWord').textContent = gameState.words.undercover;
    
    // æ˜¾ç¤ºæ‰€æœ‰ç©å®¶èº«ä»½
    const list = document.getElementById('resultList');
    list.innerHTML = '';
    gameState.players.forEach(p => {
        const roleColor = p.role === 'civilian' ? 'text-green-400' : p.role === 'undercover' ? 'text-red-400' : 'text-purple-400';
        const roleText = p.role === 'civilian' ? 'å¹³æ°‘' : p.role === 'undercover' ? 'å§åº•' : 'ç™½æ¿';
        
        list.innerHTML += `
            <div class="flex items-center justify-between p-3 rounded-xl bg-white/5">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full ${p.alive ? 'bg-gradient-to-br from-blue-500 to-purple-500' : 'bg-gray-700 grayscale'} flex items-center justify-center font-bold text-sm">
                        ${p.id}
                    </div>
                    <div class="${p.alive ? '' : 'opacity-50 line-through'}">
                        <div class="font-bold">${p.name}</div>
                        <div class="text-xs text-gray-500">${p.word || 'ç™½æ¿'}</div>
                    </div>
                </div>
                <div class="${roleColor} font-bold text-sm">${roleText}</div>
            </div>
        `;
    });
    
    // ä¿å­˜å†å²
    let h = JSON.parse(localStorage.getItem('gameHistory') || '[]');
    h.unshift({
        date: new Date().toLocaleString(),
        winner: winner,
        words: gameState.words,
        playerCount: gameState.players.length,
        round: gameState.round
    });
    if(h.length > 20) h = h.slice(0, 20);
    localStorage.setItem('gameHistory', JSON.stringify(h));
    localStorage.setItem('totalGames', (parseInt(localStorage.getItem('totalGames') || '0') + 1).toString());
}

// ============ è¯åº“ç®¡ç† ============
function showWordBank() {
    showScreen('wordBankScreen');
    renderWordList('all');
}

function renderWordList(cat) {
    const list = document.getElementById('wordList');
    list.innerHTML = '';
    
    let words = [];
    if(cat === 'all') {
        words = [...wordBank.food, ...wordBank.daily, ...wordBank.ent, ...wordBank.custom];
    } else {
        words = wordBank[cat];
    }
    
    words.forEach((p, i) => {
        const div = document.createElement('div');
        div.className = 'glass-panel rounded-xl p-4 flex items-center justify-between';
        div.innerHTML = `
            <div class="flex items-center gap-3">
                <div class="text-xl">ğŸ†š</div>
                <div>
                    <div class="text-green-400 font-bold">${p.c}</div>
                    <div class="text-red-400 font-bold">${p.u}</div>
                </div>
            </div>
        `;
        if(cat === 'custom') {
            div.innerHTML += `<button onclick="deleteWord(${i})" class="text-red-400 text-sm font-bold btn-press">åˆ é™¤</button>`;
        }
        list.appendChild(div);
    });
    
    if(words.length === 0) {
        list.innerHTML = '<div class="text-center text-gray-500 py-8">æš‚æ— è¯è¯­</div>';
    }
}

function filterWords(cat, btn) {
    document.querySelectorAll('#categoryTabs button').forEach(b => {
        b.classList.remove('bg-blue-600', 'font-bold');
        b.classList.add('bg-white/10');
    });
    btn.classList.remove('bg-white/10');
    btn.classList.add('bg-blue-600', 'font-bold');
    renderWordList(cat);
}

function showAddWord() {
    document.getElementById('addWordModal').classList.remove('hidden');
    document.getElementById('newCivilianWord').value = '';
    document.getElementById('newUndercoverWord').value = '';
    document.getElementById('newCivilianWord').focus();
}

function closeAddWord() {
    document.getElementById('addWordModal').classList.add('hidden');
}

function confirmAddWord() {
    const c = document.getElementById('newCivilianWord').value.trim();
    const u = document.getElementById('newUndercoverWord').value.trim();
    
    if(!c || !u) {
        alert('è¯·å¡«å†™ä¸¤ä¸ªè¯');
        return;
    }
    
    wordBank.custom.push({c: c, u: u});
    localStorage.setItem('customWords', JSON.stringify(wordBank.custom));
    updateWordCount();
    closeAddWord();
    renderWordList('custom');
    
    // åˆ‡æ¢æ ‡ç­¾åˆ°è‡ªå®šä¹‰
    document.querySelectorAll('#categoryTabs button').forEach(b => {
        b.classList.remove('bg-blue-600', 'font-bold');
        b.classList.add('bg-white/10');
    });
    document.querySelectorAll('#categoryTabs button')[4].classList.add('bg-blue-600', 'font-bold');
    document.querySelectorAll('#categoryTabs button')[4].classList.remove('bg-white/10');
}

function deleteWord(i) {
    if(confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) {
        wordBank.custom.splice(i, 1);
        localStorage.setItem('customWords', JSON.stringify(wordBank.custom));
        renderWordList('custom');
        updateWordCount();
    }
}

// ============ æƒ©ç½šè½¬ç›˜ ============
function showPunishmentWheel() {
    showScreen('wheelScreen');
    renderWheel();
}

function renderWheel() {
    const w = document.getElementById('rouletteWheel');
    w.innerHTML = '';
    w.style.transform = 'rotate(0deg)';
    
    const count = punishments.length;
    const angle = 360 / count;
    const colors = ['#ef4444', '#dc2626', '#b91c1c', '#f87171', '#991b1b'];
    
    punishments.forEach((p, i) => {
        const s = document.createElement('div');
        s.className = 'roulette-segment';
        s.style.transform = `rotate(${i * angle}deg)`;
        s.style.background = `conic-gradient(from 0deg, ${colors[i % colors.length]} 0deg, ${colors[(i+1) % colors.length]} ${angle}deg)`;
        s.style.clipPath = `polygon(100% 0, 100% 100%, 0 100%)`;
        s.innerHTML = `<span style="transform: rotate(${angle/2}deg) translateY(-20px); display: block;">${p.substring(0, 4)}</span>`;
        w.appendChild(s);
    });
}

function spinWheel() {
    const w = document.getElementById('rouletteWheel');
    const resultDiv = document.getElementById('punishmentResult');
    resultDiv.classList.add('hidden');
    
    const rot = 1800 + Math.random() * 1800;
    w.style.transform = `rotate(${rot}deg)`;
    
    if(navigator.vibrate) {
        let c = 0;
        const iv = setInterval(() => {
            navigator.vibrate(50);
            c++;
            if(c > 20) clearInterval(iv);
        }, 100);
    }
    
    setTimeout(() => {
        const finalRot = rot % 360;
        const segAngle = 360 / punishments.length;
        const index = Math.floor((360 - finalRot) / segAngle) % punishments.length;
        
        document.getElementById('punishmentText').textContent = punishments[index];
        resultDiv.classList.remove('hidden');
        
        if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
    }, 4000);
}

function editPunishments() {
    const np = prompt('è‡ªå®šä¹‰æƒ©ç½šï¼ˆç”¨é€—å·åˆ†éš”ï¼‰ï¼š\n\nå½“å‰ï¼š' + punishments.join('ã€'), punishments.join('ï¼Œ'));
    if(np) {
        const newList = np.split(/[,ï¼Œ]/).map(p => p.trim()).filter(p => p);
        if(newList.length >= 4) {
            punishments = newList;
            localStorage.setItem('punishments', JSON.stringify(punishments));
            updateWordCount();
            renderWheel();
        } else {
            alert('è‡³å°‘éœ€è¦4ä¸ªæƒ©ç½šé¡¹ç›®');
        }
    }
}

// ============ å†å²è®°å½• ============
function showHistory() {
    showScreen('historyScreen');
    const list = document.getElementById('historyList');
    const h = JSON.parse(localStorage.getItem('gameHistory') || '[]');
    
    if(h.length === 0) {
        list.innerHTML = '<div class="text-center text-gray-500 py-12">æš‚æ— è®°å½•</div>';
        return;
    }
    
    list.innerHTML = h.map(item => {
        const wc = item.winner === 'civilian' ? 'text-green-400 border-green-500' : 
                   item.winner === 'undercover' ? 'text-red-400 border-red-500' : 'text-purple-400 border-purple-500';
        const wt = item.winner === 'civilian' ? 'å¹³æ°‘èƒœ' : item.winner === 'undercover' ? 'å§åº•èƒœ' : 'ç™½æ¿èƒœ';
        
        return `
            <div class="glass-panel rounded-xl p-4 border-l-4 ${wc}">
                <div class="flex justify-between text-xs text-gray-500 mb-1">
                    <span>${item.date}</span>
                    <span class="${wc.split(' ')[0]} font-bold">${wt}</span>
                </div>
                <div class="flex justify-between text-sm font-bold">
                    <span class="text-green-400">${item.words.civilian}</span>
                    <span class="text-gray-600">vs</span>
                    <span class="text-red-400">${item.words.undercover}</span>
                </div>
                <div class="text-xs text-gray-600 mt-1">${item.playerCount}äºº Â· ç¬¬${item.round}è½®ç»“æŸ</div>
            </div>
        `;
    }).join('');
}

// ============ å…¶ä»–åŠŸèƒ½ ============
function toggleNightMode() {
    gameState.nightMode = !gameState.nightMode;
    document.body.style.filter = gameState.nightMode ? 'brightness(0.7) sepia(0.2)' : '';
}

function showMenu() {
    if(gameState.phase === 'home') {
        const c = prompt('é€‰æ‹©åŠŸèƒ½ï¼š\n1.æƒ©ç½šè½¬ç›˜\n2.è¯åº“ç®¡ç†\n3.å†å²è®°å½•\n4.å…³äº\n\nè¾“å…¥æ•°å­—ï¼š');
        if(c === '1') showPunishmentWheel();
        else if(c === '2') showWordBank();
        else if(c === '3') showHistory();
        else if(c === '4') alert('è°æ˜¯å§åº•PRO MAX v1.0\n\né˜²çª¥å±è®¾è®¡ Â· 47ç»„è¯åº“ Â· 20ç§æƒ©ç½š');
    } else {
        if(confirm('ç¡®å®šè¦ç»“æŸå½“å‰æ¸¸æˆå—ï¼Ÿ')) {
            location.reload();
        }
    }
}

// é˜²æ­¢æ„å¤–åˆ·æ–°
window.onbeforeunload = function(e) {
    if(gameState.phase !== 'home' && gameState.phase !== 'result') {
        return 'æ¸¸æˆæ­£åœ¨è¿›è¡Œä¸­ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
    }
};
</script>

</body>
</html>
