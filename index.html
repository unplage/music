<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è°æ˜¯å§åº•PRO MAX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: white;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        
        /* ç»Ÿä¸€å¡ç‰‡é¢œè‰² - å…³é”®ä¿®å¤ï¼šæ‰€æœ‰èº«ä»½ä½¿ç”¨ç›¸åŒè‰²ç³»ï¼Œé˜²æ­¢ä½™å…‰å·ç„ */
        .uniform-card {
            background: linear-gradient(135deg, #3b82f6 0%, #6366f1 50%, #8b5cf6 100%) !important;
        }
        
        .card-container {
            perspective: 1000px;
            transform-style: preserve-3d;
        }
        
        .game-card {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .game-card.flipped {
            transform: rotateY(180deg);
        }
        
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        
        /* æ­£é¢ï¼šç»Ÿä¸€æ·±è‰²èƒŒæ™¯ */
        .card-front {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 2px solid rgba(255,255,255,0.1);
            z-index: 2;
        }
        
        /* èƒŒé¢ï¼šç»Ÿä¸€è“ç´«è‰²ï¼Œä¸åŒºåˆ†èº«ä»½ */
        .card-back {
            background: linear-gradient(135deg, #3b82f6 0%, #6366f1 50%, #8b5cf6 100%);
            transform: rotateY(180deg);
            border: 2px solid rgba(255,255,255,0.2);
        }
        
        /* éšç§é®ç½© - æœ€å¼ºé˜²çª¥ */
        .privacy-shield {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s;
        }
        
        /* æƒ©ç½šè½¬ç›˜ */
        .roulette-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto;
        }
        
        .roulette-wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }
        
        .roulette-segment {
            position: absolute;
            width: 50%;
            height: 50%;
            transform-origin: right bottom;
            left: 0;
            top: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            padding-right: 20%;
            padding-bottom: 20%;
            box-sizing: border-box;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        .roulette-pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 30px solid #ef4444;
            z-index: 10;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .speech-bubble {
            position: relative;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .btn-press:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="antialiased overflow-hidden">

<div id="app" class="h-full flex flex-col relative bg-slate-900">
    
    <!-- éšç§é®ç½©å±‚ -->
    <div id="privacyShield" class="privacy-shield" onclick="hidePrivacyShield()">
        <div class="text-6xl mb-4 animate-pulse">ğŸ‘†</div>
        <div class="text-2xl font-bold mb-2"> PRIVATE MODE</div>
        <div class="text-gray-400 text-sm mb-8">ç‚¹å‡»ç¡®è®¤åªæœ‰ä½ ä¸€äººè§‚çœ‹</div>
        <div class="text-xs text-gray-600 bg-gray-900 px-4 py-2 rounded-full">é˜²çª¥å±ä¿æŠ¤ä¸­</div>
    </div>

    <!-- é¡¶éƒ¨æ  -->
    <header class="glass-panel sticky top-0 z-40 px-4 py-3 flex items-center justify-between border-b border-white/10 shrink-0">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-xl shadow-lg">
                ğŸ­
            </div>
            <div>
                <h1 class="font-bold text-lg leading-tight">å§åº•<span class="text-blue-400">PRO</span><span class="text-purple-400 text-xs">MAX</span></h1>
                <p class="text-xs text-gray-400" id="gameStatus">å‡†å¤‡å¼€å§‹</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleSound()" id="soundBtn" class="p-2 rounded-lg hover:bg-white/10 text-gray-400 transition-colors">
                ğŸ”Š
            </button>
            <button onclick="showMenu()" class="p-2 rounded-lg hover:bg-white/10 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
            </button>
        </div>
    </header>

    <main id="mainContent" class="flex-1 overflow-y-auto hide-scrollbar p-4 pb-24 relative">
        
        <!-- é¦–é¡µ -->
        <div id="homeScreen" class="space-y-6 fade-in h-full flex flex-col justify-center max-w-md mx-auto">
            <div class="text-center space-y-4 mb-8">
                <div class="text-7xl mb-4 animate-float inline-block">ğŸ•µï¸</div>
                <h2 class="text-4xl font-black bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">è°æ˜¯å§åº•</h2>
                <p class="text-gray-400 text-sm">é˜²çª¥å± Â· æƒ©ç½šè½¬ç›˜ Â· è¯åº“ç³»ç»Ÿ</p>
            </div>

            <div class="space-y-3">
                <button onclick="showSetup()" class="w-full py-4 rounded-2xl bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 font-bold text-lg shadow-xl shadow-blue-500/25 btn-press transition-all flex items-center justify-center gap-2">
                    <span>ğŸš€</span> å¼€å§‹æ¸¸æˆ
                </button>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="showWordBank()" class="py-3 rounded-2xl glass-panel hover:bg-white/10 font-medium text-gray-300 transition-all btn-press flex items-center justify-center gap-2">
                        <span>ğŸ“š</span> è¯åº“
                    </button>
                    <button onclick="showPunishmentWheel()" class="py-3 rounded-2xl glass-panel hover:bg-white/10 font-medium text-gray-300 transition-all btn-press flex items-center justify-center gap-2">
                        <span>ğŸ¯</span> æƒ©ç½š
                    </button>
                </div>
                <button onclick="showHistory()" class="w-full py-3 rounded-2xl glass-panel hover:bg-white/10 font-medium text-gray-300 transition-all btn-press flex items-center justify-center gap-2">
                    <span>ğŸ“Š</span> å†å²è®°å½•
                </button>
            </div>

            <div class="mt-8 grid grid-cols-3 gap-3 text-center">
                <div class="glass-panel rounded-xl p-3">
                    <div class="text-2xl font-bold text-blue-400" id="totalGames">0</div>
                    <div class="text-xs text-gray-500">æ€»åœºæ¬¡</div>
                </div>
                <div class="glass-panel rounded-xl p-3">
                    <div class="text-2xl font-bold text-purple-400" id="wordCount">47</div>
                    <div class="text-xs text-gray-500">è¯åº“æ•°é‡</div>
                </div>
                <div class="glass-panel rounded-xl p-3">
                    <div class="text-2xl font-bold text-pink-400" id="punishCount">20</div>
                    <div class="text-xs text-gray-500">æƒ©ç½šé¡¹ç›®</div>
                </div>
            </div>
        </div>

        <!-- è®¾ç½®é¡µé¢ -->
        <div id="setupScreen" class="hidden space-y-6 max-w-md mx-auto py-4">
            <h2 class="text-2xl font-bold text-center mb-6">æ¸¸æˆè®¾ç½®</h2>
            
            <div class="glass-panel rounded-2xl p-5 space-y-6">
                <div>
                    <label class="flex justify-between text-sm font-medium mb-2 text-gray-300">
                        <span>ç©å®¶äººæ•°</span>
                        <span class="text-blue-400 font-bold" id="playerCountDisplay">6äºº</span>
                    </label>
                    <input type="range" id="playerCount" min="4" max="16" value="6" 
                           class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-blue-500"
                           oninput="updateSetup()">
                </div>

                <div>
                    <label class="flex justify-between text-sm font-medium mb-2 text-gray-300">
                        <span>å§åº•æ•°é‡</span>
                        <span class="text-purple-400 font-bold" id="undercoverCountDisplay">1äºº</span>
                    </label>
                    <input type="range" id="undercoverCount" min="1" max="4" value="1" 
                           class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-purple-500"
                           oninput="updateSetup()">
                </div>

                <div class="flex items-center justify-between py-2 border-t border-white/10">
                    <div>
                        <div class="font-medium text-gray-200">å¯ç”¨ç™½æ¿</div>
                        <div class="text-xs text-gray-500">ç™½æ¿çŒœå¯¹åŒè¯å³èƒœåˆ©</div>
                    </div>
                    <button id="blankToggle" onclick="toggleBlank()" class="w-14 h-8 rounded-full bg-gray-700 relative transition-colors duration-300">
                        <div class="w-6 h-6 bg-white rounded-full absolute top-1 left-1 transition-transform duration-300 shadow-md"></div>
                    </button>
                </div>

                <div class="flex items-center justify-between py-2 border-t border-white/10">
                    <div>
                        <div class="font-medium text-gray-200">å‘è¨€è®¡æ—¶</div>
                        <div class="text-xs text-gray-500">æ¯äººé™æ—¶60ç§’</div>
                    </div>
                    <button id="timerToggle" onclick="toggleTimer()" class="w-14 h-8 rounded-full bg-blue-600 relative transition-colors duration-300">
                        <div class="w-6 h-6 bg-white rounded-full absolute top-1 left-1 transition-transform duration-300 shadow-md transform translate-x-6"></div>
                    </button>
                </div>
            </div>

            <div class="glass-panel rounded-2xl p-4">
                <h3 class="font-bold mb-3 text-sm text-gray-300">è§’è‰²åˆ†é…é¢„è§ˆ</h3>
                <div class="flex gap-2 flex-wrap justify-center" id="rolePreview"></div>
                <div class="text-center text-xs text-gray-500 mt-2" id="roleSummary"></div>
            </div>

            <button onclick="startDealing()" class="w-full py-4 rounded-2xl bg-gradient-to-r from-green-600 to-emerald-600 font-bold text-lg shadow-xl btn-press transition-all">
                å¼€å§‹å‘ç‰Œ ğŸ²
            </button>
        </div>

        <!-- å‘ç‰Œé¡µé¢ - æ ¸å¿ƒä¿®å¤åŒºåŸŸ -->
        <div id="dealingScreen" class="hidden h-full flex flex-col max-w-md mx-auto py-4">
            <div class="text-center mb-6">
                <div class="text-sm text-gray-400 mb-1">å½“å‰ç©å®¶</div>
                <div class="text-3xl font-black text-white" id="currentPlayerName">ç©å®¶ 1</div>
                <div class="text-xs text-gray-500 mt-2">ç‚¹å‡»å¡ç‰‡ â†’ æŸ¥çœ‹ â†’ ç¿»è½¬ä¼ é€’</div>
            </div>

            <div class="flex-1 flex items-center justify-center min-h-[400px] px-4">
                <div class="w-full aspect-[3/4] max-w-sm relative card-container">
                    <div id="identityCard" class="game-card w-full h-full cursor-pointer" onclick="flipCard(this)">
                        <!-- æ­£é¢ï¼šå®Œå…¨ç»Ÿä¸€ï¼Œç»ä¸æš´éœ²ä¿¡æ¯ -->
                        <div class="card-face card-front">
                            <div class="w-24 h-24 rounded-full bg-white/10 flex items-center justify-center text-5xl mb-6 backdrop-blur-sm border-2 border-white/20">
                                ğŸ´
                            </div>
                            <div class="text-2xl font-bold text-white mb-2">ç‚¹å‡»ç¿»å¼€</div>
                            <div class="text-sm text-gray-400">æŸ¥çœ‹ä½ çš„èº«ä»½ç‰Œ</div>
                            <div class="mt-8 text-xs text-gray-600 px-8 text-center leading-relaxed">
                                è¯·ç¡®ä¿å‘¨å›´æ— äººçª¥å±<br>
                                åªæœ‰ä½ èƒ½çœ‹åˆ°å†…å®¹<br>
                                <span class="text-gray-700 mt-2 block">[SECURITY MODE]</span>
                            </div>
                        </div>
                        
                        <!-- èƒŒé¢ï¼šç»Ÿä¸€è“ç´«è‰²ï¼Œç»ä¸ä½¿ç”¨çº¢ç»¿åŒºåˆ† -->
                        <div class="card-face card-back uniform-card">
                            <div class="w-20 h-20 rounded-full bg-white/20 flex items-center justify-center text-4xl mb-6 backdrop-blur-sm border-2 border-white/30 shadow-inner" id="roleIcon">
                                ğŸ‘¥
                            </div>
                            <div class="text-sm text-white/80 mb-2 uppercase tracking-widest text-xs">ä½ çš„èº«ä»½</div>
                            <div class="text-4xl font-black text-white mb-8 drop-shadow-lg" id="roleTitle">å¹³æ°‘</div>
                            
                            <div class="bg-black/20 rounded-2xl p-6 w-full mx-4 backdrop-blur-sm border border-white/10">
                                <div class="text-xs text-white/60 mb-2 uppercase tracking-wider">æç¤ºè¯</div>
                                <div class="text-5xl font-bold text-white mb-2 tracking-wider" id="roleWord">è‹¹æœ</div>
                                <div class="text-xs text-white/70 mt-2 font-medium" id="wordHint">è¯·è®°ä½è¿™ä¸ªè¯</div>
                            </div>
                            
                            <div class="mt-6 text-xs text-white/70 px-6 text-center leading-relaxed" id="roleHint">
                                æè¿°è¿™ä¸ªè¯ï¼Œä½†ä¸è¦ç›´æ¥è¯´å‡ºæ¥
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-8 space-y-3 px-4">
                <button id="nextPlayerBtn" onclick="nextPlayer()" class="hidden w-full py-4 rounded-2xl bg-blue-600 hover:bg-blue-500 font-bold text-lg shadow-xl btn-press transition-all flex items-center justify-center gap-2">
                    <span>ç¡®è®¤å¹¶ä¼ é€’</span>
                    <span>â†’</span>
                </button>
                
                <button id="startGameBtn" onclick="startPlaying()" class="hidden w-full py-4 rounded-2xl bg-gradient-to-r from-green-600 to-emerald-600 font-bold text-lg shadow-xl btn-press transition-all animate-pulse">
                    æ‰€æœ‰äººå‡†å¤‡å®Œæ¯•ï¼Œå¼€å§‹æ¸¸æˆï¼
                </button>
                
                <div class="text-center text-sm text-gray-500 font-mono" id="dealingProgress">
                    ç¬¬ 1 / 6 ä½ç©å®¶
                </div>
            </div>
        </div>

        <!-- æ¸¸æˆè¿›è¡Œé¡µé¢ -->
        <div id="gameScreen" class="hidden space-y-4 max-w-2xl mx-auto py-2">
            <div class="glass-panel rounded-2xl p-4 flex items-center justify-between sticky top-0 z-10">
                <div>
                    <div class="text-xs text-gray-400 mb-1">ç¬¬ <span id="roundNumber" class="text-white font-bold text-lg">1</span> è½®</div>
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                        <span class="text-sm font-bold" id="phaseText">å‘è¨€é˜¶æ®µ</span>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="text-right hidden sm:block">
                        <div class="text-xs text-gray-400">å½“å‰å‘è¨€</div>
                        <div class="font-bold" id="speakerName">ç©å®¶1</div>
                    </div>
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-lg font-bold shadow-lg" id="speakerAvatar">
                        1
                    </div>
                </div>
            </div>

            <div id="timerSection" class="glass-panel rounded-2xl p-4">
                <div class="flex justify-between text-xs text-gray-400 mb-2">
                    <span>å‰©ä½™æ—¶é—´</span>
                    <span id="timerText" class="text-xl font-bold text-white font-mono">60</span>
                </div>
                <div class="h-3 bg-gray-700 rounded-full overflow-hidden relative">
                    <div id="timerBar" class="h-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-1000 w-full"></div>
                </div>
            </div>

            <div id="blankGuessBtn" class="hidden glass-panel rounded-2xl p-4 border-2 border-purple-500/50 bg-purple-500/10">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="font-bold text-purple-300 text-lg">ä½ æ˜¯ç™½æ¿ï¼</div>
                        <div class="text-xs text-gray-400">å¬å–æè¿°åçŒœä¸¤ä¸ªè¯</div>
                    </div>
                    <button onclick="showBlankGuessModal()" class="px-6 py-3 rounded-xl bg-purple-600 hover:bg-purple-500 text-white font-bold transition-colors shadow-lg">
                        çŒœè¯
                    </button>
                </div>
            </div>

            <div class="glass-panel rounded-2xl p-4">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-bold text-sm text-gray-300">ğŸ“ å‘è¨€è®°å½•æ¿</h3>
                    <button onclick="clearRecords()" class="text-xs text-gray-500 hover:text-white">æ¸…ç©º</button>
                </div>
                <div id="speechRecords" class="space-y-2 max-h-32 overflow-y-auto hide-scrollbar">
                    <div class="text-center text-sm text-gray-500 py-4">æš‚æ— è®°å½•</div>
                </div>
                <button onclick="addSpeechRecord()" class="w-full mt-3 py-3 rounded-xl bg-white/5 hover:bg-white/10 text-sm text-gray-400 transition-colors border border-dashed border-white/20">
                    + è®°å½•å½“å‰å‘è¨€è¦ç‚¹
                </button>
            </div>

            <div class="glass-panel rounded-2xl p-4">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-bold text-sm text-gray-300">ç©å®¶çŠ¶æ€</h3>
                    <span class="text-xs text-gray-500" id="aliveCount">å­˜æ´» 6/6</span>
                </div>
                <div class="grid grid-cols-4 sm:grid-cols-6 gap-3" id="playerGrid"></div>
            </div>

            <div class="h-32"></div> <!-- åº•éƒ¨ spacer -->
        </div>

        <!-- åº•éƒ¨æ“ä½œæ  -->
        <div class="fixed bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-slate-900 via-slate-900/95 to-transparent z-50 pointer-events-none">
            <div class="max-w-md mx-auto space-y-2 pointer-events-auto">
                <button id="actionBtn" onclick="nextSpeaker()" class="w-full py-4 rounded-2xl bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 font-bold text-lg shadow-xl btn-press transition-all flex items-center justify-center gap-2">
                    <span>ä¸‹ä¸€ä½å‘è¨€</span>
                    <span>â†’</span>
                </button>
                <div class="flex gap-2">
                    <button onclick="startVoting()" class="flex-1 py-3 rounded-xl bg-gradient-to-r from-orange-600 to-red-600 font-bold text-sm shadow-lg btn-press transition-all">
                        å‘èµ·æŠ•ç¥¨
                    </button>
                    <button onclick="toggleNightMode()" class="px-4 py-3 rounded-xl glass-panel hover:bg-white/10 font-bold text-sm" title="æŠ¤çœ¼æ¨¡å¼">
                        ğŸŒ™
                    </button>
                </div>
            </div>
        </div>

        <!-- æŠ•ç¥¨é¡µé¢ -->
        <div id="voteScreen" class="hidden space-y-6 max-w-md mx-auto py-4 pb-32">
            <div class="text-center py-4">
                <h2 class="text-3xl font-black mb-2 text-red-400">æŠ•ç¥¨æ—¶åˆ»</h2>
                <p class="text-gray-400 text-sm">é€‰å‡ºæœ€åƒå§åº•çš„äºº</p>
            </div>
            <div id="voteGrid" class="grid grid-cols-3 gap-3"></div>
        </div>

        <!-- ç»“æœé¡µé¢ -->
        <div id="resultScreen" class="hidden space-y-6 max-w-md mx-auto py-8 text-center">
            <div class="text-6xl mb-4 animate-bounce" id="resultEmoji">ğŸ‰</div>
            <h2 class="text-4xl font-black mb-2 text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-blue-400" id="resultTitle">å¹³æ°‘èƒœåˆ©ï¼</h2>
            <p class="text-gray-400 mb-6" id="resultDesc"></p>

            <div class="glass-panel rounded-2xl p-6 space-y-3 text-left max-h-64 overflow-y-auto hide-scrollbar">
                <h3 class="font-bold text-lg mb-4 text-center border-b border-white/10 pb-2">èº«ä»½æ­æ™“</h3>
                <div id="resultList" class="space-y-2"></div>
            </div>

            <div class="glass-panel rounded-2xl p-4 bg-gradient-to-r from-blue-500/20 to-purple-500/20 border border-white/20">
                <div class="text-sm text-gray-400 mb-1">æœ¬å±€è¯è¯­</div>
                <div class="flex items-center justify-center gap-4 text-lg font-bold">
                    <div class="text-green-400">ã€Œ<span id="resultCivilianWord">?</span>ã€</div>
                    <span class="text-gray-600">vs</span>
                    <div class="text-red-400">ã€Œ<span id="resultUndercoverWord">?</span>ã€</div>
                </div>
            </div>

            <div class="space-y-3">
                <button onclick="showPunishmentWheel()" class="w-full py-4 rounded-2xl bg-gradient-to-r from-pink-600 to-rose-600 font-bold text-lg shadow-xl btn-press">
                    <span>ğŸ¯</span> æƒ©ç½šè½¬ç›˜
                </button>
                <button onclick="location.reload()" class="w-full py-3 rounded-2xl glass-panel hover:bg-white/10 font-bold">
                    å†æ¥ä¸€å±€ â†º
                </button>
            </div>
        </div>

        <!-- è¯åº“é¡µé¢ -->
        <div id="wordBankScreen" class="hidden space-y-6 max-w-md mx-auto py-4">
            <div class="flex items-center justify-between mb-4">
                <button onclick="showScreen('homeScreen')" class="p-2 rounded-lg hover:bg-white/10">â†</button>
                <h2 class="text-xl font-bold">è¯åº“ç®¡ç†</h2>
                <button onclick="showAddWordModal()" class="px-4 py-2 rounded-lg bg-blue-600 text-sm font-bold">+ æ·»åŠ </button>
            </div>
            <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-2" id="categoryTabs">
                <button class="px-4 py-2 rounded-full bg-blue-600 text-sm font-bold whitespace-nowrap" onclick="filterWords('all', this)">å…¨éƒ¨</button>
                <button class="px-4 py-2 rounded-full bg-white/10 text-sm whitespace-nowrap" onclick="filterWords('food', this)">ç¾é£Ÿ</button>
                <button class="px-4 py-2 rounded-full bg-white/10 text-sm whitespace-nowrap" onclick="filterWords('daily', this)">ç”Ÿæ´»</button>
                <button class="px-4 py-2 rounded-full bg-white/10 text-sm whitespace-nowrap" onclick="filterWords('ent', this)">å¨±ä¹</button>
                <button class="px-4 py-2 rounded-full bg-white/10 text-sm whitespace-nowrap" onclick="filterWords('custom', this)">è‡ªå®šä¹‰</button>
            </div>
            <div id="wordList" class="space-y-2 max-h-[60vh] overflow-y-auto hide-scrollbar"></div>
        </div>

        <!-- æƒ©ç½šè½¬ç›˜é¡µé¢ -->
        <div id="wheelScreen" class="hidden space-y-6 max-w-md mx-auto py-4 h-full flex flex-col">
            <div class="flex items-center justify-between mb-4">
                <button onclick="showScreen('homeScreen')" class="p-2 rounded-lg hover:bg-white/10">â†</button>
                <h2 class="text-xl font-bold">æƒ©ç½šè½¬ç›˜</h2>
                <button onclick="customizePunishments()" class="text-sm text-blue-400">ç¼–è¾‘</button>
            </div>
            <div class="flex-1 flex flex-col items-center justify-center">
                <div class="roulette-container mb-8">
                    <div class="roulette-pointer"></div>
                    <div id="rouletteWheel" class="roulette-wheel"></div>
                </div>
                <button onclick="spinWheel()" class="px-8 py-4 rounded-full bg-gradient-to-r from-red-600 to-pink-600 font-bold text-xl shadow-xl btn-press animate-pulse">
                    å¼€å§‹æ—‹è½¬ï¼
                </button>
                <div id="punishmentResult" class="mt-8 text-center hidden">
                    <div class="text-sm text-gray-400 mb-2">æƒ©ç½šç»“æœ</div>
                    <div class="text-2xl font-bold text-red-400 px-6 py-3 bg-red-500/10 rounded-xl border border-red-500/30" id="punishmentText">--</div>
                </div>
            </div>
        </div>

        <!-- å†å²è®°å½•é¡µé¢ -->
        <div id="historyScreen" class="hidden space-y-6 max-w-md mx-auto py-4">
            <div class="flex items-center gap-4 mb-6">
                <button onclick="showScreen('homeScreen')" class="p-2 rounded-lg hover:bg-white/10">â†</button>
                <h2 class="text-xl font-bold">å†å²è®°å½•</h2>
            </div>
            <div id="historyList" class="space-y-3"></div>
        </div>

    </main>

    <!-- å„ç§æ¨¡æ€æ¡† -->
    <div id="addWordModal" class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="glass-panel rounded-2xl p-6 w-full max-w-md space-y-4">
            <h3 class="text-xl font-bold">æ·»åŠ è‡ªå®šä¹‰è¯è¯­</h3>
            <div class="space-y-3">
                <input type="text" id="newCivilianWord" placeholder="å¹³æ°‘è¯ï¼ˆå¦‚ï¼šè‹¹æœï¼‰" class="w-full bg-white/10 border border-white/20 rounded-xl p-3 text-white placeholder-gray-500 focus:outline-none focus:border-blue-500">
                <input type="text" id="newUndercoverWord" placeholder="å§åº•è¯ï¼ˆå¦‚ï¼šæ¢¨å­ï¼‰" class="w-full bg-white/10 border border-white/20 rounded-xl p-3 text-white placeholder-gray-500 focus:outline-none focus:border-purple-500">
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeAddWordModal()" class="flex-1 py-3 rounded-xl bg-gray-700 font-bold">å–æ¶ˆ</button>
                <button onclick="confirmAddWord()" class="flex-1 py-3 rounded-xl bg-blue-600 font-bold">æ·»åŠ </button>
            </div>
        </div>
    </div>

    <div id="blankGuessModal" class="hidden fixed inset-0 z-50 bg-black/90 backdrop-blur-md flex items-center justify-center p-4">
        <div class="glass-panel rounded-2xl p-6 w-full max-w-md space-y-4 border-2 border-purple-500/50">
            <h3 class="text-xl font-bold text-purple-400">ç™½æ¿çŒœè¯</h3>
            <p class="text-sm text-gray-400">çŒœå¯¹ä¸¤ä¸ªè¯å³å¯è·èƒœ</p>
            <div class="space-y-3">
                <input type="text" id="guessWord1" placeholder="ç¬¬ä¸€ä¸ªè¯" class="w-full bg-purple-500/10 border border-purple-500/30 rounded-xl p-3 text-white focus:outline-none focus:border-purple-500">
                <input type="text" id="guessWord2" placeholder="ç¬¬äºŒä¸ªè¯" class="w-full bg-purple-500/10 border border-purple-500/30 rounded-xl p-3 text-white focus:outline-none focus:border-purple-500">
            </div>
            <div class="flex gap-3">
                <button onclick="closeBlankGuessModal()" class="flex-1 py-3 rounded-xl bg-gray-700 font-bold">å–æ¶ˆ</button>
                <button onclick="confirmBlankGuess()" class="flex-1 py-3 rounded-xl bg-purple-600 font-bold">æäº¤</button>
            </div>
        </div>
    </div>

    <div id="recordModal" class="hidden fixed inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="glass-panel rounded-2xl p-6 w-full max-w-md space-y-4">
            <h3 class="text-lg font-bold">è®°å½•å‘è¨€</h3>
            <textarea id="speechContent" rows="3" placeholder="è®°å½•å…³é”®çº¿ç´¢..." class="w-full bg-white/10 border border-white/20 rounded-xl p-3 text-white resize-none focus:outline-none focus:border-blue-500"></textarea>
            <div class="flex gap-3">
                <button onclick="closeRecordModal()" class="flex-1 py-3 rounded-xl bg-gray-700 font-bold">å–æ¶ˆ</button>
                <button onclick="saveSpeechRecord()" class="flex-1 py-3 rounded-xl bg-blue-600 font-bold">ä¿å­˜</button>
            </div>
        </div>
    </div>

</div>

<script>
// å®Œæ•´è¯åº“ï¼ˆ47ç»„ï¼‰
const wordBank = {
    food: [
        {c:"è‹¹æœ",u:"æ¢¨å­"},{c:"éº¦å½“åŠ³",u:"è‚¯å¾·åŸº"},{c:"ç«é”…",u:"çƒ§çƒ¤"},{c:"å’–å•¡",u:"å¥¶èŒ¶"},
        {c:"è›‹ç³•",u:"é¢åŒ…"},{c:"æ³¡é¢",u:"èºè›³ç²‰"},{c:"é¥ºå­",u:"é¦„é¥¨"},{c:"é¢æ¡",u:"ç±³ç²‰"},
        {c:"å†°æ·‡æ·‹",u:"é›ªç³•"},{c:"è±†æµ†",u:"ç‰›å¥¶"},{c:"å·§å…‹åŠ›",u:"ç³–æœ"},{c:"æ±‰å ¡",u:"ä¸‰æ˜æ²»"}
    ],
    daily: [
        {c:"åœ°é“",u:"å…¬äº¤è½¦"},{c:"å¾®ä¿¡",u:"QQ"},{c:"å£çº¢",u:"å”‡è†"},{c:"æ¯›è¡£",u:"å«è¡£"},
        {c:"çœ¼é•œ",u:"å¢¨é•œ"},{c:"æ‰‹æœº",u:"å¹³æ¿"},{c:"æ´—å‘æ°´",u:"æ²æµ´éœ²"},{c:"ç‰™è†",u:"æ´—é¢å¥¶"},
        {c:"é›¨ä¼",u:"é®é˜³ä¼"},{c:"æ‰‹è¡¨",u:"æ‰‹ç¯"},{c:"é’±åŒ…",u:"å¡åŒ…"},{c:"æ‹–é‹",u:"å‡‰é‹"},
        {c:"æ•å¤´",u:"é å«"},{c:"æ¯›å·¾",u:"æµ´å·¾"},{c:"é•œå­",u:"ç»ç’ƒ"}
    ],
    ent: [
        {c:"ç‹è€…è£è€€",u:"è‹±é›„è”ç›Ÿ"},{c:"æŠ–éŸ³",u:"å¿«æ‰‹"},{c:"ç”µå½±",u:"ç”µè§†å‰§"},{c:"å°è¯´",u:"æ¼«ç”»"},
        {c:"æ¼”å”±ä¼š",u:"éŸ³ä¹èŠ‚"},{c:"å¯†å®¤é€ƒè„±",u:"å‰§æœ¬æ€"},{c:"éº»å°†",u:"æ‰‘å…‹"},{c:"KTV",u:"é…’å§"},
        {c:"ç¯®çƒ",u:"è¶³çƒ"},{c:"å‰ä»–",u:"å°¤å…‹é‡Œé‡Œ"},{c:"çŒ«",u:"ç‹—"},{c:"å¤ªé˜³",u:"æœˆäº®"},
        {c:"çˆ¬å±±",u:"æ¸¸æ³³"},{c:"ç”»ç”»",u:"ä¹¦æ³•"},{c:"é’¢ç´",u:"å°æç´"}
    ],
    custom: []
};

if(localStorage.getItem('customWords')) {
    wordBank.custom = JSON.parse(localStorage.getItem('customWords'));
}

let punishments = ["å”±ä¸€é¦–æƒ…æ­Œ","å­¦ä¸‰ç§åŠ¨ç‰©å«","åš10ä¸ªä¿¯å§æ’‘","è®²ä¸€ä¸ªå†·ç¬‘è¯","æ¨¡ä»¿ä¸€ä½æ˜æ˜Ÿ",
    "è¯´å‡ºä¸‰ä¸ªç§˜å¯†","ç»™é€šè®¯å½•ç¬¬3ä½å‘è¯­éŸ³","åŸåœ°è½¬5åœˆ","ç”¨å±è‚¡å†™å­—","è¡¨ç™½å¢™å£10ç§’",
    "å–ä¸€å£é†‹","åšé¬¼è„¸30ç§’","èƒŒä¸€é¦–å¤è¯—","è·³ä¸€æ®µèˆ","å¤§å£°å–Š'æˆ‘æ˜¯çŒª'ä¸‰æ¬¡",
    "åƒä¸€å£æŸ æª¬","è’™çœ¼è¸æ­¥20ç§’","ä¸å·¦è¾¹çš„äººå¯¹è§†10ç§’","å­¦æ¯é¸¡ä¸‹è›‹","èµç¾è‡ªå·±ä¸€åˆ†é’Ÿ"];
if(localStorage.getItem('punishments')) {
    punishments = JSON.parse(localStorage.getItem('punishments'));
}

let gameState = {
    phase:'home',players:[],currentPlayerIndex:0,round:1,words:{},
    useBlank:false,useTimer:true,timer:null,votes:{},eliminated:[],
    speechRecords:[],soundEnabled:true,nightMode:false
};

document.addEventListener('DOMContentLoaded',()=>{
    updateWordCount();
    document.getElementById('totalGames').textContent = localStorage.getItem('totalGames')||0;
    updateSetup();
});

function updateWordCount(){
    const total = wordBank.food.length+wordBank.daily.length+wordBank.ent.length+wordBank.custom.length;
    document.getElementById('wordCount').textContent = total;
}

function showScreen(id){
    ['homeScreen','setupScreen','dealingScreen','gameScreen','voteScreen','resultScreen','wordBankScreen','wheelScreen','historyScreen'].forEach(s=>{
        document.getElementById(s).classList.add('hidden');
    });
    document.getElementById(id).classList.remove('hidden');
}

function toggleSound(){
    gameState.soundEnabled=!gameState.soundEnabled;
    document.getElementById('soundBtn').textContent = gameState.soundEnabled?'ğŸ”Š':'ğŸ”‡';
}

function updateSetup(){
    const pc=parseInt(document.getElementById('playerCount').value);
    const uc=parseInt(document.getElementById('undercoverCount').value);
    document.getElementById('playerCountDisplay').textContent=pc+'äºº';
    document.getElementById('undercoverCountDisplay').textContent=uc+'äºº';
    
    const maxU=Math.floor((pc-(gameState.useBlank?1:0))/2);
    if(uc>maxU) document.getElementById('undercoverCount').value=maxU;
    
    const cc=pc-uc-(gameState.useBlank?1:0);
    document.getElementById('roleSummary').textContent = `${cc}å¹³æ°‘ vs ${uc}å§åº•${gameState.useBlank?' vs 1ç™½æ¿':''}`;
    
    const preview=document.getElementById('rolePreview');
    preview.innerHTML='';
    for(let i=0;i<cc;i++) preview.innerHTML+=`<span class="px-2 py-1 rounded bg-blue-500/20 text-blue-400 text-xs border border-blue-500/30">å¹³</span>`;
    for(let i=0;i<uc;i++) preview.innerHTML+=`<span class="px-2 py-1 rounded bg-purple-500/20 text-purple-400 text-xs border border-purple-500/30">å§</span>`;
    if(gameState.useBlank) preview.innerHTML+=`<span class="px-2 py-1 rounded bg-gray-500/20 text-gray-400 text-xs border border-gray-500/30">ç™½</span>`;
}

function toggleBlank(){
    gameState.useBlank=!gameState.useBlank;
    const btn=document.getElementById('blankToggle'),dot=btn.querySelector('div');
    if(gameState.useBlank){
        btn.classList.remove('bg-gray-700');btn.classList.add('bg-purple-600');
        dot.style.transform='translateX(24px)';
    }else{
        btn.classList.add('bg-gray-700');btn.classList.remove('bg-purple-600');
        dot.style.transform='translateX(0)';
    }
    updateSetup();
}

function toggleTimer(){
    gameState.useTimer=!gameState.useTimer;
    const btn=document.getElementById('timerToggle'),dot=btn.querySelector('div');
    if(gameState.useTimer){
        btn.classList.remove('bg-gray-700');btn.classList.add('bg-blue-600');
        dot.style.transform='translateX(24px)';
    }else{
        btn.classList.add('bg-gray-700');btn.classList.remove('bg-blue-600');
        dot.style.transform='translateX(0)';
    }
}

// å…³é”®ä¿®å¤ï¼šå‘ç‰Œæµç¨‹ç¡®ä¿ä¸æ³„éœ²ä¿¡æ¯
function startDealing(){
    const pc=parseInt(document.getElementById('playerCount').value);
    const uc=parseInt(document.getElementById('undercoverCount').value);
    
    gameState.players=[];
    for(let i=1;i<=pc;i++) gameState.players.push({id:i,name:`ç©å®¶${i}`,role:'civilian',word:'',alive:true});
    
    const roles=[];
    for(let i=0;i<pc-uc-(gameState.useBlank?1:0);i++) roles.push('civilian');
    for(let i=0;i<uc;i++) roles.push('undercover');
    if(gameState.useBlank) roles.push('blank');
    
    for(let i=roles.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [roles[i],roles[j]]=[roles[j],roles[i]];
    }
    
    const allWords=[...wordBank.food,...wordBank.daily,...wordBank.ent,...wordBank.custom];
    const wp=allWords[Math.floor(Math.random()*allWords.length)];
    gameState.words=wp;
    
    gameState.players.forEach((p,i)=>{
        p.role=roles[i];
        p.word = p.role==='civilian'?wp.civilian : p.role==='undercover'?wp.undercover : null;
    });
    
    gameState.currentPlayerIndex=0;
    gameState.speechRecords=[];
    showScreen('dealingScreen');
    updateDealingView();
}

function updateDealingView(){
    const card=document.getElementById('identityCard');
    card.classList.remove('flipped'); // ç¡®ä¿æ˜¯èƒŒé¢
    
    setTimeout(()=>{
        const p=gameState.players[gameState.currentPlayerIndex];
        document.getElementById('currentPlayerName').textContent=p.name;
        document.getElementById('dealingProgress').textContent=`ç¬¬ ${gameState.currentPlayerIndex+1} / ${gameState.players.length} ä½`;
        
        // å…³é”®ï¼šç»Ÿä¸€ä½¿ç”¨è“ç´«è‰²ï¼Œç»ä¸æš´éœ²èº«ä»½é¢œè‰²
        document.getElementById('roleIcon').textContent = p.role==='civilian'?'ğŸ‘¥':p.role==='undercover'?'ğŸ•µï¸':'ğŸƒ';
        document.getElementById('roleTitle').textContent = p.role==='civilian'?'å¹³æ°‘':p.role==='undercover'?'å§åº•':'ç™½æ¿';
        document.getElementById('roleWord').textContent = p.word||'?';
        document.getElementById('roleWord').style.opacity = p.word?'1':'0.3';
        document.getElementById('wordHint').textContent = p.role==='blank'?'é å¬æè¿°çŒœè¯':'è¯·è®°ä½è¿™ä¸ªè¯';
        document.getElementById('roleHint').textContent = p.role==='undercover'?'ä½ çš„è¯å’Œåˆ«äººä¸åŒï¼Œå°å¿ƒéšè—':p.role==='blank'?'ä½ æ²¡æœ‰è¯ï¼å¬åˆ«äººçš„æè¿°':'æè¿°è¿™ä¸ªè¯ï¼Œä½†ä¸è¦è¯´å‡ºæ¥';
        
        document.getElementById('nextPlayerBtn').classList.add('hidden');
        document.getElementById('startGameBtn').classList.add('hidden');
        document.getElementById('privacyShield').classList.remove('hidden');
    },300);
}

function hidePrivacyShield(){
    document.getElementById('privacyShield').classList.add('hidden');
}

function flipCard(el){
    if(el.classList.contains('flipped')) return;
    el.classList.add('flipped');
    if(navigator.vibrate) navigator.vibrate(50);
    
    const isLast=gameState.currentPlayerIndex===gameState.players.length-1;
    if(isLast) document.getElementById('startGameBtn').classList.remove('hidden');
    else document.getElementById('nextPlayerBtn').classList.remove('hidden');
}

function nextPlayer(){
    // å…³é”®ä¿®å¤ï¼šå…ˆç¿»å›ï¼Œå†æ˜¾ç¤ºé®ç½©ï¼Œå†æ›´æ–°æ•°æ®
    document.getElementById('identityCard').classList.remove('flipped');
    document.getElementById('privacyShield').classList.remove('hidden');
    
    setTimeout(()=>{
        gameState.currentPlayerIndex++;
        if(gameState.currentPlayerIndex<gameState.players.length){
            updateDealingView();
        }
    },600);
}

function startPlaying(){
    showScreen('gameScreen');
    gameState.phase='playing';
    gameState.round=1;
    gameState.currentPlayerIndex=0;
    updateGameView();
    if(gameState.useTimer) startTimer(60);
}

function updateGameView(){
    const alive=gameState.players.filter(p=>p.alive);
    const curr=alive[gameState.currentPlayerIndex%alive.length];
    if(!curr) return;
    
    document.getElementById('roundNumber').textContent=gameState.round;
    document.getElementById('speakerName').textContent=curr.name;
    document.getElementById('speakerAvatar').textContent=curr.id;
    document.getElementById('aliveCount').textContent=`å­˜æ´» ${alive.length}/${gameState.players.length}`;
    
    // ç™½æ¿æŒ‰é’®æ˜¾éš
    document.getElementById('blankGuessBtn').classList.toggle('hidden', curr.role!=='blank');
    
    // ç©å®¶ç½‘æ ¼
    const grid=document.getElementById('playerGrid');
    grid.innerHTML='';
    gameState.players.forEach(p=>{
        if(!p.alive) return;
        const div=document.createElement('div');
        div.className='flex flex-col items-center gap-1 p-2 rounded-xl hover:bg-white/5 cursor-pointer transition-all';
        div.onclick=()=>{if(gameState.phase==='voting') castVote(p.id);};
        div.innerHTML=`
            <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center font-bold shadow-lg ${gameState.votes[p.id]?'ring-4 ring-yellow-400':''}">${p.id}</div>
            <div class="text-xs text-gray-400 truncate w-full text-center">${p.name}</div>
        `;
        grid.appendChild(div);
    });
    
    updateSpeechRecords();
}

function startTimer(s){
    if(!gameState.useTimer){document.getElementById('timerSection').classList.add('hidden');return;}
    document.getElementById('timerSection').classList.remove('hidden');
    let r=s;
    const bar=document.getElementById('timerBar'),txt=document.getElementById('timerText');
    if(gameState.timer) clearInterval(gameState.timer);
    bar.style.width='100%';
    bar.className='h-full bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-1000';
    
    gameState.timer=setInterval(()=>{
        r--;
        bar.style.width=(r/s*100)+'%';
        txt.textContent=r;
        if(r<=10){
            bar.classList.remove('from-blue-500','to-purple-500');
            bar.classList.add('bg-red-500');
            if(navigator.vibrate&&r%2===0) navigator.vibrate(30);
        }
        if(r<=0){
            clearInterval(gameState.timer);
            if(navigator.vibrate) navigator.vibrate([100,50,100]);
        }
    },1000);
}

function nextSpeaker(){
    if(gameState.timer) clearInterval(gameState.timer);
    const alive=gameState.players.filter(p=>p.alive);
    gameState.currentPlayerIndex++;
    if(gameState.currentPlayerIndex>=alive.length){
        gameState.currentPlayerIndex=0;
        startVoting();
    }else{
        updateGameView();
        if(gameState.useTimer) startTimer(60);
    }
}

// è®°å½•ç³»ç»Ÿ
function addSpeechRecord(){
    document.getElementById('recordModal').classList.remove('hidden');
    document.getElementById('speechContent').value='';
    document.getElementById('speechContent').focus();
}
function closeRecordModal(){document.getElementById('recordModal').classList.add('hidden');}
function saveSpeechRecord(){
    const c=document.getElementById('speechContent').value.trim();
    if(!c) return;
    gameState.speechRecords.push({
        round:gameState.round,
        speaker:document.getElementById('speakerName').textContent,
        content:c,
        time:new Date().toLocaleTimeString()
    });
    updateSpeechRecords();
    closeRecordModal();
}
function updateSpeechRecords(){
    const c=document.getElementById('speechRecords');
    if(gameState.speechRecords.length===0){
        c.innerHTML='<div class="text-center text-sm text-gray-500 py-4">æš‚æ— è®°å½•ï¼Œç‚¹å‡»ä¸‹æ–¹æ·»åŠ çº¿ç´¢</div>';
        return;
    }
    c.innerHTML=gameState.speechRecords.map(r=>`
        <div class="speech-bubble glass-panel rounded-lg p-3 text-sm border-l-4 border-blue-500 mb-2">
            <div class="flex justify-between text-xs text-gray-500 mb-1">
                <span class="font-bold text-blue-400">ç¬¬${r.round}è½® ${r.speaker}</span>
            </div>
            <div class="text-gray-200">${r.content}</div>
        </div>
    `).join('');
    c.scrollTop=c.scrollHeight;
}
function clearRecords(){
    if(confirm('æ¸…ç©ºæ‰€æœ‰è®°å½•ï¼Ÿ')){
        gameState.speechRecords=[];
        updateSpeechRecords();
    }
}

// ç™½æ¿çŒœè¯
function showBlankGuessModal(){document.getElementById('blankGuessModal').classList.remove('hidden');}
function closeBlankGuessModal(){document.getElementById('blankGuessModal').classList.add('hidden');}
function confirmBlankGuess(){
    const w1=document.getElementById('guessWord1').value.trim();
    const w2=document.getElementById('guessWord2').value.trim();
    if(!w1||!w2){alert('è¯·å¡«ä¸¤ä¸ªè¯');return;}
    const words=[gameState.words.civilian,gameState.words.undercover].sort();
    const guesses=[w1,w2].sort();
    if(guesses[0]===words[0]&&guesses[1]===words[1]){
        alert('ğŸ‰ ç™½æ¿çŒœå¯¹äº†ï¼ç™½æ¿è·èƒœï¼');
        showResult('blank','ç™½æ¿çŒœå‡ºåŒè¯');
    }else{
        alert(`âŒ é”™è¯¯ï¼æ­£ç¡®æ˜¯ï¼š${gameState.words.civilian} å’Œ ${gameState.words.undercover}`);
        closeBlankGuessModal();
    }
}

// æŠ•ç¥¨ç³»ç»Ÿ
function startVoting(){
    if(gameState.timer) clearInterval(gameState.timer);
    gameState.phase='voting';
    gameState.votes={};
    showScreen('voteScreen');
    const alive=gameState.players.filter(p=>p.alive);
    const grid=document.getElementById('voteGrid');
    grid.innerHTML='';
    alive.forEach(p=>{
        const btn=document.createElement('button');
        btn.className='flex flex-col items-center gap-2 p-4 rounded-2xl glass-panel hover:bg-white/10 active:scale-95 transition-all';
        btn.onclick=()=>castVote(p.id);
        btn.innerHTML=`
            <div class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-2xl font-bold shadow-lg">${p.id}</div>
            <div class="font-bold">${p.name}</div>
            <div class="text-xs text-gray-500">ç‚¹å‡»æŠ•ç¥¨</div>
        `;
        grid.appendChild(btn);
    });
}

function castVote(targetId){
    // æ¨¡æ‹ŸæŠ•ç¥¨è¿‡ç¨‹
    const alive=gameState.players.filter(p=>p.alive);
    const votes={};
    alive.forEach(p=>votes[p.id]=0);
    
    // ç®€å•æ¨¡æ‹Ÿï¼šç›®æ ‡å¾—ç¥¨é«˜
    alive.forEach(p=>{
        if(p.id!==targetId){
            if(Math.random()>0.4) votes[targetId]++;
            else{
                const other=alive[Math.floor(Math.random()*alive.length)];
                if(other.id!==p.id) votes[other.id]++;
            }
        }
    });
    
    let max=0,out=null;
    for(let id in votes){
        if(votes[id]>max){max=votes[id];out=gameState.players.find(p=>p.id===parseInt(id));}
    }
    
    if(out){
        out.alive=false;
        gameState.eliminated.push(out);
        const rt=out.role==='civilian'?'å¹³æ°‘':out.role==='undercover'?'å§åº•':'ç™½æ¿';
        const icon=out.role==='civilian'?'ğŸ‘¥':out.role==='undercover'?'ğŸ•µï¸':'ğŸƒ';
        alert(`${out.name} è¢«æ·˜æ±°ï¼\n\n${icon} èº«ä»½ï¼š${rt}\nğŸ“ è¯è¯­ï¼š${out.word||'ç™½æ¿æ— è¯'}\n\næ¸¸æˆç»§ç»­...`);
    }
    
    if(!checkWin()){
        gameState.round++;
        gameState.phase='playing';
        gameState.currentPlayerIndex=0;
        showScreen('gameScreen');
        updateGameView();
        if(gameState.useTimer) startTimer(60);
    }
}

function checkWin(){
    const alive=gameState.players.filter(p=>p.alive);
    const civ=alive.filter(p=>p.role==='civilian').length;
    const und=alive.filter(p=>p.role==='undercover').length;
    
    if(und===0){showResult('civilian','å§åº•å…¨ç­');return true;}
    if(und>=civ){showResult('undercover','å§åº•äººæ•°â‰¥å¹³æ°‘');return true;}
    return false;
}

function showResult(winner,reason){
    showScreen('resultScreen');
    document.getElementById('resultTitle').textContent=winner==='civilian'?'å¹³æ°‘èƒœåˆ©ï¼':winner==='undercover'?'å§åº•èƒœåˆ©ï¼':'ç™½æ¿èƒœåˆ©ï¼';
    document.getElementById('resultTitle').className=winner==='civilian'?'text-4xl font-black mb-2 text-green-400':winner==='undercover'?'text-4xl font-black mb-2 text-red-400':'text-4xl font-black mb-2 text-purple-400';
    document.getElementById('resultEmoji').textContent=winner==='civilian'?'ğŸ‰':winner==='undercover'?'ğŸ•µï¸':'ğŸƒ';
    document.getElementById('resultDesc').textContent=reason;
    document.getElementById('resultCivilianWord').textContent=gameState.words.civilian;
    document.getElementById('resultUndercoverWord').textContent=gameState.words.undercover;
    
    const list=document.getElementById('resultList');
    list.innerHTML='';
    gameState.players.forEach(p=>{
        const rc=p.role==='civilian'?'text-green-400':p.role==='undercover'?'text-red-400':'text-purple-400';
        const rt=p.role==='civilian'?'å¹³æ°‘':p.role==='undercover'?'å§åº•':'ç™½æ¿';
        list.innerHTML+=`
            <div class="flex items-center justify-between p-3 rounded-xl bg-white/5">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full ${p.alive?'bg-gradient-to-br from-blue-500 to-purple-500':'bg-gray-700 grayscale'} flex items-center justify-center font-bold">${p.id}</div>
                    <div class="${p.alive?'':'opacity-50 line-through'}">
                        <div class="font-bold">${p.name}</div>
                        <div class="text-xs text-gray-500">${p.word||'ç™½æ¿'}</div>
                    </div>
                </div>
                <div class="${rc} font-bold text-sm">${rt}</div>
            </div>
        `;
    });
    
    // ä¿å­˜å†å²
    let h=JSON.parse(localStorage.getItem('gameHistory')||'[]');
    h.unshift({date:new Date().toLocaleString(),winner:winner,words:gameState.words,playerCount:gameState.players.length,round:gameState.round});
    if(h.length>20)h=h.slice(0,20);
    localStorage.setItem('gameHistory',JSON.stringify(h));
    localStorage.setItem('totalGames',(parseInt(localStorage.getItem('totalGames')||0)+1).toString());
}

// è¯åº“ç®¡ç†
function showWordBank(){showScreen('wordBankScreen');renderWordList('all');}
function renderWordList(cat){
    const list=document.getElementById('wordList');
    list.innerHTML='';
    let words=[];
    if(cat==='all') words=[...wordBank.food,...wordBank.daily,...wordBank.ent,...wordBank.custom];
    else words=wordBank[cat];
    
    words.forEach((p,i)=>{
        list.innerHTML+=`
            <div class="glass-panel rounded-xl p-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="text-xl">ğŸ†š</div>
                    <div>
                        <div class="text-green-400 font-bold">${p.civilian}</div>
                        <div class="text-red-400 font-bold">${p.undercover}</div>
                    </div>
                </div>
                ${cat==='custom'?`<button onclick="deleteWord(${i})" class="text-red-400 text-sm">åˆ é™¤</button>`:''}
            </div>
        `;
    });
    if(words.length===0) list.innerHTML='<div class="text-center text-gray-500 py-8">æš‚æ— è¯è¯­</div>';
}
function filterWords(cat,btn){
    document.querySelectorAll('#categoryTabs button').forEach(b=>{
        b.classList.remove('bg-blue-600','font-bold');
        b.classList.add('bg-white/10');
    });
    btn.classList.remove('bg-white/10');
    btn.classList.add('bg-blue-600','font-bold');
    renderWordList(cat);
}
function showAddWordModal(){document.getElementById('addWordModal').classList.remove('hidden');}
function closeAddWordModal(){document.getElementById('addWordModal').classList.add('hidden');}
function confirmAddWord(){
    const c=document.getElementById('newCivilianWord').value.trim();
    const u=document.getElementById('newUndercoverWord').value.trim();
    if(!c||!u){alert('è¯·å¡«å†™ä¸¤ä¸ªè¯');return;}
    wordBank.custom.push({civilian:c,undercover:u});
    localStorage.setItem('customWords',JSON.stringify(wordBank.custom));
    updateWordCount();
    closeAddWordModal();
    renderWordList('custom');
    document.getElementById('newCivilianWord').value='';
    document.getElementById('newUndercoverWord').value='';
}
function deleteWord(i){
    if(confirm('åˆ é™¤ï¼Ÿ')){
        wordBank.custom.splice(i,1);
        localStorage.setItem('customWords',JSON.stringify(wordBank.custom));
        renderWordList('custom');
        updateWordCount();
    }
}

// æƒ©ç½šè½¬ç›˜
function showPunishmentWheel(){showScreen('wheelScreen');renderWheel();}
function renderWheel(){
    const w=document.getElementById('rouletteWheel');
    w.innerHTML='';
    const count=punishments.length,angle=360/count;
    const colors=['#ef4444','#dc2626','#b91c1c','#f87171'];
    punishments.forEach((p,i)=>{
        const s=document.createElement('div');
        s.className='roulette-segment';
        s.style.transform=`rotate(${i*angle}deg)`;
        s.style.backgroundColor=colors[i%4];
        s.style.clipPath='polygon(0 0, 100% 0, 100% 100%)';
        s.innerHTML=`<span style="transform:rotate(${angle/2}deg);position:absolute;right:10px;top:10px;font-size:10px;">${p.substring(0,3)}</span>`;
        w.appendChild(s);
    });
}
function spinWheel(){
    const w=document.getElementById('rouletteWheel');
    document.getElementById('punishmentResult').classList.add('hidden');
    const rot=1800+Math.random()*1800;
    w.style.transform=`rotate(${rot}deg)`;
    if(navigator.vibrate){
        let c=0;
        const iv=setInterval(()=>{navigator.vibrate(50);c++;if(c>15)clearInterval(iv);},150);
    }
    setTimeout(()=>{
        const f=rot%360,seg=360/punishments.length,idx=Math.floor((360-f)/seg)%punishments.length;
        document.getElementById('punishmentText').textContent=punishments[idx];
        document.getElementById('punishmentResult').classList.remove('hidden');
        if(navigator.vibrate) navigator.vibrate([100,50,200]);
    },4000);
}
function customizePunishments(){
    const np=prompt('è‡ªå®šä¹‰æƒ©ç½šï¼ˆç”¨é€—å·åˆ†éš”ï¼‰ï¼š',punishments.join('ï¼Œ'));
    if(np){
        punishments=np.split(/[,ï¼Œ]/).map(p=>p.trim()).filter(p=>p);
        localStorage.setItem('punishments',JSON.stringify(punishments));
        document.getElementById('punishCount').textContent=punishments.length;
        renderWheel();
    }
}

// å†å²è®°å½•
function showHistory(){
    showScreen('historyScreen');
    const list=document.getElementById('historyList');
    const h=JSON.parse(localStorage.getItem('gameHistory')||'[]');
    if(h.length===0){list.innerHTML='<div class="text-center text-gray-500 py-12">æš‚æ— è®°å½•</div>';return;}
    list.innerHTML=h.map(item=>{
        const wc=item.winner==='civilian'?'text-green-400':item.winner==='undercover'?'text-red-400':'text-purple-400';
        const wt=item.winner==='civilian'?'å¹³æ°‘èƒœ':item.winner==='undercover'?'å§åº•èƒœ':'ç™½æ¿èƒœ';
        return`
            <div class="glass-panel rounded-xl p-4 border-l-4 ${item.winner==='civilian'?'border-green-500':item.winner==='undercover'?'border-red-500':'border-purple-500'}">
                <div class="flex justify-between text-xs text-gray-500 mb-1"><span>${item.date}</span><span class="${wc} font-bold">${wt}</span></div>
                <div class="flex justify-between text-sm"><span class="text-green-400">${item.words.civilian}</span> vs <span class="text-red-400">${item.words.undercover}</span></div>
                <div class="text-xs text-gray-600 mt-1">${item.playerCount}äºº Â· ${item.round}è½®</div>
            </div>
        `;
    }).join('');
}

function toggleNightMode(){
    gameState.nightMode=!gameState.nightMode;
    document.body.style.filter=gameState.nightMode?'brightness(0.7) sepia(0.2)':'';
}

function showMenu(){
    if(gameState.phase==='home'){
        const c=prompt('é€‰æ‹©åŠŸèƒ½ï¼š\n1.æƒ©ç½šè½¬ç›˜\n2.è¯åº“ç®¡ç†\n3.å†å²è®°å½•\n4.å…³äº\n\nè¾“å…¥æ•°å­—ï¼š');
        if(c==='1') showPunishmentWheel();
        else if(c==='2') showWordBank();
        else if(c==='3') showHistory();
        else if(c==='4') alert('è°æ˜¯å§åº•PRO MAX\n\nç‰¹è‰²ï¼š\nâœ“ é˜²çª¥å±éšç§ä¿æŠ¤\nâœ“ 47ç»„ç²¾é€‰è¯åº“\nâœ“ ç»Ÿä¸€è§†è§‰æ— é¢œè‰²æ³„éœ²\nâœ“ ç™½æ¿çŒœè¯æœºåˆ¶\nâœ“ å‘è¨€è®¡æ—¶+è®°å½•æ¿\nâœ“ æƒ©ç½šè½¬ç›˜\nâœ“ æœ¬åœ°æ•°æ®ä¿å­˜');
    }else{
        if(confirm('ç»“æŸå½“å‰æ¸¸æˆï¼Ÿ')) location.reload();
    }
}

window.onbeforeunload=e=>{
    if(gameState.phase!=='home'&&gameState.phase!=='result') return'æ¸¸æˆè¿›è¡Œä¸­ï¼Œç¡®å®šç¦»å¼€ï¼Ÿ';
};
</script>

</body>
</html>
