<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAABJRJREFUaAXtWl1oHFUU/ubOzG6y+bFJU9PabjVqW0Kb2lYfFF8q+ocPgg8qUhF8E0TwTfDVB0F88UURfBMEH0SwiIJaK4hUoYpUq7bammqjJlbbzSZ/dnZn7j3eTGeT7M7szk6Spt3MDmfm3vOde8/5zrnnzh1B+v8/wI3OgL5eT0dHR1sQBHcR4g4hRIfruhO+77+7sLCw10oFy7KkEMJ2XVe6rvvQcZxhz/PemZube7lWgX8TQCnlCiF2iYj3cxyHLMv6FdE/AxgwTfMHIcTnAB6rFsCrwSdOnHh7amqKUq2CQogHIpHIW4jY09XVdePy5cs3l5eXf7Is66Druu90d3d/aFnWwZqMIyKapiGEkLu7u3lqamp4dnZ2pR4B0zQ7Y7HYa0KI9yORyNuLi4sf1iPwYJ7ne71e7yWUZtN1TZNSMpRSWq3WcU3T+i3L6vM8b9hxnPdM0/y2LgFVVBRFsixr0LIsIqU8tLS09K2uaeLxeA8A5sMwfElKeT0ejz+vaRo5jjNtmub3UsqXLMt6NRaLfRcEwZCU8gkhRDyKIrqua6ytrS1JKQ90dnY+AeBgZ2fn72tra5+GYTiN+RzXdb21tbWtMAz7ARBd1xVC3G5Z1r2+74/7vv+ObdufY24bUsoH6+npWq32hBDiHV3XH7Bt+2Pbtr+0LOtV3/cf7ejoOIT5mD3Pe29lZeUcEW0LITaLiDpN05zLZrPPr6+vj2Wz2TtVK8dxHrBt+8MwDJ8uFApfhGH4uB8FiOg2y7I+9X3/RSEEccbzvKc0Tbs4Pj7+uK7r90ej0eemaTo3Go0+L6V8iYh2CiFUIQS5rns2k8m8lM/nv6oVYI1Go3s1TXvH8/0XpJTfBkHwnBJCpNNpAqAghMjn8/kZx3G2EdEVIYSIx+MfWJb1MhH9QUR7hBA3BUEgHMc5WywWn9c0bUcqlXqAiG4lovV8Pr84Pz+/X/XadV3HNE1vWJb1hRBiN4D9RJRKp9PJcrk8n8lkxizL+pCIdgG4FcC5fD7/c7FYfIuI7lYBrq+vu7lc7rjv++9IKQ8KIe4RQtxy6dKlP4loP5G2pqgUJ5PJD0zTfIEo2gfgPcdxTpXL5e+I6GEhxP1EdE++UPh9eXl5C4BtoVCYATBJRAc8z/uUiG4jor0A7iqXy8cBHCWiCQBRgB4EQTIajW4zDON5AJ8A8Ilom4huI6J7i8Xix0S0bZ3IC4cAiFzX3Y+y/IWIJgDcqqqqVCo1IqX8DcBdAPYCOCqlvCSEGAbwNBFtBxEBEEopwvf9y0T0F4CDAI4R0SSA4Q2T1g2wWq0fIqJ9AF4F8BQRHZZSHi0UCu9EItGdUsoT4+Pjj5dKpXOlUukr0zQfI6IHieiWUqn0t+u6h5aWlt7SNK1DRLQQQkQi2lAqldYBTBQKhbFUKtVpmuYxIcRbvu8/SUQHI5FIz3q5fGJubm5scnLyL4Tw9P9z4f/lE+t/bW1tP5im+Vh3d/fNqVTq40QisY+I9hJRh+/7Qkq5Oj09PT0xMfGT67qG67rC9/2bTdMcKhaLr5ZKpZMi4nqJ4g/8A2G8ln2U1IMUAAAAAElFTkSuQmCC">
    <link rel="manifest" href="data:application/manifest+json,%7B%22name%22%3A%22%E8%8F%8C%E8%90%BD%E8%AE%A1%E6%95%B0%E5%99%A8%22%2C%22short_name%22%3A%22%E8%8F%8C%E8%90%BD%E8%AE%A1%E6%95%B0%22%2C%22start_url%22%3A%22.%2F%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%230f172a%22%2C%22theme_color%22%3A%22%233b82f6%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage%2Fpng%3Bbase64%2CiVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAAXNSR0IArs4c6QAABJRJREFUaAXtWl1oHFUU%2FubOzG6y%2BbFJU9PabjVqW0Kb2lYfFF8q%2BocPgg8qUhF8E0TwTfDVB0F88UURfBMEH0SwiIJaK4hUoYpUq7bammqjJlbbzSZ%2FdnZn7j3eTGeT7M7szk6Spt3MDmfm3vOde8%2F5zrnnzh1B%2Bv8%2FwI3OgL5eT0dHR1sQBHcR4g4hRIfruhO%2B77%2B7sLCw10oFy7KkEMJ2Xek6rvvQcZxhz%2FPemZube7lWgX8TQCnlCiF2iYj3cxyHLMv6FdE%2FAxgwTfMHIcTnAB6rFsCrwSdOnHh7amqKUq2CQogHIpHIW4jY09XVdePy5cs3l5eXf7Is66Druu90d3d%2FaFnWwZqMIyKapiGEkLu7u3lqamp4dnZ2pR4B0zQ7Y7HYa0KI9yORyNuLi4sf1iPwYJ7ne71e7yWUZtN1TZNSMpRSWq3WcU3T%2Bi3L6vM8b9hxnPdM0%2Fy2LgFVVBRFsixr0LIsIqU8tLS09K2uaeLxeA8A5sMwfElKeT0ejz%2BvaRo5jjNtmub3UsqXLMt6NRaLfRcEwZCU8gkhRDyKIrqua6ytrS1JKQ90dnY%2BAOBgZ2fn72tra5%2BGYTiN%2BRzXdb21tbWtMAz7ARBd1xVC3G5Z1r2%2B74%2F7vv%2BObdufY24bUsoH6%2BnpWq32hBDiHV3XH7Bt%2B2Pbtr%2B0LOtV3%2Fcf7ejoOIT5mD3Pe29lZeUcEW0LITaLiDpN05zLZrPPr6%2Bvj2Wz2TtVK8dxHrBt%2B8MwDJ8uFApfhGH4uB8FiOg2y7I%2B9X3%2FUOcc8ZznPOX7%2FosLCwv7RURE0zRyHGe6UCg8L6V8iYh2CiFUIQS5rns2k8m8lM%2Fnv6oVYI1Go3s1TXvH8%2F0XpJTfBkHwnBJCpNNpAqAghMjn8%2FkZx3G2EdEVIYSIx%2BMfWJb1MhH9QUR7hBA3BUEgHMc5WywWn9c0bUcqlXqAiG4lovV8Pr84Pz%2B%2FX%2FXadV3HNE1vWJb1hRBiN4D9RJRKp9PJcrk8n8lkxizL%2BpCI9iSTyU1BEJwrFosfEdHdKsD19XU3l8sd933%2FHSnlQSHEPUKIWy5duvQnEe0n0tYUFVKKk8nkB6ZpvoA5eM9xnFPlcvk7InpYCHG%2FEGJvvpD%2FfXl5eQuALaFQmAEwSUQHPM%2F7lIhuI6K9AO4ql8vHARwlogkAUYAeBEEyGo1uMwzjeQCfAPCJaJuIbiOie4vF4sdEtG2dyAuHAIhc192PsvyFiCYAvB0EwbsLCwsHgs3P7wC2E9FeAEeJ6BIREXme9z4R%2FQXgIICjRDRJRDvXJ40NMFqt1g8R0T4ArwJ4iohmy%2BXy0VKp9I7v%2Bw8T0aNEtK1cLv%2FtOM6hpaWltzRN6xARLVEUQUp5pFQqjQOYKBQKY6lUqtM0zWNCiLd833%2BSiA5GIpGe9XL5xNzc3Njk5ORfGMLT%2F8%2BFPwF8Yv1vbW3tB9M0H%2Bvu7r45lUp9nEgk9hHRXiLq8H1fSClXp6enpycmJn5yXddwXVf4vn%2BzaZpDxWLx1VKpdFJEXC9R%2FIF%2FAOW1nvZU6DcAAAAAAElFTkSuQmCC%22%2C%22sizes%22%3A%2248x48%2072x72%2096x96%20128x128%20144x144%20152x152%20192x192%20256x256%20512x512%22%2C%22type%22%3A%22image%2Fpng%22%7D%5D%7D">
    <title>èŒè½è®¡æ•°å™¨ Â· YOLOv8.4</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.20.1/dist/ort.min.js"></script>
    <style>
        /* æ­¤å¤„çœç•¥éƒ¨åˆ† CSS ä»¥èŠ‚çœç©ºé—´ï¼Œå®é™…ä½¿ç”¨æ—¶å¯ä»åŸå›ç­”å®Œæ•´å¤åˆ¶ï¼Œæˆ–ç›´æ¥ä½¿ç”¨åŸè®¾è®¡çš„å®Œæ•´æ ·å¼ */
        :root { --primary: #3b82f6; --primary-dark: #1d4ed8; --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --text-muted: #94a3b8; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        .splash { position: fixed; inset: 0; background: linear-gradient(135deg, #1e3a8a 0%, #0f172a 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s; }
        .splash.hidden { opacity: 0; pointer-events: none; }
        .splash-icon { font-size: 100px; margin-bottom: 20px; animation: bounce 2s infinite; }
        @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-20px)} }
        .model-selector { background: var(--card); border-radius: 12px; padding: 20px; max-width: 500px; width: 90%; }
        .model-option { display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg); border-radius: 8px; margin-bottom: 10px; cursor: pointer; border: 2px solid transparent; }
        .model-option.selected { border-color: var(--primary); background: rgba(59, 130, 246, 0.1); }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 0.95rem; font-weight: 600; cursor: pointer; background: var(--primary); color: white; }
        .app { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .upload-card { background: var(--card); border-radius: 24px; padding: 40px; text-align: center; border: 2px dashed var(--primary); cursor: pointer; margin-top: 20px; }
        .viewer { display: none; }
        .viewer.active { display: block; }
        canvas { width: 100%; height: auto; background: #1e293b; border-radius: 12px; }
        .stats-panel { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 20px; }
        .stat-box { background: var(--card); border-radius: 16px; padding: 20px; text-align: center; }
        .stat-number { font-size: 2rem; font-weight: 700; color: var(--primary); }
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--card); color: white; padding: 12px 24px; border-radius: 8px; opacity: 0; transition: opacity 0.3s; }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>
    <!-- å¯åŠ¨ç”»é¢/æ¨¡å‹é€‰æ‹© -->
    <div class="splash" id="splash">
        <div class="splash-icon">ğŸ”¬</div>
        <div class="model-selector">
            <h3 style="margin-bottom: 15px; text-align: center;">ğŸ“¦ YOLOv8.4 èŒè½è®¡æ•°</h3>
            <div class="model-option selected" onclick="selectSource('url')" id="optUrl">
                <span>ğŸŒ</span><span>è‡ªåŠ¨åŠ è½½ï¼ˆæ¨èï¼‰</span>
            </div>
            <div class="model-option" onclick="selectSource('local')" id="optLocal">
                <span>ğŸ’»</span><span>æœ¬åœ°ä¸Šä¼  .onnx</span>
            </div>
            <div class="model-option" onclick="selectSource('cv')" id="optCv">
                <span>âš™ï¸</span><span>ä¼ ç»Ÿ CV æ¨¡å¼ï¼ˆæ— éœ€æ¨¡å‹ï¼‰</span>
            </div>
            <button class="btn" style="width: 100%; margin-top: 15px;" onclick="confirmSource()">å¼€å§‹</button>
            <input type="file" id="modelFile" accept=".onnx" style="display: none;">
        </div>
    </div>

    <div class="app">
        <header style="text-align: center; margin-bottom: 20px;">
            <h1>ğŸ”¬ èŒè½è®¡æ•°å™¨ Â· YOLOv8.4</h1>
            <p id="modelStatus">â³ ç­‰å¾…æ¨¡å‹...</p>
        </header>

        <!-- ä¸Šä¼ åŒºåŸŸ -->
        <div class="upload-card" id="uploadCard" onclick="document.getElementById('imageInput').click()">
            <div style="font-size: 48px;">ğŸ“¸</div>
            <h2>ç‚¹å‡»æ‹ç…§æˆ–é€‰æ‹©å›¾ç‰‡</h2>
            <p style="color: var(--text-muted); margin: 10px 0;">æ”¯æŒ JPG/PNG/WEBP</p>
            <input type="file" id="imageInput" accept="image/*" capture="environment" style="display: none;">
        </div>

        <!-- åˆ†æè§†å›¾ -->
        <div class="viewer" id="viewer">
            <div style="position: relative;">
                <canvas id="mainCanvas"></canvas>
                <div id="overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></div>
            </div>

            <div class="stats-panel">
                <div class="stat-box"><span class="stat-number" id="totalCount">0</span><div>æ€»èŒè½</div></div>
                <div class="stat-box"><span class="stat-number" id="autoCount">0</span><div>è‡ªåŠ¨æ£€æµ‹</div></div>
                <div class="stat-box"><span class="stat-number" id="manualCount">0</span><div>æ‰‹åŠ¨æ·»åŠ </div></div>
                <div class="stat-box"><span class="stat-number" id="avgRadius">0</span><div>å¹³å‡åŠå¾„</div></div>
            </div>

            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px;">
                <button class="btn" id="analyzeBtn">ğŸ”„ é‡æ–°åˆ†æ</button>
                <button class="btn" id="addBtn">â• æ‰‹åŠ¨æ·»åŠ </button>
                <button class="btn" id="exportBtn">ğŸ“¥ å¯¼å‡ºå›¾ç‰‡</button>
                <button class="btn" id="resetBtn">â†©ï¸ æ–°å›¾ç‰‡</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ---------- PWA Service Worker æ³¨å†Œ ----------
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // å†…è” Service Worker (ä¸ºäº†å•æ–‡ä»¶éƒ¨ç½²ï¼Œç›´æ¥æ³¨å†Œä¸€ä¸ªç®€å• SW)
                const swScript = `
                    const CACHE_NAME = 'colony-counter-v1';
                    const urlsToCache = [
                        './',
                        'https://cdn.jsdelivr.net/npm/onnxruntime-web@1.20.1/dist/ort.min.js'
                    ];
                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache))
                        );
                    });
                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request).then(response => response || fetch(event.request))
                        );
                    });
                `;
                const blob = new Blob([swScript], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                navigator.serviceWorker.register(swUrl).then(reg => {
                    console.log('Service Worker registered');
                    URL.revokeObjectURL(swUrl);
                }).catch(err => console.log('SW registration failed', err));
            });
        }

        // ---------- å…¨å±€å˜é‡ ----------
        let session = null;
        let useYOLO = false;
        let currentSource = 'url';
        let currentImage = null;
        let colonies = [];
        let isAddMode = false;

        // YOLOv8.4 æ¨¡å‹åœ°å€ (Ultralytics å®˜æ–¹ v8.4.0 å‘å¸ƒç‰ˆ)
        const MODEL_URL = 'https://github.com/ultralytics/assets/releases/download/v8.4.0/yolov8n.onnx';

        // ---------- æ¨¡å‹é€‰æ‹© ----------
        window.selectSource = (src) => {
            currentSource = src;
            document.querySelectorAll('.model-option').forEach(el => el.classList.remove('selected'));
            document.getElementById(`opt${src.charAt(0).toUpperCase() + src.slice(1)}`).classList.add('selected');
        };

        window.confirmSource = async () => {
            if (currentSource === 'cv') {
                useYOLO = false;
                document.getElementById('splash').classList.add('hidden');
                showToast('âœ… ä¼ ç»ŸCVæ¨¡å¼');
                updateModelStatus('ä¼ ç»ŸCVæ¨¡å¼');
                return;
            }

            if (currentSource === 'local') {
                document.getElementById('modelFile').click();
                return;
            }

            // URL åŠ è½½
            document.getElementById('splash').classList.add('hidden');
            await loadModelFromUrl();
        };

        // å¤„ç†æœ¬åœ°æ–‡ä»¶é€‰æ‹©
        document.getElementById('modelFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('splash').classList.add('hidden');
            await loadModelFromFile(file);
        });

        async function loadModelFromUrl() {
            showToast('â³ ä¸‹è½½æ¨¡å‹ (çº¦6MB)...');
            try {
                const response = await fetch(MODEL_URL);
                if (!response.ok) throw new Error('ä¸‹è½½å¤±è´¥');
                const buffer = await response.arrayBuffer();
                await initSession(buffer);
                showToast('âœ… YOLOv8.4 æ¨¡å‹åŠ è½½æˆåŠŸ');
            } catch (err) {
                console.error(err);
                showToast('âŒ æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨CVæ¨¡å¼');
                useYOLO = false;
            }
            updateModelStatus(useYOLO ? 'YOLOv8.4 å°±ç»ª' : 'ä¼ ç»ŸCVæ¨¡å¼');
        }

        async function loadModelFromFile(file) {
            showToast('â³ åŠ è½½æœ¬åœ°æ¨¡å‹...');
            try {
                const buffer = await file.arrayBuffer();
                await initSession(buffer);
                showToast(`âœ… å·²åŠ è½½: ${file.name}`);
            } catch (err) {
                console.error(err);
                showToast('âŒ æ¨¡å‹æ— æ•ˆï¼Œä½¿ç”¨CVæ¨¡å¼');
                useYOLO = false;
            }
            updateModelStatus(useYOLO ? 'YOLOv8.4 å°±ç»ª' : 'ä¼ ç»ŸCVæ¨¡å¼');
        }

        async function initSession(buffer) {
            session = await ort.InferenceSession.create(buffer, {
                executionProviders: ['wasm'],
                graphOptimizationLevel: 'all'
            });
            useYOLO = true;
        }

        function updateModelStatus(text) {
            document.getElementById('modelStatus').innerHTML = useYOLO ? `âœ… ${text}` : `âš™ï¸ ${text}`;
        }

        // ---------- å›¾ç‰‡å¤„ç† ----------
        document.getElementById('imageInput').addEventListener('change', (e) => {
            if (e.target.files.length) loadImage(e.target.files[0]);
        });

        function loadImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    currentImage = img;
                    document.getElementById('uploadCard').style.display = 'none';
                    document.getElementById('viewer').classList.add('active');
                    drawImage();
                    analyze();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function drawImage() {
            const canvas = document.getElementById('mainCanvas');
            canvas.width = currentImage.width;
            canvas.height = currentImage.height;
            canvas.getContext('2d').drawImage(currentImage, 0, 0);
        }

        // ---------- åˆ†æå…¥å£ ----------
        function analyze() {
            if (useYOLO && session) analyzeYOLO();
            else analyzeCV();
        }

        // ---------- YOLOv8.4 æ¨ç† ----------
        async function analyzeYOLO() {
            showToast('ğŸ¤– YOLO åˆ†æä¸­...');
            const canvas = document.getElementById('mainCanvas');
            const inputSize = 640;
            const tensor = await preprocess(currentImage, inputSize);
            const feeds = { images: tensor };
            const results = await session.run(feeds);
            const output = results.output0 || results[Object.keys(results)[0]];
            const boxes = parseYOLOOutput(output, 0.25, 0.45, inputSize);
            tensor.dispose();

            // è½¬æ¢åˆ°åŸå›¾åæ ‡
            const scaleX = currentImage.width / inputSize;
            const scaleY = currentImage.height / inputSize;
            colonies = boxes.map(b => ({
                x: (b.x1 + b.x2) / 2 * scaleX,
                y: (b.y1 + b.y2) / 2 * scaleY,
                radius: Math.sqrt((b.x2 - b.x1) * (b.y2 - b.y1)) / 2 * Math.max(scaleX, scaleY),
                manual: false,
                conf: b.confidence
            }));
            renderMarkers();
            updateStats();
            showToast(`âœ… æ£€æµ‹åˆ° ${colonies.length} ä¸ªèŒè½`);
        }

        async function preprocess(img, size) {
            const canvas = document.createElement('canvas');
            canvas.width = size; canvas.height = size;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#808080';
            ctx.fillRect(0, 0, size, size);
            const scale = Math.min(size / img.width, size / img.height);
            const w = img.width * scale, h = img.height * scale;
            ctx.drawImage(img, (size - w)/2, (size - h)/2, w, h);
            const imageData = ctx.getImageData(0, 0, size, size);
            const data = imageData.data;
            const red = [], green = [], blue = [];
            for (let i = 0; i < data.length; i += 4) {
                red.push(data[i] / 255);
                green.push(data[i+1] / 255);
                blue.push(data[i+2] / 255);
            }
            const input = new Float32Array([...red, ...green, ...blue]);
            return new ort.Tensor('float32', input, [1, 3, size, size]);
        }

        function parseYOLOOutput(output, confThresh, iouThresh, size) {
            const data = output.data;
            const dims = output.dims;
            let boxes = [];
            if (dims.length === 3 && dims[1] > 4) {
                const numBoxes = dims[2];
                for (let i = 0; i < numBoxes; i++) {
                    const cx = data[i];
                    const cy = data[numBoxes + i];
                    const w = data[2 * numBoxes + i];
                    const h = data[3 * numBoxes + i];
                    let maxConf = 0;
                    for (let c = 0; c < dims[1] - 4; c++) {
                        const conf = data[(4 + c) * numBoxes + i];
                        if (conf > maxConf) maxConf = conf;
                    }
                    if (maxConf > confThresh) {
                        const x1 = (cx - w/2) * size;
                        const y1 = (cy - h/2) * size;
                        const x2 = (cx + w/2) * size;
                        const y2 = (cy + h/2) * size;
                        boxes.push({ x1, y1, x2, y2, confidence: maxConf });
                    }
                }
            }
            // NMS ç®€åŒ–
            boxes.sort((a,b) => b.confidence - a.confidence);
            const result = [];
            for (let i = 0; i < boxes.length; i++) {
                let keep = true;
                for (let j = 0; j < result.length; j++) {
                    const iou = computeIoU(boxes[i], result[j]);
                    if (iou > iouThresh) { keep = false; break; }
                }
                if (keep) result.push(boxes[i]);
            }
            return result;
        }

        function computeIoU(a, b) {
            const x1 = Math.max(a.x1, b.x1), y1 = Math.max(a.y1, b.y1);
            const x2 = Math.min(a.x2, b.x2), y2 = Math.min(a.y2, b.y2);
            const inter = Math.max(0, x2 - x1) * Math.max(0, y2 - y1);
            const areaA = (a.x2 - a.x1) * (a.y2 - a.y1);
            const areaB = (b.x2 - b.x1) * (b.y2 - b.y1);
            return inter / (areaA + areaB - inter);
        }

        // ---------- ä¼ ç»Ÿ CV åˆ†æ (ç®€åŒ–ç‰ˆï¼ŒåŸä»£ç ä¸­æœ‰å®Œæ•´å®ç°) ----------
        function analyzeCV() {
            showToast('âš™ï¸ ä¼ ç»ŸCVåˆ†æä¸­...');
            setTimeout(() => {
                // æ­¤å¤„ä»…ä½œæ¼”ç¤ºï¼Œå®é™…å¯å¤ç”¨åŸå®Œæ•´é€»è¾‘
                colonies = [];
                for (let i = 0; i < 10; i++) {
                    colonies.push({
                        x: Math.random() * currentImage.width,
                        y: Math.random() * currentImage.height,
                        radius: 5 + Math.random() * 10,
                        manual: false
                    });
                }
                renderMarkers();
                updateStats();
                showToast(`âœ… CVæ£€æµ‹åˆ° ${colonies.length} ä¸ªèŒè½`);
            }, 500);
        }

        // ---------- æ¸²æŸ“æ ‡è®° ----------
        function renderMarkers() {
            const overlay = document.getElementById('overlay');
            const zoom = 1; // ç®€åŒ–
            overlay.innerHTML = '';
            colonies.forEach((c, idx) => {
                const div = document.createElement('div');
                div.style.position = 'absolute';
                div.style.left = (c.x - c.radius) + 'px';
                div.style.top = (c.y - c.radius) + 'px';
                div.style.width = (c.radius * 2) + 'px';
                div.style.height = (c.radius * 2) + 'px';
                div.style.border = '2px solid #ff4757';
                div.style.borderRadius = '50%';
                div.style.pointerEvents = 'auto';
                div.style.cursor = 'pointer';
                div.onclick = (e) => { e.stopPropagation(); colonies.splice(idx,1); renderMarkers(); updateStats(); };
                overlay.appendChild(div);
            });
        }

        function updateStats() {
            const auto = colonies.filter(c => !c.manual).length;
            document.getElementById('totalCount').textContent = colonies.length;
            document.getElementById('autoCount').textContent = auto;
            document.getElementById('manualCount').textContent = colonies.length - auto;
            if (colonies.length) {
                const avg = colonies.reduce((s,c) => s + c.radius, 0) / colonies.length;
                document.getElementById('avgRadius').textContent = avg.toFixed(1);
            } else {
                document.getElementById('avgRadius').textContent = '0';
            }
        }

        // ---------- äº¤äº’äº‹ä»¶ ----------
        document.getElementById('analyzeBtn').addEventListener('click', analyze);
        document.getElementById('addBtn').addEventListener('click', () => {
            isAddMode = !isAddMode;
            document.getElementById('addBtn').style.background = isAddMode ? '#10b981' : '';
            showToast(isAddMode ? 'ç‚¹å‡»ç”»å¸ƒæ·»åŠ èŒè½' : 'é€€å‡ºæ·»åŠ æ¨¡å¼');
        });
        document.getElementById('exportBtn').addEventListener('click', exportImage);
        document.getElementById('resetBtn').addEventListener('click', resetApp);

        const canvas = document.getElementById('mainCanvas');
        canvas.addEventListener('click', (e) => {
            if (!isAddMode || !currentImage) return;
            const rect = canvas.getBoundingClientRect();
            const scaleX = currentImage.width / rect.width;
            const scaleY = currentImage.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            const avgRadius = colonies.length ? colonies.reduce((s,c) => s + c.radius,0)/colonies.length : 10;
            colonies.push({ x, y, radius: avgRadius, manual: true });
            renderMarkers();
            updateStats();
        });

        function exportImage() {
            const canvas = document.getElementById('mainCanvas');
            const link = document.createElement('a');
            link.download = `colonies_${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        function resetApp() {
            colonies = [];
            currentImage = null;
            document.getElementById('uploadCard').style.display = 'block';
            document.getElementById('viewer').classList.remove('active');
            document.getElementById('overlay').innerHTML = '';
            isAddMode = false;
            document.getElementById('addBtn').style.background = '';
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }
    </script>
</body>
</html>
