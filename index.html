<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <title>è¯­éŸ³è½¬å†™ Â· ä¸“ä¸šæŒç»­ç‰ˆ</title>
    <!-- Font Awesome 6 (å…è´¹å›¾æ ‡åº“) ç”¨äºç®€æ´ç¾è§‚çš„æŒ‰é’® -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* æ ·å¼åŸºæœ¬ä¿æŒä¸å˜ï¼Œä»…å¾®è°ƒ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            color: #1e293b;
        }

        .app-container {
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            background: white;
            border-radius: 32px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.08), 0 6px 12px rgba(0,0,0,0.05);
            overflow: hidden;
            backdrop-filter: blur(2px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .header {
            padding: 24px 24px 16px 24px;
            background: white;
            border-bottom: 1px solid #f0f2f5;
        }

        .header h1 {
            font-size: 1.9rem;
            font-weight: 600;
            letter-spacing: -0.02em;
            background: linear-gradient(145deg, #0f172a, #334155);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header h1 i {
            background: #eef2ff;
            padding: 8px;
            border-radius: 18px;
            color: #4f46e5;
            font-size: 1.4rem;
            -webkit-text-fill-color: #4f46e5;
        }

        .lang-selector {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            background: #f8fafc;
            padding: 6px;
            border-radius: 48px;
            border: 1px solid #e2e8f0;
        }

        .lang-option {
            flex: 1;
            text-align: center;
            padding: 10px 6px;
            font-size: 1rem;
            font-weight: 500;
            border-radius: 40px;
            background: transparent;
            border: none;
            color: #64748b;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .lang-option.active {
            background: #ffffff;
            color: #0f172a;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
            font-weight: 600;
            border: 0.5px solid #d9e2ef;
        }

        .live-card {
            background: #ffffff;
            margin: 20px 24px;
            padding: 24px 20px;
            border-radius: 28px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.02), 0 8px 18px -6px rgba(0,20,40,0.12);
            border: 1px solid #ffffff80;
            min-height: 160px;
            display: flex;
            flex-direction: column;
        }

        .transcript-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #94a3b8;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .transcript-label i {
            font-size: 0.9rem;
        }

        .live-transcript {
            font-size: 1.3rem;
            line-height: 1.5;
            font-weight: 420;
            color: #0b1e33;
            word-break: break-word;
            white-space: pre-wrap;
            flex: 1;
            min-height: 80px;
            max-height: 240px;
            overflow-y: auto;
            padding-right: 8px;
            scrollbar-width: thin;
        }

        .status-badge {
            align-self: flex-end;
            font-size: 0.75rem;
            padding: 6px 14px;
            background: #f1f4f9;
            border-radius: 40px;
            color: #475569;
            margin-top: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .status-badge.recording {
            background: #fee2e2;
            color: #b91c1c;
        }

        .status-badge i {
            font-size: 0.7rem;
        }

        .control-panel {
            display: flex;
            justify-content: space-around;
            padding: 8px 24px 24px 24px;
            gap: 12px;
        }

        .ctrl-btn {
            flex: 1;
            background: #fefefe;
            border: 1px solid #e9edf2;
            border-radius: 56px;
            padding: 16px 0;
            font-size: 1rem;
            font-weight: 550;
            color: #1e293b;
            box-shadow: 0 4px 8px rgba(0,0,0,0.02);
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            backdrop-filter: blur(2px);
        }

        .ctrl-btn:active {
            background: #f1f5f9;
            transform: scale(0.97);
        }

        .ctrl-btn.primary {
            background: #1e293b;
            border-color: #1e293b;
            color: white;
            box-shadow: 0 10px 18px -8px #1e293b80;
        }

        .ctrl-btn.primary:active {
            background: #0f172a;
        }

        .ctrl-btn:disabled {
            opacity: 0.4;
            filter: grayscale(0.5);
            pointer-events: none;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px 8px 24px;
        }

        .history-header h2 {
            font-size: 1.25rem;
            font-weight: 590;
            color: #1e293b;
        }

        .history-header button {
            background: none;
            border: none;
            color: #4f46e5;
            font-size: 0.95rem;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 30px;
            background: #f1f4f9;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        .history-list {
            padding: 0 24px 30px 24px;
            max-height: 360px;
            overflow-y: auto;
            scrollbar-width: thin;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .history-item {
            background: #ffffff;
            border-radius: 22px;
            padding: 18px 16px;
            border: 1px solid #edf2f7;
            box-shadow: 0 6px 12px -8px rgba(0,0,0,0.08);
            transition: 0.1s;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .history-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.75rem;
            color: #64748b;
        }

        .history-meta i {
            width: 16px;
        }

        .history-text {
            font-size: 1rem;
            font-weight: 450;
            color: #0f172a;
            background: #f8fafc;
            padding: 14px;
            border-radius: 18px;
            line-height: 1.4;
            word-break: break-word;
            max-height: 100px;
            overflow-y: auto;
        }

        .history-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 4px;
            flex-wrap: wrap;
        }

        .history-actions button {
            background: transparent;
            border: none;
            color: #4b5563;
            font-size: 1.1rem;
            width: 44px;
            height: 44px;
            border-radius: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #f1f4f9;
            cursor: pointer;
            transition: 0.1s;
        }

        .history-actions button:active {
            background: #e2e8f0;
        }

        .toast-message {
            position: fixed;
            bottom: 30px;
            left: 20px;
            right: 20px;
            max-width: 400px;
            margin: 0 auto;
            background: #1e293b;
            color: white;
            padding: 14px 24px;
            border-radius: 60px;
            font-size: 0.95rem;
            text-align: center;
            box-shadow: 0 20px 30px -10px black;
            opacity: 0;
            transition: 0.2s;
            pointer-events: none;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>
                <i class="fas fa-microphone-lines"></i> è¯­éŸ³è½¬å†™Â·ä¸“ä¸šç‰ˆ
            </h1>
            <div class="lang-selector" id="langSelector">
                <button class="lang-option active" data-lang="zh-CN">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</button>
                <button class="lang-option" data-lang="en-US">ğŸ‡¬ğŸ‡§ è‹±æ–‡</button>
            </div>
        </div>

        <!-- å®æ—¶è½¬å†™å¡ç‰‡ -->
        <div class="live-card">
            <div class="transcript-label"><i class="far fa-comment-dots"></i> å®æ—¶è½¬å†™</div>
            <div class="live-transcript" id="liveTranscript">ç‚¹å‡»å¼€å§‹ï¼Œå¯¹ç€éº¦å…‹é£è¯´è¯...</div>
            <div class="status-badge" id="statusBadge"><i class="fas fa-circle"></i> ç©ºé—²</div>
        </div>

        <!-- æ§åˆ¶æŒ‰é’®ç»„ -->
        <div class="control-panel">
            <button class="ctrl-btn" id="startBtn" title="å¼€å§‹å½•éŸ³ (è¯·æ±‚éº¦å…‹é£)"><i class="fas fa-play"></i> å¼€å§‹</button>
            <button class="ctrl-btn" id="stopBtn" disabled><i class="fas fa-stop"></i> åœæ­¢</button>
        </div>

        <!-- å†å²è®°å½•æ ‡é¢˜ & å…¨éƒ¨å¯¼å‡º -->
        <div class="history-header">
            <h2><i class="far fa-clock" style="margin-right: 6px;"></i> æœ¬åœ°è®°å½•</h2>
            <button id="exportAllBtn"><i class="fas fa-download"></i> å…¨éƒ¨å¯¼å‡º</button>
        </div>

        <!-- å†å²åˆ—è¡¨ åŠ¨æ€æ¸²æŸ“ -->
        <div class="history-list" id="historyList">
            <!-- ç”±jså¡«å…… -->
            <div style="text-align: center; color: #94a3b8; padding: 30px 0;">æš‚æ— è½¬å†™è®°å½•</div>
        </div>
    </div>

    <!-- è½»æç¤ºtoast -->
    <div id="toast" class="toast-message"></div>

    <script>
        (function() {
            // -------------------- ä¸¥æ ¼æ¨¡å¼ & å…¼å®¹Web Speech --------------------
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨ Edge/Chrome/Safari æœ€æ–°ç‰ˆã€‚\næˆ‘ä»¬å°†æ¨¡æ‹Ÿç¦»çº¿è¯†åˆ«(ä»…æ¼”ç¤ºUI)');
            }

            // ---------- DOM å…ƒç´  ----------
            const liveTranscriptEl = document.getElementById('liveTranscript');
            const statusBadge = document.getElementById('statusBadge');
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const langSelector = document.getElementById('langSelector');
            const historyListEl = document.getElementById('historyList');
            const toastEl = document.getElementById('toast');
            const exportAllBtn = document.getElementById('exportAllBtn');

            // ---------- å…¨å±€çŠ¶æ€ ----------
            let currentStream = null;               // éº¦å…‹é£ MediaStream
            let mediaRecorder = null;               
            let recognition = null;                 
            let isRecording = false;                 // æ˜¯å¦æ­£åœ¨å½•éŸ³/è¯†åˆ«ä¸­
            let userStopped = false;                 // æ˜¯å¦ç”±ç”¨æˆ·ä¸»åŠ¨åœæ­¢ï¼ˆé¿å…è‡ªåŠ¨é‡å¯ï¼‰
            let finalTranscript = '';                 // æœ€ç»ˆå®Œæ•´è½¬å†™ (ä»…final)
            let audioChunks = [];                      // å½•éŸ³æ•°æ®å—
            let currentLanguage = 'zh-CN';            // é»˜è®¤ä¸­æ–‡

            // IndexedDB å…¨å±€
            const DB_NAME = 'VoiceTranscriptDB';
            const STORE_NAME = 'recordings';
            const DB_VERSION = 3;

            let db = null;

            // ---------- åˆå§‹åŒ–æ•°æ®åº“ ----------
            function openDB() {
                return new Promise((resolve, reject) => {
                    if (db) return resolve(db);
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onerror = (e) => reject('æ•°æ®åº“æ‰“å¼€å¤±è´¥');
                    request.onsuccess = (e) => {
                        db = e.target.result;
                        resolve(db);
                    };
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            const store = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                            store.createIndex('timestamp', 'timestamp', { unique: false });
                            store.createIndex('language', 'language', { unique: false });
                        }
                    };
                });
            }

            // æ·»åŠ ä¸€æ¡è®°å½• (audioBlob: Blob, transcript: string, lang: string)
            async function addRecording(blob, transcript, lang) {
                await openDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    const store = tx.objectStore(STORE_NAME);
                    const entry = {
                        timestamp: Date.now(),
                        audioBlob: blob,
                        transcript: transcript || ' ',
                        language: lang,
                    };
                    const req = store.add(entry);
                    req.onsuccess = () => resolve();
                    req.onerror = (e) => reject(e);
                });
            }

            // è·å–æ‰€æœ‰è®°å½•
            async function getAllRecordings() {
                await openDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(STORE_NAME, 'readonly');
                    const store = tx.objectStore(STORE_NAME);
                    const req = store.getAll();
                    req.onsuccess = () => resolve(req.result || []);
                    req.onerror = (e) => reject(e);
                });
            }

            // åˆ é™¤è®°å½•
            async function deleteRecording(id) {
                await openDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    const store = tx.objectStore(STORE_NAME);
                    const req = store.delete(id);
                    req.onsuccess = () => resolve();
                    req.onerror = (e) => reject(e);
                });
            }

            // æ¸…ç©ºæ‰€æœ‰è®°å½•
            async function clearAllRecordings() {
                await openDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    const store = tx.objectStore(STORE_NAME);
                    const req = store.clear();
                    req.onsuccess = () => resolve();
                    req.onerror = (e) => reject(e);
                });
            }

            // ---------- æ¸²æŸ“å†å²åˆ—è¡¨ ----------
            async function renderHistory() {
                try {
                    const records = await getAllRecordings();
                    if (records.length === 0) {
                        historyListEl.innerHTML = '<div style="text-align: center; color: #94a3b8; padding: 30px 0;">æš‚æ— è½¬å†™è®°å½•</div>';
                        return;
                    }
                    // æŒ‰æ—¶é—´æˆ³å€’åº
                    records.sort((a,b) => b.timestamp - a.timestamp);
                    let html = '';
                    records.forEach(rec => {
                        const date = new Date(rec.timestamp).toLocaleString(undefined, { hour12: false, hour: '2-digit', minute:'2-digit', day:'2-digit', month:'2-digit' });
                        const preview = rec.transcript.length > 80 ? rec.transcript.slice(0,80)+'â€¦' : rec.transcript;
                        html += `
                        <div class="history-item" data-id="${rec.id}">
                            <div class="history-meta">
                                <i class="far fa-calendar-alt"></i> ${date}  Â·  ${rec.language === 'zh-CN' ? 'ä¸­æ–‡' : 'è‹±æ–‡'}
                            </div>
                            <div class="history-text">${escapeHtml(rec.transcript) || 'æ— æ–‡æœ¬'}</div>
                            <div class="history-actions">
                                <button class="play-audio" title="æ’­æ”¾å½•éŸ³"><i class="fas fa-play"></i></button>
                                <button class="export-text" title="å¯¼å‡ºæ–‡æœ¬"><i class="fas fa-file-alt"></i></button>
                                <button class="export-audio" title="å¯¼å‡ºéŸ³é¢‘"><i class="fas fa-download"></i></button>
                                <button class="delete-entry" title="åˆ é™¤"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>`;
                    });
                    historyListEl.innerHTML = html;

                    // ç»‘å®šæ¯ä¸ªå¡ç‰‡çš„æ“ä½œ
                    document.querySelectorAll('.history-item').forEach(item => {
                        const id = Number(item.dataset.id);
                        const record = records.find(r => r.id === id);

                        item.querySelector('.play-audio')?.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (record?.audioBlob) {
                                const url = URL.createObjectURL(record.audioBlob);
                                const audio = new Audio(url);
                                audio.play().catch(e => showToast('æ’­æ”¾å¤±è´¥ï¼š' + e.message));
                                setTimeout(() => URL.revokeObjectURL(url), 10000);
                            } else {
                                showToast('æ— éŸ³é¢‘æ•°æ®');
                            }
                        });

                        item.querySelector('.export-text')?.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (record?.transcript) {
                                const blob = new Blob([record.transcript], { type: 'text/plain;charset=utf-8' });
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = `transcript_${record.timestamp}.txt`;
                                a.click();
                                URL.revokeObjectURL(url);
                                showToast('æ–‡æœ¬å·²å¯¼å‡º');
                            } else {
                                showToast('æ— æ–‡æœ¬å†…å®¹');
                            }
                        });

                        // æ–°å¢ï¼šå¯¼å‡ºéŸ³é¢‘æŒ‰é’®
                        item.querySelector('.export-audio')?.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (record?.audioBlob) {
                                const url = URL.createObjectURL(record.audioBlob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = `audio_${record.timestamp}.webm`; // ä½¿ç”¨webmåç¼€
                                a.click();
                                URL.revokeObjectURL(url);
                                showToast('éŸ³é¢‘å·²å¯¼å‡º');
                            } else {
                                showToast('æ— éŸ³é¢‘æ•°æ®');
                            }
                        });

                        item.querySelector('.delete-entry')?.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            await deleteRecording(id);
                            renderHistory();
                            showToast('å·²åˆ é™¤');
                        });
                    });
                } catch (e) {
                    console.error(e);
                }
            }

            // ç®€å•çš„é˜²XSSè½¬ä¹‰
            function escapeHtml(unsafe) {
                if (!unsafe) return '';
                return unsafe.replace(/[&<>"]/g, function(m) {
                    if(m === '&') return '&amp;'; if(m === '<') return '&lt;'; if(m === '>') return '&gt;'; if(m === '"') return '&quot;';
                    return m;
                });
            }

            // ---------- æ˜¾ç¤ºè½»æç¤º ----------
            function showToast(msg, duration = 2000) {
                toastEl.style.opacity = '1';
                toastEl.innerText = msg;
                setTimeout(() => { toastEl.style.opacity = '0'; }, duration);
            }

            // ---------- é‡ç½®å½•éŸ³æ ‡è®° ----------
            function resetRecordingState() {
                finalTranscript = '';
                audioChunks = [];
                userStopped = false;
            }

            // ---------- åœæ­¢æ‰€æœ‰trackå¹¶æ¸…ç†stream ----------
            function closeStream() {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => {
                        track.stop();
                    });
                    currentStream = null;
                }
            }

            // ---------- ä¿å­˜å½“å‰å½•éŸ³/è½¬å†™åˆ°IndexedDB (ç”±ä¸¤è€…ç»“æŸè§¦å‘) ----------
            async function saveToDBAndCleanup() {
                // æ³¨æ„ï¼šåœ¨æŒç»­è¯†åˆ«æ¨¡å¼ä¸‹ï¼Œåªæœ‰å½“ç”¨æˆ·ä¸»åŠ¨åœæ­¢æ—¶æ‰ä¼šè°ƒç”¨æ­¤å‡½æ•°
                // å¦‚æœrecognitionå› ä¸ºç½‘ç»œç­‰åŸå› æ„å¤–ç»“æŸï¼Œæˆ‘ä»¬ä¸ä¼šä¿å­˜ï¼Œè€Œæ˜¯é‡å¯è¯†åˆ«
                // å› æ­¤è¿™é‡Œåªä¼šåœ¨stopæµç¨‹ä¸­è°ƒç”¨
                try {
                    const blob = new Blob(audioChunks, { type: 'audio/webm' }); // ç§»åŠ¨ç«¯å¸¸è§æ ¼å¼
                    const transcript = finalTranscript.trim() || 'ï¼ˆæ— è¯­éŸ³è¯†åˆ«æ–‡æœ¬ï¼‰';
                    await addRecording(blob, transcript, currentLanguage);
                    showToast('å·²ä¿å­˜åˆ°æœ¬åœ°è®°å½•');
                } catch (e) {
                    console.warn('ä¿å­˜å¤±è´¥', e);
                    showToast('ä¿å­˜å¤±è´¥');
                } finally {
                    // å½»åº•å…³é—­éº¦å…‹é£
                    closeStream();
                    isRecording = false;
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    statusBadge.innerHTML = '<i class="fas fa-circle"></i> ç©ºé—²';
                    statusBadge.classList.remove('recording');
                    liveTranscriptEl.innerText = 'ç‚¹å‡»å¼€å§‹ï¼Œå¯¹ç€éº¦å…‹é£è¯´è¯...';
                    // åˆ·æ–°å†å²
                    renderHistory();
                }
            }

            // ---------- åœæ­¢å½•éŸ³ï¼ˆç”¨æˆ·ä¸»åŠ¨ï¼‰ ----------
            function stopRecording() {
                if (!isRecording) return;

                userStopped = true;  // æ ‡è®°ç”¨æˆ·ä¸»åŠ¨åœæ­¢

                // åœæ­¢è¯†åˆ«
                if (recognition) {
                    try {
                        recognition.stop();  // è¿™ä¼šè§¦å‘onendï¼Œä½†æˆ‘ä»¬å·²ç»æ ‡è®°userStoppedï¼Œæ‰€ä»¥ä¸ä¼šé‡å¯
                    } catch (e) {
                        console.warn('è¯†åˆ«åœæ­¢å¼‚å¸¸', e);
                    }
                }

                // åœæ­¢å½•åˆ¶
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                }

                // æŒ‰é’®çŠ¶æ€åœ¨saveToDBAndCleanupä¸­ç»Ÿä¸€æ”¹å˜
            }

            // ---------- å¼€å§‹å½•éŸ³ ----------
            async function startRecording() {
                if (isRecording) return;
                resetRecordingState();

                try {
                    // è¯·æ±‚éº¦å…‹é£
                    currentStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                } catch (err) {
                    showToast('æ— æ³•è®¿é—®éº¦å…‹é£: ' + err.message);
                    return;
                }

                // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
                if (SpeechRecognition) {
                    try {
                        recognition = new SpeechRecognition();
                        recognition.continuous = true;
                        recognition.interimResults = true;
                        recognition.lang = currentLanguage;
                        recognition.maxAlternatives = 1;

                        recognition.onresult = (event) => {
                            let final = '';
                            let interim = '';
                            for (let i = 0; i < event.results.length; i++) {
                                if (event.results[i].isFinal) {
                                    final += event.results[i][0].transcript;
                                } else {
                                    interim += event.results[i][0].transcript;
                                }
                            }
                            finalTranscript = final;   // ä¿å­˜æœ€ç»ˆéƒ¨åˆ†
                            // å®æ—¶æ˜¾ç¤º
                            liveTranscriptEl.innerText = final + interim || 'ï¼ˆè†å¬ä¸­...ï¼‰';
                        };

                        recognition.onerror = (e) => {
                            console.warn('è¯†åˆ«é”™è¯¯:', e.error);
                            if (e.error === 'not-allowed') showToast('éº¦å…‹é£æƒé™è¢«æ‹’ç»');
                            else showToast('è¯†åˆ«å‡ºé”™: ' + e.error);
                            // å¦‚æœé”™è¯¯å¯¼è‡´è¯†åˆ«ç»“æŸï¼Œä¸”ä¸æ˜¯ç”¨æˆ·åœæ­¢ï¼Œå°è¯•é‡å¯
                            if (!userStopped && isRecording) {
                                // çŸ­æš‚å»¶è¿Ÿåé‡å¯
                                setTimeout(() => {
                                    if (!userStopped && isRecording && recognition) {
                                        try {
                                            recognition.start();
                                        } catch (err) {
                                            console.warn('é‡å¯è¯†åˆ«å¤±è´¥', err);
                                        }
                                    }
                                }, 500);
                            }
                        };

                        recognition.onend = () => {
                            // å¦‚æœè¿˜åœ¨å½•éŸ³ä¸­ä¸”ä¸æ˜¯ç”¨æˆ·ä¸»åŠ¨åœæ­¢ï¼Œåˆ™é‡å¯è¯†åˆ«ï¼ˆä¿æŒæŒç»­ï¼‰
                            if (!userStopped && isRecording) {
                                // å»¶è¿Ÿé‡å¯ï¼Œé¿å…é¢‘ç¹å¯åŠ¨
                                setTimeout(() => {
                                    if (!userStopped && isRecording && recognition) {
                                        try {
                                            recognition.start();
                                            console.log('è¯†åˆ«å·²è‡ªåŠ¨é‡å¯');
                                        } catch (err) {
                                            showToast('è‡ªåŠ¨é‡å¯è¯†åˆ«å¤±è´¥');
                                        }
                                    }
                                }, 300);
                            } else if (userStopped) {
                                // ç”¨æˆ·ä¸»åŠ¨åœæ­¢ï¼Œæ­¤æ—¶mediaRecorderå¯èƒ½è¿˜åœ¨ç­‰åœæ­¢äº‹ä»¶ï¼Œæˆ‘ä»¬æ ‡è®°è¯†åˆ«å·²ç»“æŸ
                                // ä½†ä¿å­˜æµç¨‹ç”±mediaRecorderçš„onstopè§¦å‘ï¼Œè¿™é‡Œä¸å†å•ç‹¬è§¦å‘
                                // å› ä¸ºmediaRecorder onstopæ—¶ä¼šè°ƒç”¨saveToDBAndCleanup
                            }
                        };
                    } catch (e) {
                        showToast('è¯­éŸ³è¯†åˆ«åˆå§‹åŒ–å¤±è´¥');
                        recognition = null;
                    }
                } else {
                    // é™çº§ï¼šæ²¡æœ‰è¯­éŸ³è¯†åˆ«ï¼Œæ‰‹åŠ¨æ¨¡æ‹Ÿ
                    recognition = null;
                    showToast('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒç¦»çº¿è¯†åˆ«ï¼Œä»…å½•åˆ¶éŸ³é¢‘');
                }

                // åˆå§‹åŒ–MediaRecorder
                try {
                    mediaRecorder = new MediaRecorder(currentStream, {
                        mimeType: MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' : 'audio/webm'
                    });
                    mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) audioChunks.push(e.data);
                    };
                    mediaRecorder.onstop = () => {
                        // åªæœ‰å½“ç”¨æˆ·ä¸»åŠ¨åœæ­¢æ—¶æ‰ä¿å­˜ï¼Œå¹¶ä¸”è¯†åˆ«å·²ç»ç»“æŸï¼ˆæˆ–æ ‡è®°ä¸ºç»“æŸï¼‰
                        // å¦‚æœè¯†åˆ«è¿˜åœ¨è¿›è¡Œï¼Œä½†æˆ‘ä»¬åœæ­¢äº†mediaRecorderï¼Œrecognitionå¯èƒ½è¿˜åœ¨è¿è¡Œï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿å®ƒåœæ­¢
                        if (recognition && !userStopped) {
                            // ç†è®ºä¸Šä¸ä¼šèµ°åˆ°è¿™é‡Œï¼Œå› ä¸ºstopRecordingä¼šå…ˆåœæ­¢recognition
                        }
                        saveToDBAndCleanup();  // ä¿å­˜å¹¶æ¸…ç†
                    };
                    mediaRecorder.start(200); // æ¯200msè§¦å‘ä¸€æ¬¡dataavailable
                } catch (e) {
                    showToast('åª’ä½“å½•åˆ¶åˆå§‹åŒ–å¤±è´¥');
                    closeStream();
                    return;
                }

                // å¯åŠ¨è¯†åˆ«
                if (recognition) {
                    try {
                        recognition.start();
                    } catch (e) {
                        showToast('è¯†åˆ«å¯åŠ¨å¤±è´¥');
                        mediaRecorder.stop();
                        return;
                    }
                }

                isRecording = true;
                startBtn.disabled = true;
                stopBtn.disabled = false;
                statusBadge.innerHTML = '<i class="fas fa-circle"></i> å½•éŸ³ä¸­...';
                statusBadge.classList.add('recording');
                liveTranscriptEl.innerText = 'æ­£åœ¨è†å¬...';
            }

            // ---------- äº‹ä»¶ç»‘å®š ----------
            startBtn.addEventListener('click', startRecording);
            stopBtn.addEventListener('click', stopRecording);

            // è¯­è¨€åˆ‡æ¢
            langSelector.addEventListener('click', (e) => {
                const btn = e.target.closest('.lang-option');
                if (!btn) return;
                const lang = btn.dataset.lang;
                if (!lang) return;
                document.querySelectorAll('.lang-option').forEach(opt => opt.classList.remove('active'));
                btn.classList.add('active');
                currentLanguage = lang;
                showToast(`è¯­è¨€åˆ‡æ¢ä¸º ${lang === 'zh-CN' ? 'ä¸­æ–‡' : 'è‹±æ–‡'}`);
            });

            // å…¨éƒ¨å¯¼å‡º (å°†æ‰€æœ‰æ–‡æœ¬åˆå¹¶å¯¼å‡º)
            exportAllBtn.addEventListener('click', async () => {
                try {
                    const records = await getAllRecordings();
                    if (records.length === 0) {
                        showToast('æš‚æ— è®°å½•');
                        return;
                    }
                    let content = '';
                    records.sort((a,b) => a.timestamp - b.timestamp).forEach(r => {
                        const date = new Date(r.timestamp).toLocaleString();
                        content += `--- ${date} (${r.language}) ---\n${r.transcript}\n\n`;
                    });
                    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `å…¨éƒ¨è½¬å†™_${Date.now()}.txt`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showToast('å…¨éƒ¨æ–‡æœ¬å·²å¯¼å‡º');
                } catch (e) {
                    showToast('å¯¼å‡ºå¤±è´¥');
                }
            });

            // åˆå§‹åŒ–æ•°æ®åº“ å¹¶ æ¸²æŸ“å†å²
            openDB().then(() => {
                renderHistory();
            }).catch(e => {
                console.error(e);
                showToast('IndexedDBåˆå§‹åŒ–å¤±è´¥ï¼Œå­˜å‚¨å°†ä¸å¯ç”¨');
            });

            // é¡µé¢å¸è½½æ—¶å…³é—­æµ
            window.addEventListener('beforeunload', () => {
                if (currentStream) closeStream();
            });
        })();
    </script>
</body>
</html>
