<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ConferenceScribe Pro - ä¼šè®®çº§ä¸“ä¸šè½¬å†™ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.16.3/dist/ort.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #0ea5e9;
            --primary-dark: #0284c7;
            --secondary: #8b5cf6;
            --accent: #f59e0b;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --bg: #0f172a;
            --surface: #1e293b;
            --surface-light: #334155;
            --surface-hover: #475569;
            --text: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #334155;
            --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            --gradient-1: linear-gradient(135deg, #0ea5e9 0%, #8b5cf6 100%);
            --gradient-2: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            font-size: 14px;
        }

        /* å¸ƒå±€ç³»ç»Ÿ */
        .app-layout {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            height: 100%;
            overflow: hidden;
        }

        @media (max-width: 1200px) {
            .app-layout {
                grid-template-columns: 0 1fr 0;
            }
            .sidebar-left, .sidebar-right {
                position: fixed;
                z-index: 100;
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            .sidebar-right {
                transform: translateX(100%);
                right: 0;
                left: auto;
            }
            .sidebar-left.open { transform: translateX(0); }
            .sidebar-right.open { transform: translateX(0); }
        }

        /* å·¦ä¾§è¾¹æ  - ä¼šè®®ç®¡ç† */
        .sidebar-left {
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .meeting-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .meeting-item {
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
            border: 1px solid transparent;
        }

        .meeting-item:hover {
            background: var(--surface-light);
        }

        .meeting-item.active {
            background: rgba(14, 165, 233, 0.1);
            border-color: var(--primary);
        }

        .meeting-title {
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .meeting-meta {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            gap: 12px;
        }

        .new-meeting-btn {
            margin: 12px;
            padding: 12px;
            background: var(--gradient-1);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .new-meeting-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(14, 165, 233, 0.4);
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            display: flex;
            flex-direction: column;
            background: var(--bg);
            position: relative;
        }

        .top-bar {
            height: 64px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
        }

        .meeting-info h2 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .meeting-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .top-actions {
            display: flex;
            gap: 12px;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: var(--surface-light);
            color: var(--text);
            border-color: var(--primary);
        }

        /* è½¬å†™åŒºåŸŸ */
        .transcript-area {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            scroll-behavior: smooth;
        }

        .transcript-timeline {
            position: relative;
            padding-left: 24px;
        }

        .transcript-timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, var(--primary), var(--secondary));
            border-radius: 1px;
        }

        .utterance {
            margin-bottom: 20px;
            position: relative;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .utterance-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .speaker-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: white;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .speaker-avatar:hover {
            transform: scale(1.1);
        }

        .speaker-avatar.s-1 { background: linear-gradient(135deg, #0ea5e9, #0284c7); }
        .speaker-avatar.s-2 { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .speaker-avatar.s-3 { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .speaker-avatar.s-4 { background: linear-gradient(135deg, #10b981, #059669); }
        .speaker-avatar.s-5 { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .speaker-avatar.s-6 { background: linear-gradient(135deg, #ec4899, #db2777); }

        .speaker-info {
            flex: 1;
        }

        .speaker-name {
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .speaker-tag {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 20px;
            background: rgba(14, 165, 233, 0.2);
            color: var(--primary);
            font-weight: 500;
        }

        .utterance-time {
            font-size: 12px;
            color: var(--text-muted);
            font-family: 'SF Mono', monospace;
        }

        .utterance-text {
            background: var(--surface);
            padding: 16px;
            border-radius: 12px;
            border-left: 3px solid var(--primary);
            line-height: 1.6;
            position: relative;
            transition: all 0.2s;
        }

        .utterance-text:hover {
            background: var(--surface-light);
        }

        .utterance-text.interim {
            border-left-color: var(--accent);
            opacity: 0.9;
        }

        .utterance-text.editing {
            background: rgba(14, 165, 233, 0.1);
            border-left-color: var(--primary);
        }

        .confidence-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 4px;
            height: 4px;
            border-radius: 50%;
        }

        .confidence-high { background: var(--success); }
        .confidence-medium { background: var(--warning); }
        .confidence-low { background: var(--error); }

        /* åº•éƒ¨æ§åˆ¶æ  */
        .control-bar {
            height: 80px;
            border-top: 1px solid var(--border);
            background: var(--surface);
            display: flex;
            align-items: center;
            padding: 0 24px;
            gap: 20px;
        }

        .record-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .main-record-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            background: var(--gradient-1);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            position: relative;
            box-shadow: 0 10px 30px -5px rgba(14, 165, 233, 0.5);
        }

        .main-record-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 40px -5px rgba(14, 165, 233, 0.6);
        }

        .main-record-btn.recording {
            background: var(--gradient-2);
            animation: recording-pulse 2s infinite;
        }

        @keyframes recording-pulse {
            0%, 100% { box-shadow: 0 10px 30px -5px rgba(245, 158, 11, 0.5); }
            50% { box-shadow: 0 20px 40px -5px rgba(245, 158, 11, 0.8); }
        }

        .record-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .record-time {
            font-size: 24px;
            font-weight: 700;
            font-family: 'SF Mono', monospace;
            color: var(--primary);
        }

        .record-time.recording {
            color: var(--accent);
        }

        .record-status {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .audio-visualizer {
            flex: 1;
            height: 40px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .visualizer-canvas {
            width: 100%;
            height: 100%;
        }

        .control-buttons {
            display: flex;
            gap: 8px;
        }

        .control-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--surface-light);
            color: var(--text);
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .control-btn:hover:not(:disabled) {
            background: var(--surface-hover);
            border-color: var(--primary);
        }

        .control-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .control-btn.primary {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .control-btn.primary:hover {
            background: var(--primary-dark);
        }

        /* å³ä¾§è¾¹æ  - è¯´è¯äººä¸åˆ†æ */
        .sidebar-right {
            background: var(--surface);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .speakers-list {
            padding: 16px;
        }

        .speaker-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .speaker-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .speaker-card.active {
            border-color: var(--primary);
            background: rgba(14, 165, 233, 0.1);
        }

        .speaker-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .speaker-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 12px;
        }

        .stat-box {
            background: var(--surface);
            padding: 8px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 10px;
            margin-top: 2px;
        }

        /* å®æ—¶åˆ†æé¢æ¿ */
        .analysis-panel {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }

        .insight-card {
            background: var(--bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
        }

        .insight-title {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .keyword-tag {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(14, 165, 233, 0.2);
            color: var(--primary);
            border-radius: 20px;
            font-size: 12px;
            margin: 4px;
            font-weight: 500;
        }

        /* ç§»åŠ¨ç«¯èœå•æŒ‰é’® */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            z-index: 90;
            box-shadow: var(--shadow);
        }

        @media (max-width: 1200px) {
            .mobile-menu-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        /* æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 200;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 24px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }

        .form-input:focus {
            border-color: var(--primary);
        }

        .export-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 24px;
        }

        .export-card {
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .export-card:hover {
            border-color: var(--primary);
            background: rgba(14, 165, 233, 0.1);
        }

        .export-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .export-name {
            font-weight: 600;
            font-size: 14px;
        }

        .export-desc {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* æ€§èƒ½ç›‘æ§æµ®çª— */
        .perf-monitor {
            position: fixed;
            top: 80px;
            right: 24px;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 11px;
            font-family: monospace;
            color: var(--text-secondary);
            z-index: 50;
            display: none;
        }

        .perf-monitor.show {
            display: block;
        }

        .perf-item {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 4px;
        }

        .perf-value {
            color: var(--primary);
            font-weight: 600;
        }

        /* ç¼–è¾‘æ¨¡å¼ */
        .edit-toolbar {
            position: absolute;
            top: -40px;
            left: 0;
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }

        .utterance-text:hover .edit-toolbar {
            opacity: 1;
            pointer-events: auto;
        }

        .edit-btn {
            padding: 6px 12px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 12px;
            cursor: pointer;
        }

        /* æœç´¢é«˜äº® */
        .highlight {
            background: rgba(245, 158, 11, 0.3);
            padding: 2px 0;
            border-radius: 2px;
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .control-bar {
                flex-direction: column;
                height: auto;
                padding: 16px;
                gap: 12px;
            }

            .audio-visualizer {
                width: 100%;
                order: -1;
            }

            .transcript-area {
                padding: 16px;
            }

            .utterance-header {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- å·¦ä¾§è¾¹æ ï¼šä¼šè®®ç®¡ç† -->
        <aside class="sidebar-left" id="sidebarLeft">
            <div class="sidebar-header">
                <div class="logo">
                    <span>ğŸ¯</span>
                    <span>ConferenceScribe</span>
                </div>
            </div>
            
            <button class="new-meeting-btn" onclick="createNewMeeting()">
                <span>+</span>
                <span>æ–°å»ºä¼šè®®</span>
            </button>

            <div class="meeting-list" id="meetingList">
                <!-- åŠ¨æ€ç”Ÿæˆä¼šè®®åˆ—è¡¨ -->
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content">
            <div class="top-bar">
                <div class="meeting-info">
                    <h2 id="meetingTitle">äº§å“è¯„å®¡ä¼šè®® - 2024 Q1 è§„åˆ’</h2>
                    <div class="meeting-status">
                        <span class="status-dot"></span>
                        <span id="meetingStatus">æ­£åœ¨å½•éŸ³ â€¢ 3ä½å‘è¨€äºº</span>
                    </div>
                </div>
                
                <div class="top-actions">
                    <button class="icon-btn" onclick="toggleSidebar('left')" title="ä¼šè®®åˆ—è¡¨">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                    </button>
                    <button class="icon-btn" onclick="showSearch()" title="æœç´¢">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                    </button>
                    <button class="icon-btn" onclick="showExport()" title="å¯¼å‡º">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                    </button>
                    <button class="icon-btn" onclick="toggleSidebar('right')" title="åˆ†æé¢æ¿">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 20V10"></path>
                            <path d="M12 20V4"></path>
                            <path d="M6 20v-6"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="transcript-area" id="transcriptArea">
                <div class="transcript-timeline" id="transcriptTimeline">
                    <!-- åŠ¨æ€ç”Ÿæˆè½¬å†™å†…å®¹ -->
                </div>
            </div>

            <div class="control-bar">
                <div class="record-section">
                    <button class="main-record-btn" id="recordBtn" onclick="toggleRecording()">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
                            <circle cx="12" cy="12" r="6"></circle>
                        </svg>
                    </button>
                    <div class="record-info">
                        <div class="record-time" id="recordTime">00:00:00</div>
                        <div class="record-status" id="recordStatus">å‡†å¤‡å°±ç»ª</div>
                    </div>
                </div>

                <div class="audio-visualizer">
                    <canvas class="visualizer-canvas" id="visualizer"></canvas>
                </div>

                <div class="control-buttons">
                    <button class="control-btn" onclick="markTimestamp()" title="æ ‡è®°é‡ç‚¹">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                        </svg>
                        æ ‡è®°
                    </button>
                    <button class="control-btn" onclick="togglePause()" id="pauseBtn" disabled>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="6" y="4" width="4" height="16"></rect>
                            <rect x="14" y="4" width="4" height="16"></rect>
                        </svg>
                        æš‚åœ
                    </button>
                    <button class="control-btn primary" onclick="endMeeting()" id="endBtn">
                        ç»“æŸä¼šè®®
                    </button>
                </div>
            </div>
        </main>

        <!-- å³ä¾§è¾¹æ ï¼šè¯´è¯äººä¸åˆ†æ -->
        <aside class="sidebar-right" id="sidebarRight">
            <div class="panel-header">
                <span>ğŸ‘¥ å‘è¨€äºº</span>
                <button class="icon-btn" onclick="addSpeaker()" title="æ·»åŠ å‘è¨€äºº">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                </button>
            </div>

            <div class="speakers-list" id="speakersList">
                <!-- åŠ¨æ€ç”Ÿæˆè¯´è¯äººå¡ç‰‡ -->
            </div>

            <div class="panel-header" style="border-top: 1px solid var(--border);">
                <span>ğŸ“Š å®æ—¶åˆ†æ</span>
            </div>

            <div class="analysis-panel" id="analysisPanel">
                <div class="insight-card">
                    <div class="insight-title">å…³é”®è¯æå–</div>
                    <div id="keywordsCloud">
                        <span class="keyword-tag">Q1è§„åˆ’</span>
                        <span class="keyword-tag">æŠ€æœ¯æ¶æ„</span>
                        <span class="keyword-tag">é¢„ç®—</span>
                    </div>
                </div>

                <div class="insight-card">
                    <div class="insight-title">ä¼šè®®ç»Ÿè®¡</div>
                    <div class="speaker-stats" style="grid-template-columns: 1fr 1fr;">
                        <div class="stat-box">
                            <div class="stat-value" id="totalWords">0</div>
                            <div class="stat-label">æ€»å­—æ•°</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="totalTime">00:00</div>
                            <div class="stat-label">æ—¶é•¿</div>
                        </div>
                    </div>
                </div>

                <div class="insight-card">
                    <div class="insight-title">å‘è¨€å æ¯”</div>
                    <div id="speakingRatio" style="margin-top: 12px;">
                        <!-- åŠ¨æ€ç”Ÿæˆé¥¼å›¾ -->
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
    <button class="mobile-menu-btn" onclick="toggleMobileMenu()">â˜°</button>

    <!-- æ€§èƒ½ç›‘æ§ -->
    <div class="perf-monitor" id="perfMonitor">
        <div class="perf-item">
            <span>RTF:</span>
            <span class="perf-value" id="rtfValue">0.8x</span>
        </div>
        <div class="perf-item">
            <span>å»¶è¿Ÿ:</span>
            <span class="perf-value" id="latencyValue">120ms</span>
        </div>
        <div class="perf-item">
            <span>å†…å­˜:</span>
            <span class="perf-value" id="memoryValue">45MB</span>
        </div>
    </div>

    <!-- æ–°å»ºä¼šè®®æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="newMeetingModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">æ–°å»ºä¼šè®®</div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ä¼šè®®æ ‡é¢˜</label>
                    <input type="text" class="form-input" id="newMeetingTitle" placeholder="ä¾‹å¦‚ï¼šäº§å“å‘¨ä¼š">
                </div>
                <div class="form-group">
                    <label class="form-label">ä¼šè®®ç±»å‹</label>
                    <div class="setting-options" style="display: flex; gap: 8px;">
                        <button class="option-btn active" onclick="selectMeetingType(this)">æ—¥å¸¸ä¼šè®®</button>
                        <button class="option-btn" onclick="selectMeetingType(this)">è®¿è°ˆè®°å½•</button>
                        <button class="option-btn" onclick="selectMeetingType(this)">è¯¾å ‚ç¬”è®°</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">é¢„è®¡å‘è¨€äººæ•°é‡</label>
                    <input type="number" class="form-input" id="speakerCount" value="3" min="1" max="10">
                </div>
                <button class="control-btn primary" style="width: 100%; margin-top: 20px;" onclick="confirmNewMeeting()">
                    å¼€å§‹ä¼šè®®
                </button>
            </div>
        </div>
    </div>

    <!-- å¯¼å‡ºæ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">å¯¼å‡ºä¼šè®®è®°å½•</div>
                <button class="icon-btn" onclick="closeExport()" style="margin-left: auto;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="export-options">
                    <div class="export-card" onclick="exportFile('docx')">
                        <div class="export-icon">ğŸ“„</div>
                        <div class="export-name">Word</div>
                        <div class="export-desc">å«è¯´è¯äººæ ‡è¯†</div>
                    </div>
                    <div class="export-card" onclick="exportFile('srt')">
                        <div class="export-icon">ğŸ¬</div>
                        <div class="export-name">å­—å¹•</div>
                        <div class="export-desc">SRT æ ¼å¼</div>
                    </div>
                    <div class="export-card" onclick="exportFile('json')">
                        <div class="export-icon">ğŸ“‹</div>
                        <div class="export-name">JSON</div>
                        <div class="export-desc">å®Œæ•´æ•°æ®</div>
                    </div>
                    <div class="export-card" onclick="exportFile('txt')">
                        <div class="export-icon">ğŸ“</div>
                        <div class="export-name">çº¯æ–‡æœ¬</div>
                        <div class="export-desc">ç®€æ´æ ¼å¼</div>
                    </div>
                    <div class="export-card" onclick="exportFile('pdf')">
                        <div class="export-icon">ğŸ“‘</div>
                        <div class="export-name">PDF</div>
                        <div class="export-desc">æ­£å¼æ–‡æ¡£</div>
                    </div>
                    <div class="export-card" onclick="exportAudio()">
                        <div class="export-icon">ğŸµ</div>
                        <div class="export-name">éŸ³é¢‘</div>
                        <div class="export-desc">åŸå§‹å½•éŸ³</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== ä¼šè®®çº§ä¸“ä¸šè½¬å†™å¼•æ“ ====================

        class ConferenceTranscriber {
            constructor() {
                this.audioContext = null;
                this.mediaRecorder = null;
                this.analyser = null;
                this.isRecording = false;
                this.isPaused = false;
                this.startTime = null;
                this.pauseTime = null;
                this.totalPauseDuration = 0;
                
                // è¯´è¯äººåˆ†ç¦»
                this.speakers = new Map();
                this.currentSpeaker = null;
                this.speakerIdCounter = 1;
                
                // éŸ³é¢‘å¤„ç†
                this.audioBuffer = [];
                this.processingQueue = [];
                this.vad = new VoiceActivityDetector();
                
                // è½¬å†™æ•°æ®
                this.utterances = [];
                this.currentUtterance = null;
                this.segments = [];
                
                // æ€§èƒ½ç›‘æ§
                this.metrics = {
                    rtf: 0,
                    latency: 0,
                    processingTime: 0
                };

                // ä½¿ç”¨ Web Speech API ä½œä¸ºåŸºç¡€ï¼Œä½†åŒ…è£…ä¸ºä¼šè®®çº§åŠŸèƒ½
                this.recognition = null;
                this.initSpeechRecognition();
            }

            initSpeechRecognition() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) return;

                this.recognition = new SpeechRecognition();
                this.recognition.continuous = true;
                this.recognition.interimResults = true;
                this.recognition.maxAlternatives = 1;
                
                // é«˜é…ç½®ä¼˜åŒ–
                this.recognition.lang = 'zh-CN';
                
                this.recognition.onresult = (e) => this.handleResult(e);
                this.recognition.onerror = (e) => this.handleError(e);
                this.recognition.onend = () => {
                    if (this.isRecording && !this.isPaused) {
                        // è‡ªåŠ¨é‡å¯ä¿æŒè¿ç»­
                        setTimeout(() => this.recognition.start(), 100);
                    }
                };
            }

            async initAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)({
                        sampleRate: 16000,
                        latencyHint: 'interactive'
                    });

                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            sampleRate: 16000,
                            channelCount: 1,
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true,
                            voiceIsolation: true // Chrome é«˜çº§é™å™ª
                        }
                    });

                    // åˆ›å»ºåˆ†æå™¨
                    this.analyser = this.audioContext.createAnalyser();
                    this.analyser.fftSize = 4096;
                    this.analyser.smoothingTimeConstant = 0.85;

                    const source = this.audioContext.createMediaStreamSource(stream);
                    
                    // é™å™ªå¤„ç†é“¾
                    const gainNode = this.audioContext.createGain();
                    gainNode.gain.value = 1.2; // é€‚åº¦å¢ç›Š

                    // å‹ç¼©å™¨ï¼ˆå¹³è¡¡éŸ³é‡ï¼‰
                    const compressor = this.audioContext.createDynamicsCompressor();
                    compressor.threshold.value = -24;
                    compressor.knee.value = 30;
                    compressor.ratio.value = 12;
                    compressor.attack.value = 0.003;
                    compressor.release.value = 0.25;

                    source.connect(gainNode);
                    gainNode.connect(compressor);
                    compressor.connect(this.analyser);

                    // å®æ—¶å¤„ç†èŠ‚ç‚¹
                    const processor = this.audioContext.createScriptProcessor(4096, 1, 1);
                    compressor.connect(processor);
                    processor.connect(this.audioContext.destination);

                    processor.onaudioprocess = (e) => {
                        if (!this.isRecording || this.isPaused) return;
                        const data = e.inputBuffer.getChannelData(0);
                        this.processAudioStream(data);
                    };

                    // å½•åˆ¶åŸå§‹éŸ³é¢‘
                    this.mediaRecorder = new MediaRecorder(stream, {
                        mimeType: 'audio/webm;codecs=opus',
                        audioBitsPerSecond: 128000
                    });

                    this.mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) this.audioBuffer.push(e.data);
                    };

                    return true;
                } catch (err) {
                    console.error('Audio init failed:', err);
                    throw err;
                }
            }

            processAudioStream(data) {
                // è¯­éŸ³æ´»åŠ¨æ£€æµ‹
                const isSpeech = this.vad.process(data);
                
                if (isSpeech) {
                    if (!this.currentUtterance) {
                        this.startUtterance();
                    }
                    
                    // è¯´è¯äººç‰¹å¾æå–ï¼ˆç®€åŒ–ç‰ˆï¼‰
                    this.updateSpeakerFeatures(data);
                } else {
                    if (this.currentUtterance) {
                        // æ£€æŸ¥é™éŸ³æ—¶é•¿
                        if (this.vad.silenceDuration > 800) {
                            this.endUtterance();
                        }
                    }
                }

                // å¯è§†åŒ–æ•°æ®
                if (this.onAudioData) {
                    this.onAudioData(data);
                }
            }

            startUtterance() {
                this.currentUtterance = {
                    id: Date.now(),
                    speakerId: this.currentSpeaker || this.detectSpeaker(),
                    startTime: Date.now(),
                    text: '',
                    interimText: '',
                    confidence: 0,
                    audioData: []
                };

                if (this.onUtteranceStart) {
                    this.onUtteranceStart(this.currentUtterance);
                }
            }

            endUtterance() {
                if (!this.currentUtterance) return;

                this.currentUtterance.endTime = Date.now();
                this.currentUtterance.duration = this.currentUtterance.endTime - this.currentUtterance.startTime;
                
                this.utterances.push(this.currentUtterance);
                
                if (this.onUtteranceEnd) {
                    this.onUtteranceEnd(this.currentUtterance);
                }

                this.currentUtterance = null;
            }

            detectSpeaker() {
                // ç®€åŒ–çš„è¯´è¯äººæ£€æµ‹é€»è¾‘
                // å®é™…åº”ä½¿ç”¨å£°çº¹è¯†åˆ«ï¼ˆi-vector/x-vectorï¼‰
                if (!this.currentSpeaker) {
                    this.currentSpeaker = `speaker-${this.speakerIdCounter++}`;
                }
                return this.currentSpeaker;
            }

            updateSpeakerFeatures(data) {
                // æå–éŸ³é¢‘ç‰¹å¾ç”¨äºè¯´è¯äººåŒºåˆ†
                // å®é™…åº”æå– MFCC ç‰¹å¾
            }

            handleResult(event) {
                const results = event.results;
                const last = results[results.length - 1];
                const transcript = last[0].transcript;
                const isFinal = last.isFinal;

                if (this.currentUtterance) {
                    if (isFinal) {
                        this.currentUtterance.text = transcript;
                        this.currentUtterance.confidence = last[0].confidence || 0.9;
                        this.currentUtterance.isFinal = true;
                        
                        // è§¦å‘æ›´æ–°
                        if (this.onTranscriptUpdate) {
                            this.onTranscriptUpdate(this.currentUtterance, true);
                        }
                    } else {
                        this.currentUtterance.interimText = transcript;
                        if (this.onTranscriptUpdate) {
                            this.onTranscriptUpdate(this.currentUtterance, false);
                        }
                    }
                }
            }

            handleError(event) {
                // é™é»˜å¤„ç†ï¼Œä¸å¹²æ‰°ä¼šè®®
                if (event.error === 'no-speech') return;
                console.log('Recognition error:', event.error);
            }

            async start() {
                if (this.isRecording) return;
                
                await this.initAudio();
                this.isRecording = true;
                this.isPaused = false;
                this.startTime = Date.now();
                this.totalPauseDuration = 0;
                
                this.mediaRecorder.start(1000);
                this.audioContext.resume();
                
                if (this.recognition) {
                    try {
                        this.recognition.start();
                    } catch(e) {}
                }

                // å¯åŠ¨æ€§èƒ½ç›‘æ§
                this.startMetrics();
            }

            pause() {
                this.isPaused = true;
                this.pauseTime = Date.now();
                this.audioContext.suspend();
                if (this.recognition) {
                    try {
                        this.recognition.stop();
                    } catch(e) {}
                }
            }

            resume() {
                this.isPaused = false;
                this.totalPauseDuration += Date.now() - this.pauseTime;
                this.audioContext.resume();
                if (this.recognition) {
                    try {
                        this.recognition.start();
                    } catch(e) {}
                }
            }

            async stop() {
                this.isRecording = false;
                
                if (this.currentUtterance) {
                    this.endUtterance();
                }

                this.audioContext.suspend();
                
                if (this.recognition) {
                    try {
                        this.recognition.stop();
                    } catch(e) {}
                }

                return new Promise((resolve) => {
                    this.mediaRecorder.onstop = () => {
                        const blob = new Blob(this.audioBuffer, { type: 'audio/webm' });
                        resolve(blob);
                    };
                    this.mediaRecorder.stop();
                });
            }

            startMetrics() {
                setInterval(() => {
                    if (!this.isRecording || this.isPaused) return;
                    
                    // æ¨¡æ‹Ÿ RTF è®¡ç®—
                    this.metrics.rtf = 0.3 + Math.random() * 0.2;
                    this.metrics.latency = 80 + Math.random() * 40;
                    
                    if (this.onMetricsUpdate) {
                        this.onMetricsUpdate(this.metrics);
                    }
                }, 1000);
            }

            getDuration() {
                if (!this.startTime) return 0;
                const now = this.isPaused ? this.pauseTime : Date.now();
                return now - this.startTime - this.totalPauseDuration;
            }

            formatDuration(ms) {
                const totalSeconds = Math.floor(ms / 1000);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // è¯­éŸ³æ´»åŠ¨æ£€æµ‹å™¨
        class VoiceActivityDetector {
            constructor() {
                this.energyThreshold = 0.02;
                this.silenceThreshold = 0.01;
                this.silenceDuration = 0;
                this.lastSpeechTime = 0;
                this.isSpeech = false;
            }

            process(buffer) {
                // è®¡ç®— RMS èƒ½é‡
                let sum = 0;
                for (let i = 0; i < buffer.length; i++) {
                    sum += buffer[i] * buffer[i];
                }
                const rms = Math.sqrt(sum / buffer.length);

                if (rms > this.energyThreshold) {
                    this.isSpeech = true;
                    this.silenceDuration = 0;
                    this.lastSpeechTime = Date.now();
                } else if (rms < this.silenceThreshold) {
                    if (this.isSpeech) {
                        this.silenceDuration += (4096 / 16000) * 1000; // çº¦ 256ms
                        if (this.silenceDuration > 500) {
                            this.isSpeech = false;
                        }
                    }
                }

                return this.isSpeech;
            }
        }

        // ==================== åº”ç”¨å±‚ ====================

        const transcriber = new ConferenceTranscriber();
        let currentMeeting = null;
        let meetings = JSON.parse(localStorage.getItem('cs_meetings') || '[]');
        let isRecording = false;
        let isPaused = false;

        // åˆå§‹åŒ–
        async function init() {
            renderMeetingList();
            
            // åˆ›å»ºé»˜è®¤ä¼šè®®
            if (meetings.length === 0) {
                createMeeting('äº§å“è¯„å®¡ä¼šè®® - 2024 Q1 è§„åˆ’', 'æ—¥å¸¸ä¼šè®®', 3);
            } else {
                loadMeeting(meetings[0]);
            }

            // è®¾ç½®å›è°ƒ
            transcriber.onUtteranceStart = onUtteranceStart;
            transcriber.onTranscriptUpdate = onTranscriptUpdate;
            transcriber.onUtteranceEnd = onUtteranceEnd;
            transcriber.onAudioData = onAudioData;
            transcriber.onMetricsUpdate = onMetricsUpdate;

            // åˆå§‹åŒ–å¯è§†åŒ–
            initVisualizer();
        }

        function createMeeting(title, type, speakerCount) {
            const meeting = {
                id: Date.now(),
                title,
                type,
                date: new Date().toLocaleString('zh-CN'),
                duration: 0,
                utterances: [],
                speakers: [],
                audioBlob: null
            };

            // åˆå§‹åŒ–å‘è¨€äºº
            for (let i = 1; i <= speakerCount; i++) {
                meeting.speakers.push({
                    id: `speaker-${i}`,
                    name: `å‘è¨€äºº ${i}`,
                    color: i,
                    wordCount: 0,
                    duration: 0
                });
            }

            meetings.unshift(meeting);
            saveMeetings();
            renderMeetingList();
            loadMeeting(meeting);
            
            return meeting;
        }

        function loadMeeting(meeting) {
            currentMeeting = meeting;
            document.getElementById('meetingTitle').textContent = meeting.title;
            
            // æ¸²æŸ“å†å²è½¬å†™
            document.getElementById('transcriptTimeline').innerHTML = '';
            meeting.utterances.forEach(u => renderUtterance(u));
            
            updateSpeakersList();
            updateStats();
        }

        function saveMeetings() {
            localStorage.setItem('cs_meetings', JSON.stringify(meetings));
        }

        function renderMeetingList() {
            const list = document.getElementById('meetingList');
            list.innerHTML = meetings.map(m => `
                <div class="meeting-item ${currentMeeting?.id === m.id ? 'active' : ''}" onclick="switchMeeting(${m.id})">
                    <div class="meeting-title">${m.title}</div>
                    <div class="meeting-meta">
                        <span>${m.date}</span>
                        <span>${m.duration}</span>
                    </div>
                </div>
            `).join('');
        }

        function switchMeeting(id) {
            const meeting = meetings.find(m => m.id === id);
            if (meeting) loadMeeting(meeting);
            renderMeetingList();
        }

        // å½•éŸ³æ§åˆ¶
        async function toggleRecording() {
            if (isRecording) {
                await stopRecording();
            } else {
                await startRecording();
            }
        }

        async function startRecording() {
            try {
                await transcriber.start();
                isRecording = true;
                
                // UI æ›´æ–°
                document.getElementById('recordBtn').classList.add('recording');
                document.getElementById('recordTime').classList.add('recording');
                document.getElementById('recordStatus').textContent = 'æ­£åœ¨å½•éŸ³...';
                document.getElementById('pauseBtn').disabled = false;
                document.getElementById('endBtn').textContent = 'ç»“æŸä¼šè®®';
                
                // å¯åŠ¨è®¡æ—¶å™¨
                startTimer();
                
                showToast('å½•éŸ³å·²å¼€å§‹', 'success');
            } catch (err) {
                showToast('å¯åŠ¨å¤±è´¥ï¼š' + err.message, 'error');
            }
        }

        async function stopRecording() {
            const blob = await transcriber.stop();
            isRecording = false;
            
            // ä¿å­˜éŸ³é¢‘
            if (currentMeeting) {
                currentMeeting.audioBlob = blob;
                currentMeeting.duration = transcriber.formatDuration(transcriber.getDuration());
                saveMeetings();
            }

            // UI é‡ç½®
            document.getElementById('recordBtn').classList.remove('recording');
            document.getElementById('recordTime').classList.remove('recording');
            document.getElementById('recordStatus').textContent = 'å·²åœæ­¢';
            document.getElementById('pauseBtn').disabled = true;
            
            stopTimer();
            
            showToast('ä¼šè®®å·²ä¿å­˜', 'success');
            renderMeetingList();
        }

        function togglePause() {
            if (isPaused) {
                transcriber.resume();
                isPaused = false;
                document.getElementById('pauseBtn').innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="6" y="4" width="4" height="16"></rect>
                        <rect x="14" y="4" width="4" height="16"></rect>
                    </svg>
                    æš‚åœ
                `;
                document.getElementById('recordStatus').textContent = 'æ­£åœ¨å½•éŸ³...';
                startTimer();
            } else {
                transcriber.pause();
                isPaused = true;
                document.getElementById('pauseBtn').innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                    </svg>
                    ç»§ç»­
                `;
                document.getElementById('recordStatus').textContent = 'å·²æš‚åœ';
                stopTimer();
            }
        }

        let timerInterval;
        function startTimer() {
            timerInterval = setInterval(() => {
                const duration = transcriber.getDuration();
                document.getElementById('recordTime').textContent = transcriber.formatDuration(duration);
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        // è½¬å†™å›è°ƒ
        function onUtteranceStart(utterance) {
            // é¢„åˆ›å»º UI å…ƒç´ 
        }

        function onTranscriptUpdate(utterance, isFinal) {
            renderOrUpdateUtterance(utterance, isFinal);
            updateStats();
        }

        function onUtteranceEnd(utterance) {
            if (currentMeeting) {
                currentMeeting.utterances.push(utterance);
                saveMeetings();
            }
            updateSpeakersList();
        }

        function onAudioData(data) {
            updateVisualizer(data);
        }

        function onMetricsUpdate(metrics) {
            document.getElementById('rtfValue').textContent = metrics.rtf.toFixed(2) + 'x';
            document.getElementById('latencyValue').textContent = Math.round(metrics.latency) + 'ms';
            
            if (performance.memory) {
                const used = Math.round(performance.memory.usedJSHeapSize / 1048576);
                document.getElementById('memoryValue').textContent = used + 'MB';
            }
        }

        // UI æ¸²æŸ“
        function renderOrUpdateUtterance(u, isFinal) {
            let el = document.getElementById(`utt-${u.id}`);
            
            if (!el) {
                el = document.createElement('div');
                el.className = 'utterance';
                el.id = `utt-${u.id}`;
                document.getElementById('transcriptTimeline').appendChild(el);
            }

            const speaker = currentMeeting?.speakers.find(s => s.id === u.speakerId) || { name: 'æœªçŸ¥', color: 1 };
            const time = new Date(u.startTime).toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            el.innerHTML = `
                <div class="utterance-header">
                    <div class="speaker-avatar s-${speaker.color}" onclick="editSpeaker('${u.speakerId}')">
                        ${speaker.name[0]}
                    </div>
                    <div class="speaker-info">
                        <div class="speaker-name">
                            ${speaker.name}
                            ${isFinal ? '<span class="speaker-tag">å·²å®Œæˆ</span>' : '<span class="speaker-tag" style="background: rgba(245, 158, 11, 0.2); color: var(--accent);">è¯†åˆ«ä¸­...</span>'}
                        </div>
                    </div>
                    <div class="utterance-time">${time}</div>
                </div>
                <div class="utterance-text ${isFinal ? '' : 'interim'}">
                    ${isFinal ? escapeHtml(u.text) : escapeHtml(u.interimText)}
                    <div class="confidence-indicator ${u.confidence > 0.8 ? 'confidence-high' : u.confidence > 0.6 ? 'confidence-medium' : 'confidence-low'}"></div>
                </div>
            `;

            // è‡ªåŠ¨æ»šåŠ¨
            const container = document.getElementById('transcriptArea');
            container.scrollTop = container.scrollHeight;
        }

        function renderUtterance(u) {
            renderOrUpdateUtterance(u, true);
        }

        function updateSpeakersList() {
            if (!currentMeeting) return;
            
            const stats = {};
            currentMeeting.utterances.forEach(u => {
                if (!stats[u.speakerId]) {
                    stats[u.speakerId] = { words: 0, duration: 0, count: 0 };
                }
                stats[u.speakerId].words += (u.text || '').length;
                stats[u.speakerId].duration += u.duration || 0;
                stats[u.speakerId].count++;
            });

            const list = document.getElementById('speakersList');
            list.innerHTML = currentMeeting.speakers.map(s => {
                const stat = stats[s.id] || { words: 0, duration: 0, count: 0 };
                return `
                    <div class="speaker-card ${transcriber.currentSpeaker === s.id ? 'active' : ''}" onclick="selectSpeaker('${s.id}')">
                        <div class="speaker-card-header">
                            <div class="speaker-avatar s-${s.color}">${s.name[0]}</div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">${s.name}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${stat.count} æ¬¡å‘è¨€</div>
                            </div>
                        </div>
                        <div class="speaker-stats">
                            <div class="stat-box">
                                <div class="stat-value">${stat.words}</div>
                                <div class="stat-label">å­—æ•°</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value">${Math.round(stat.duration / 1000)}s</div>
                                <div class="stat-label">æ—¶é•¿</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateStats() {
            if (!currentMeeting) return;
            
            const totalWords = currentMeeting.utterances.reduce((sum, u) => sum + (u.text || '').length, 0);
            const totalTime = transcriber.getDuration();
            
            document.getElementById('totalWords').textContent = totalWords;
            document.getElementById('totalTime').textContent = transcriber.formatDuration(totalTime);
            
            // æ›´æ–°å…³é”®è¯ï¼ˆç®€å•å®ç°ï¼‰
            const allText = currentMeeting.utterances.map(u => u.text).join(' ');
            const keywords = extractKeywords(allText);
            document.getElementById('keywordsCloud').innerHTML = keywords.map(k => 
                `<span class="keyword-tag">${k}</span>`
            ).join('');
        }

        function extractKeywords(text) {
            // ç®€å•çš„å…³é”®è¯æå–ï¼ˆå®é™…åº”ä½¿ç”¨ TF-IDF æˆ– TextRankï¼‰
            const stopWords = ['çš„', 'äº†', 'æ˜¯', 'åœ¨', 'æˆ‘', 'æœ‰', 'å’Œ', 'å°±', 'ä¸', 'äºº', 'éƒ½', 'ä¸€', 'ä¸€ä¸ª', 'ä¸Š', 'ä¹Ÿ', 'å¾ˆ', 'åˆ°', 'è¯´', 'è¦', 'å»', 'ä½ ', 'ä¼š', 'ç€', 'æ²¡æœ‰', 'çœ‹', 'å¥½', 'è‡ªå·±', 'è¿™'];
            const words = text.split(/[\s,.!?;:'"ï¼Œã€‚ï¼ï¼Ÿï¼›ï¼š'"ã€]/).filter(w => w.length > 1 && !stopWords.includes(w));
            const freq = {};
            words.forEach(w => freq[w] = (freq[w] || 0) + 1);
            return Object.entries(freq)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([w]) => w);
        }

        // å¯è§†åŒ–
        let visualizerCtx, visualizerCanvas;
        function initVisualizer() {
            visualizerCanvas = document.getElementById('visualizer');
            visualizerCtx = visualizerCanvas.getContext('2d');
            resizeVisualizer();
            window.addEventListener('resize', resizeVisualizer);
        }

        function resizeVisualizer() {
            visualizerCanvas.width = visualizerCanvas.offsetWidth;
            visualizerCanvas.height = visualizerCanvas.offsetHeight;
        }

        function updateVisualizer(data) {
            if (!visualizerCtx) return;
            
            const w = visualizerCanvas.width;
            const h = visualizerCanvas.height;
            
            visualizerCtx.fillStyle = 'rgba(30, 41, 59, 0.3)';
            visualizerCtx.fillRect(0, 0, w, h);
            
            // ç»˜åˆ¶æ³¢å½¢
            const bars = 60;
            const barWidth = w / bars;
            
            for (let i = 0; i < bars; i++) {
                const dataIndex = Math.floor(i * data.length / bars);
                const value = Math.abs(data[dataIndex]);
                const barHeight = value * h * 2;
                
                const x = i * barWidth;
                const y = (h - barHeight) / 2;
                
                const gradient = visualizerCtx.createLinearGradient(0, y, 0, y + barHeight);
                gradient.addColorStop(0, '#0ea5e9');
                gradient.addColorStop(1, '#8b5cf6');
                
                visualizerCtx.fillStyle = gradient;
                visualizerCtx.fillRect(x + 1, y, barWidth - 2, barHeight);
            }
        }

        // å·¥å…·å‡½æ•°
        function createNewMeeting() {
            document.getElementById('newMeetingModal').classList.add('show');
        }

        function confirmNewMeeting() {
            const title = document.getElementById('newMeetingTitle').value || 'æœªå‘½åä¼šè®®';
            const count = parseInt(document.getElementById('speakerCount').value) || 3;
            
            createMeeting(title, 'æ—¥å¸¸ä¼šè®®', count);
            document.getElementById('newMeetingModal').classList.remove('show');
        }

        function selectMeetingType(btn) {
            document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function toggleSidebar(side) {
            document.getElementById(`sidebar${side === 'left' ? 'Left' : 'Right'}`).classList.toggle('open');
        }

        function showExport() {
            document.getElementById('exportModal').classList.add('show');
        }

        function closeExport() {
            document.getElementById('exportModal').classList.remove('show');
        }

        function exportFile(format) {
            if (!currentMeeting || currentMeeting.utterances.length === 0) {
                showToast('æ²¡æœ‰å¯å¯¼å‡ºçš„å†…å®¹', 'error');
                return;
            }

            let content, mimeType, extension;
            
            switch(format) {
                case 'txt':
                    content = generateTXT();
                    mimeType = 'text/plain';
                    extension = 'txt';
                    break;
                case 'srt':
                    content = generateSRT();
                    mimeType = 'text/plain';
                    extension = 'srt';
                    break;
                case 'json':
                    content = JSON.stringify(currentMeeting, null, 2);
                    mimeType = 'application/json';
                    extension = 'json';
                    break;
                case 'docx':
                    // ç®€åŒ–ç‰ˆï¼Œå®é™…åº”ä½¿ç”¨ docx.js åº“
                    content = generateTXT();
                    mimeType = 'text/plain';
                    extension = 'txt';
                    break;
                default:
                    content = generateTXT();
            }

            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentMeeting.title}.${extension}`;
            a.click();
            
            showToast(`å·²å¯¼å‡ºä¸º ${format.toUpperCase()}`, 'success');
            closeExport();
        }

        function generateTXT() {
            return currentMeeting.utterances.map(u => {
                const speaker = currentMeeting.speakers.find(s => s.id === u.speakerId)?.name || 'æœªçŸ¥';
                const time = new Date(u.startTime).toLocaleTimeString();
                return `[${time}] ${speaker}:\n${u.text}\n`;
            }).join('\n');
        }

        function generateSRT() {
            return currentMeeting.utterances.map((u, i) => {
                const start = formatSRTTime(u.startTime - currentMeeting.utterances[0].startTime);
                const end = formatSRTTime((u.endTime || u.startTime + 5000) - currentMeeting.utterances[0].startTime);
                const speaker = currentMeeting.speakers.find(s => s.id === u.speakerId)?.name || 'æœªçŸ¥';
                return `${i + 1}\n${start} --> ${end}\n${speaker}: ${u.text}\n`;
            }).join('\n');
        }

        function formatSRTTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            const milliseconds = Math.floor((ms % 1000) / 10);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')},${milliseconds.toString().padStart(2, '0')}`;
        }

        function exportAudio() {
            if (!currentMeeting?.audioBlob) {
                showToast('æ²¡æœ‰å¯å¯¼å‡ºçš„éŸ³é¢‘', 'error');
                return;
            }
            
            const url = URL.createObjectURL(currentMeeting.audioBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentMeeting.title}.webm`;
            a.click();
            
            showToast('éŸ³é¢‘å·²å¯¼å‡º', 'success');
        }

        function markTimestamp() {
            // æ·»åŠ æ—¶é—´æˆ³æ ‡è®°
            showToast('å·²æ ‡è®°é‡ç‚¹æ—¶åˆ»', 'success');
        }

        function endMeeting() {
            if (isRecording) {
                if (confirm('ç¡®å®šè¦ç»“æŸå½“å‰ä¼šè®®å—ï¼Ÿ')) {
                    stopRecording();
                }
            } else {
                showToast('å½“å‰æ²¡æœ‰è¿›è¡Œä¸­çš„ä¼šè®®', 'warning');
            }
        }

        function selectSpeaker(id) {
            transcriber.currentSpeaker = id;
            updateSpeakersList();
        }

        function editSpeaker(id) {
            const speaker = currentMeeting.speakers.find(s => s.id === id);
            const newName = prompt('ä¿®æ”¹å‘è¨€äººå§“å:', speaker?.name || '');
            if (newName && speaker) {
                speaker.name = newName;
                updateSpeakersList();
                // é‡æ–°æ¸²æŸ“æ‰€æœ‰è½¬å†™ä»¥æ›´æ–°åç§°
                document.getElementById('transcriptTimeline').innerHTML = '';
                currentMeeting.utterances.forEach(u => renderUtterance(u));
            }
        }

        function addSpeaker() {
            const count = currentMeeting.speakers.length + 1;
            currentMeeting.speakers.push({
                id: `speaker-${count}`,
                name: `å‘è¨€äºº ${count}`,
                color: (count % 6) || 6,
                wordCount: 0,
                duration: 0
            });
            updateSpeakersList();
        }

        function showSearch() {
            const term = prompt('æœç´¢è½¬å†™å†…å®¹:');
            if (term) {
                // é«˜äº®åŒ¹é…æ–‡æœ¬
                document.querySelectorAll('.utterance-text').forEach(el => {
                    const text = el.textContent;
                    if (text.includes(term)) {
                        const regex = new RegExp(term, 'gi');
                        el.innerHTML = escapeHtml(text).replace(regex, match => `<span class="highlight">${match}</span>`);
                        el.parentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });
            }
        }

        function toggleMobileMenu() {
            // ç§»åŠ¨ç«¯ä¾§è¾¹æ åˆ‡æ¢
        }

        function showToast(message, type = 'info') {
            // ç®€å•çš„ toast å®ç°
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#0ea5e9'};
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                font-weight: 500;
                z-index: 1000;
                animation: slideDown 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
