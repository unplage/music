<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>云音乐播放器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: "PingFang SC", "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.5;
            overflow-x: hidden;
            max-width: 500px;
            margin: 0 auto;
            background: linear-gradient(180deg, #ec4141 0%, #f5f5f5 100%);
            min-height: 100vh;
            position: relative;
        }

        /* 顶部栏 */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            color: white;
            position: relative;
            z-index: 10;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
        }

        .header-icons {
            display: flex;
            gap: 20px;
        }

        .header-icons i {
            font-size: 18px;
            cursor: pointer;
        }

        /* 播放器主体 */
        .player-container {
            padding: 0 20px;
            margin-top: 10px;
            position: relative;
            z-index: 5;
        }

        /* 唱片区域 */
        .disc-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto;
            margin-top: 20px;
        }

        .disc {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(135deg, #333 0%, #111 100%);
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: rotate 20s linear infinite;
            animation-play-state: paused;
        }

        .disc.playing {
            animation-play-state: running;
        }

        .disc-center {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: white;
            position: absolute;
            z-index: 2;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        }

        .album-cover {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            object-fit: cover;
            position: relative;
            z-index: 1;
        }

        /* 歌曲信息 */
        .song-info {
            text-align: center;
            margin-top: 30px;
            color: white;
        }

        .song-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 0 10px;
        }

        .song-artist {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.8);
        }

        /* 进度条 */
        .progress-container {
            margin-top: 40px;
            padding: 0 10px;
        }

        .progress-time {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: white;
            margin-bottom: 8px;
        }

        .progress-bar {
            width: 100%;
            height: 3px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }

        .progress {
            height: 100%;
            background-color: white;
            border-radius: 2px;
            width: 0%;
            position: relative;
        }

        .progress-handle {
            position: absolute;
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: white;
            display: none;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }

        .progress-bar:hover .progress-handle,
        .progress-bar.dragging .progress-handle {
            display: block;
        }

        /* 播放控制 */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 50px;
            padding: 0 30px;
        }

        .control-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .control-btn.play-pause {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: white;
            color: #ec4141;
            font-size: 28px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* 播放列表 */
        .playlist-container {
            background-color: white;
            border-radius: 20px 20px 0 0;
            margin-top: 60px;
            padding: 25px 20px 100px 20px;
            min-height: 300px;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.05);
        }

        .playlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .playlist-title {
            font-size: 18px;
            font-weight: 600;
        }

        .playlist-count {
            font-size: 14px;
            color: #999;
        }

        .song-list {
            list-style: none;
        }

        .song-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .song-item:hover {
            background-color: #f9f9f9;
        }

        .song-item.active {
            color: #ec4141;
        }

        .song-index {
            width: 30px;
            text-align: center;
            font-size: 16px;
            color: #999;
        }

        .song-item.active .song-index {
            color: #ec4141;
        }

        .song-info-small {
            flex: 1;
            overflow: hidden;
        }

        .song-title-small {
            font-size: 16px;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .song-artist-small {
            font-size: 12px;
            color: #999;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .song-duration {
            font-size: 14px;
            color: #999;
            margin-right: 10px;
        }

        /* 搜索区域 */
        .search-container {
            padding: 15px 20px;
            background-color: white;
            border-radius: 10px;
            margin: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            display: none;
        }

        .search-box {
            display: flex;
            align-items: center;
            background-color: #f5f5f5;
            border-radius: 20px;
            padding: 10px 15px;
        }

        .search-box i {
            color: #999;
            margin-right: 10px;
        }

        .search-box input {
            flex: 1;
            border: none;
            background: none;
            outline: none;
            font-size: 16px;
        }

        .search-results {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        /* 底部播放栏 */
        .mini-player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            padding: 10px 20px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            max-width: 500px;
            margin: 0 auto;
            z-index: 100;
        }

        .mini-player-info {
            flex: 1;
            overflow: hidden;
        }

        .mini-player-title {
            font-size: 16px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-bottom: 2px;
        }

        .mini-player-artist {
            font-size: 12px;
            color: #999;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .mini-player-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .mini-player-btn {
            background: none;
            border: none;
            font-size: 18px;
            color: #ec4141;
            cursor: pointer;
        }

        /* 动画 */
        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        /* 响应式调整 */
        @media (max-width: 380px) {
            .disc-container {
                width: 260px;
                height: 260px;
            }
            
            .album-cover {
                width: 170px;
                height: 170px;
            }
            
            .song-title {
                font-size: 20px;
            }
        }

        /* 加载动画 */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* 错误提示 */
        .error-message {
            background-color: rgba(255, 0, 0, 0.1);
            color: #d32f2f;
            padding: 10px 15px;
            border-radius: 5px;
            margin: 20px;
            text-align: center;
            display: none;
        }

        /* 歌词面板 */
        .lyrics-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 80px 20px 120px 20px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            max-width: 500px;
            margin: 0 auto;
        }

        .lyrics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        .lyrics-title {
            font-size: 20px;
            font-weight: 600;
        }

        .lyrics-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .lyrics-content {
            text-align: center;
            font-size: 18px;
            line-height: 2.5;
        }

        .lyric-line {
            margin-bottom: 15px;
            opacity: 0.5;
            transition: all 0.3s;
        }

        .lyric-line.active {
            opacity: 1;
            font-size: 22px;
            color: #ec4141;
        }
    </style>
</head>
<body>
    <!-- 顶部栏 -->
    <div class="header">
        <h1>云音乐</h1>
        <div class="header-icons">
            <i class="fas fa-search" id="searchToggle"></i>
            <i class="fas fa-list" id="playlistToggle"></i>
        </div>
    </div>

    <!-- 搜索区域 -->
    <div class="search-container" id="searchContainer">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="搜索歌曲、歌手">
        </div>
        <div class="search-results" id="searchResults"></div>
    </div>

    <!-- 错误提示 -->
    <div class="error-message" id="errorMessage"></div>

    <!-- 播放器主体 -->
    <div class="player-container" id="playerContainer">
        <!-- 唱片区域 -->
        <div class="disc-container">
            <div class="disc" id="disc">
                <img src="https://picsum.photos/200/200?random=1" alt="专辑封面" class="album-cover" id="albumCover">
                <div class="disc-center"></div>
            </div>
        </div>

        <!-- 歌曲信息 -->
        <div class="song-info">
            <h2 class="song-title" id="songTitle">歌曲名称</h2>
            <p class="song-artist" id="songArtist">歌手名</p>
        </div>

        <!-- 进度条 -->
        <div class="progress-container">
            <div class="progress-time">
                <span id="currentTime">0:00</span>
                <span id="totalTime">0:00</span>
            </div>
            <div class="progress-bar" id="progressBar">
                <div class="progress" id="progress">
                    <div class="progress-handle"></div>
                </div>
            </div>
        </div>

        <!-- 播放控制 -->
        <div class="controls">
            <button class="control-btn" id="prevBtn">
                <i class="fas fa-step-backward"></i>
            </button>
            <button class="control-btn play-pause" id="playBtn">
                <i class="fas fa-play" id="playIcon"></i>
            </button>
            <button class="control-btn" id="nextBtn">
                <i class="fas fa-step-forward"></i>
            </button>
        </div>
    </div>

    <!-- 播放列表 -->
    <div class="playlist-container" id="playlistContainer">
        <div class="playlist-header">
            <div class="playlist-title">播放列表</div>
            <div class="playlist-count">共 <span id="songCount">0</span> 首</div>
        </div>
        <ul class="song-list" id="songList">
            <!-- 歌曲列表将通过JavaScript动态生成 -->
        </ul>
    </div>

    <!-- 歌词面板 -->
    <div class="lyrics-container" id="lyricsContainer">
        <div class="lyrics-header">
            <div class="lyrics-title">歌词</div>
            <button class="lyrics-close" id="lyricsClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="lyrics-content" id="lyricsContent">
            <!-- 歌词将通过JavaScript动态生成 -->
        </div>
    </div>

    <!-- 底部播放栏 -->
    <div class="mini-player" id="miniPlayer">
        <div class="mini-player-info">
            <div class="mini-player-title" id="miniPlayerTitle">歌曲名称</div>
            <div class="mini-player-artist" id="miniPlayerArtist">歌手名</div>
        </div>
        <div class="mini-player-controls">
            <button class="mini-player-btn" id="miniPlayBtn">
                <i class="fas fa-play" id="miniPlayIcon"></i>
            </button>
            <button class="mini-player-btn" id="lyricsBtn">
                <i class="fas fa-microphone"></i>
            </button>
        </div>
    </div>

    <!-- 音频元素 -->
    <audio id="audioPlayer" preload="metadata"></audio>

    <script>
        // 音乐API配置
        // 注意：由于浏览器安全限制，这里使用一个公开的音乐API示例
        // 在实际部署中，你可能需要设置一个代理服务器或使用支持CORS的API
        const API_BASE_URL = 'https://api.deezer.com';
        
        // 默认播放列表 - 如果API不可用，将使用此列表作为备选
        const defaultPlaylist = [
            {
                id: 1,
                title: "Blinding Lights",
                artist: "The Weeknd",
                duration: 200,
                cover: "https://picsum.photos/200/200?random=1",
                preview: "https://cdns-preview-6.dzcdn.net/stream/c-6e7a5f8a3e86d5b1c5e4d9c7b8a9f6e5-3.mp3"
            },
            {
                id: 2,
                title: "Stay",
                artist: "The Kid LAROI, Justin Bieber",
                duration: 141,
                cover: "https://picsum.photos/200/200?random=2",
                preview: "https://cdns-preview-5.dzcdn.net/stream/c-5e8c9f7d6b4a3e2d1c0b9a8b7c6d5e4f-3.mp3"
            },
            {
                id: 3,
                title: "Good 4 U",
                artist: "Olivia Rodrigo",
                duration: 178,
                cover: "https://picsum.photos/200/200?random=3",
                preview: "https://cdns-preview-7.dzcdn.net/stream/c-7d9e8f7c6b5a4e3d2c1b0a9f8e7d6c5b-3.mp3"
            },
            {
                id: 4,
                title: "Levitating",
                artist: "Dua Lipa",
                duration: 203,
                cover: "https://picsum.photos/200/200?random=4",
                preview: "https://cdns-preview-8.dzcdn.net/stream/c-8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c-3.mp3"
            },
            {
                id: 5,
                title: "Save Your Tears",
                artist: "The Weeknd",
                duration: 215,
                cover: "https://picsum.photos/200/200?random=5",
                preview: "https://cdns-preview-9.dzcdn.net/stream/c-9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d-3.mp3"
            }
        ];

        // 应用状态
        const state = {
            playlist: [],
            currentSongIndex: 0,
            isPlaying: false,
            currentTime: 0,
            duration: 0,
            isSearchVisible: false
        };

        // DOM元素
        const elements = {
            audioPlayer: document.getElementById('audioPlayer'),
            disc: document.getElementById('disc'),
            albumCover: document.getElementById('albumCover'),
            songTitle: document.getElementById('songTitle'),
            songArtist: document.getElementById('songArtist'),
            playBtn: document.getElementById('playBtn'),
            playIcon: document.getElementById('playIcon'),
            prevBtn: document.getElementById('prevBtn'),
            nextBtn: document.getElementById('nextBtn'),
            progressBar: document.getElementById('progressBar'),
            progress: document.getElementById('progress'),
            currentTime: document.getElementById('currentTime'),
            totalTime: document.getElementById('totalTime'),
            songList: document.getElementById('songList'),
            songCount: document.getElementById('songCount'),
            searchToggle: document.getElementById('searchToggle'),
            searchContainer: document.getElementById('searchContainer'),
            searchInput: document.getElementById('searchInput'),
            searchResults: document.getElementById('searchResults'),
            playerContainer: document.getElementById('playerContainer'),
            playlistContainer: document.getElementById('playlistContainer'),
            playlistToggle: document.getElementById('playlistToggle'),
            miniPlayer: document.getElementById('miniPlayer'),
            miniPlayerTitle: document.getElementById('miniPlayerTitle'),
            miniPlayerArtist: document.getElementById('miniPlayerArtist'),
            miniPlayBtn: document.getElementById('miniPlayBtn'),
            miniPlayIcon: document.getElementById('miniPlayIcon'),
            errorMessage: document.getElementById('errorMessage'),
            lyricsContainer: document.getElementById('lyricsContainer'),
            lyricsContent: document.getElementById('lyricsContent'),
            lyricsClose: document.getElementById('lyricsClose'),
            lyricsBtn: document.getElementById('lyricsBtn')
        };

        // 初始化应用
        function init() {
            // 加载默认播放列表
            loadDefaultPlaylist();
            
            // 设置事件监听器
            setupEventListeners();
            
            // 更新UI
            updatePlaylistUI();
            
            // 加载第一首歌
            loadSong(state.currentSongIndex);
        }

        // 加载默认播放列表
        function loadDefaultPlaylist() {
            state.playlist = [...defaultPlaylist];
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 播放/暂停按钮
            elements.playBtn.addEventListener('click', togglePlay);
            elements.miniPlayBtn.addEventListener('click', togglePlay);
            
            // 上一首/下一首按钮
            elements.prevBtn.addEventListener('click', playPrev);
            elements.nextBtn.addEventListener('click', playNext);
            
            // 音频事件
            elements.audioPlayer.addEventListener('timeupdate', updateProgress);
            elements.audioPlayer.addEventListener('loadedmetadata', updateDuration);
            elements.audioPlayer.addEventListener('ended', playNext);
            elements.audioPlayer.addEventListener('error', handleAudioError);
            
            // 进度条点击事件
            elements.progressBar.addEventListener('click', seekToPosition);
            
            // 搜索功能
            elements.searchToggle.addEventListener('click', toggleSearch);
            elements.searchInput.addEventListener('input', debounce(handleSearch, 500));
            
            // 播放列表切换
            elements.playlistToggle.addEventListener('click', togglePlaylist);
            
            // 歌词功能
            elements.lyricsBtn.addEventListener('click', showLyrics);
            elements.lyricsClose.addEventListener('click', hideLyrics);
            
            // 触摸事件处理进度条拖动
            let isDragging = false;
            
            elements.progressBar.addEventListener('touchstart', (e) => {
                isDragging = true;
                elements.progressBar.classList.add('dragging');
                handleProgressDrag(e);
            });
            
            document.addEventListener('touchmove', (e) => {
                if (isDragging) {
                    handleProgressDrag(e);
                    e.preventDefault();
                }
            });
            
            document.addEventListener('touchend', () => {
                if (isDragging) {
                    isDragging = false;
                    elements.progressBar.classList.remove('dragging');
                    // 当拖动结束时，跳转到相应位置
                    const progressRect = elements.progressBar.getBoundingClientRect();
                    const progressWidth = progressRect.width;
                    const clickX = lastTouchX - progressRect.left;
                    const percentage = clickX / progressWidth;
                    seekToPercentage(percentage);
                }
            });
            
            let lastTouchX = 0;
            
            function handleProgressDrag(e) {
                const touch = e.touches[0];
                lastTouchX = touch.clientX;
                const progressRect = elements.progressBar.getBoundingClientRect();
                const progressWidth = progressRect.width;
                const clickX = lastTouchX - progressRect.left;
                const percentage = Math.max(0, Math.min(1, clickX / progressWidth));
                
                // 更新进度条UI但不实际跳转
                updateProgressUI(percentage * state.duration, state.duration);
            }
            
            // 点击播放列表中的歌曲
            elements.songList.addEventListener('click', (e) => {
                const songItem = e.target.closest('.song-item');
                if (songItem) {
                    const index = parseInt(songItem.dataset.index);
                    loadSong(index);
                    play();
                }
            });
        }

        // 加载歌曲
        function loadSong(index) {
            if (index < 0 || index >= state.playlist.length) return;
            
            state.currentSongIndex = index;
            const song = state.playlist[index];
            
            // 更新音频源
            elements.audioPlayer.src = song.preview;
            
            // 更新UI
            updateSongUI(song);
            updateActiveSongInPlaylist();
            
            // 预加载下一首
            preloadNextSong();
            
            // 显示底部迷你播放器
            elements.miniPlayer.style.display = 'flex';
        }

        // 更新歌曲UI
        function updateSongUI(song) {
            elements.albumCover.src = song.cover;
            elements.songTitle.textContent = song.title;
            elements.songArtist.textContent = song.artist;
            elements.miniPlayerTitle.textContent = song.title;
            elements.miniPlayerArtist.textContent = song.artist;
            
            // 更新总时长
            updateDuration();
        }

        // 更新播放列表UI
        function updatePlaylistUI() {
            elements.songList.innerHTML = '';
            elements.songCount.textContent = state.playlist.length;
            
            state.playlist.forEach((song, index) => {
                const li = document.createElement('li');
                li.className = 'song-item';
                li.dataset.index = index;
                
                const durationFormatted = formatTime(song.duration);
                
                li.innerHTML = `
                    <div class="song-index">${index + 1}</div>
                    <div class="song-info-small">
                        <div class="song-title-small">${song.title}</div>
                        <div class="song-artist-small">${song.artist}</div>
                    </div>
                    <div class="song-duration">${durationFormatted}</div>
                `;
                
                elements.songList.appendChild(li);
            });
            
            updateActiveSongInPlaylist();
        }

        // 更新活动歌曲在播放列表中的状态
        function updateActiveSongInPlaylist() {
            document.querySelectorAll('.song-item').forEach((item, index) => {
                if (index === state.currentSongIndex) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // 播放/暂停切换
        function togglePlay() {
            if (state.isPlaying) {
                pause();
            } else {
                play();
            }
        }

        // 播放
        function play() {
            elements.audioPlayer.play()
                .then(() => {
                    state.isPlaying = true;
                    elements.playIcon.className = 'fas fa-pause';
                    elements.miniPlayIcon.className = 'fas fa-pause';
                    elements.disc.classList.add('playing');
                })
                .catch(error => {
                    showError('无法播放音频：' + error.message);
                });
        }

        // 暂停
        function pause() {
            elements.audioPlayer.pause();
            state.isPlaying = false;
            elements.playIcon.className = 'fas fa-play';
            elements.miniPlayIcon.className = 'fas fa-play';
            elements.disc.classList.remove('playing');
        }

        // 播放上一首
        function playPrev() {
            let newIndex = state.currentSongIndex - 1;
            if (newIndex < 0) {
                newIndex = state.playlist.length - 1;
            }
            loadSong(newIndex);
            play();
        }

        // 播放下一首
        function playNext() {
            let newIndex = state.currentSongIndex + 1;
            if (newIndex >= state.playlist.length) {
                newIndex = 0;
            }
            loadSong(newIndex);
            play();
        }

        // 更新进度
        function updateProgress() {
            state.currentTime = elements.audioPlayer.currentTime;
            state.duration = elements.audioPlayer.duration || state.playlist[state.currentSongIndex].duration;
            
            updateProgressUI(state.currentTime, state.duration);
        }

        // 更新进度UI
        function updateProgressUI(currentTime, duration) {
            if (duration) {
                const percentage = (currentTime / duration) * 100;
                elements.progress.style.width = `${percentage}%`;
                elements.currentTime.textContent = formatTime(currentTime);
                elements.totalTime.textContent = formatTime(duration);
            }
        }

        // 更新时长
        function updateDuration() {
            state.duration = elements.audioPlayer.duration || state.playlist[state.currentSongIndex].duration;
            elements.totalTime.textContent = formatTime(state.duration);
        }

        // 跳转到指定位置
        function seekToPosition(e) {
            const progressRect = elements.progressBar.getBoundingClientRect();
            const progressWidth = progressRect.width;
            const clickX = e.clientX - progressRect.left;
            const percentage = clickX / progressWidth;
            
            seekToPercentage(percentage);
        }

        // 按百分比跳转
        function seekToPercentage(percentage) {
            const time = percentage * state.duration;
            elements.audioPlayer.currentTime = time;
        }

        // 切换搜索显示
        function toggleSearch() {
            state.isSearchVisible = !state.isSearchVisible;
            
            if (state.isSearchVisible) {
                elements.searchContainer.style.display = 'block';
                elements.playerContainer.style.display = 'none';
                elements.playlistContainer.style.display = 'none';
                elements.searchInput.focus();
            } else {
                elements.searchContainer.style.display = 'none';
                elements.playerContainer.style.display = 'block';
                elements.playlistContainer.style.display = 'block';
            }
        }

        // 切换播放列表显示
        function togglePlaylist() {
            const isVisible = elements.playlistContainer.style.display !== 'none';
            
            if (isVisible) {
                elements.playlistContainer.style.display = 'none';
                elements.playerContainer.style.display = 'block';
            } else {
                elements.playlistContainer.style.display = 'block';
                elements.playerContainer.style.display = 'none';
            }
        }

        // 搜索处理
        function handleSearch() {
            const query = elements.searchInput.value.trim();
            
            if (query.length === 0) {
                elements.searchResults.innerHTML = '';
                elements.searchResults.style.display = 'none';
                return;
            }
            
            // 显示加载状态
            elements.searchResults.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">搜索中...</div>';
            elements.searchResults.style.display = 'block';
            
            // 在实际应用中，这里应该调用音乐API
            // 由于CORS限制，这里使用模拟数据
            setTimeout(() => {
                const mockResults = [
                    {
                        id: 101,
                        title: `搜索结果: ${query}`,
                        artist: "示例歌手",
                        duration: 180,
                        cover: "https://picsum.photos/200/200?random=101",
                        preview: "https://cdns-preview-0.dzcdn.net/stream/c-0a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d-3.mp3"
                    },
                    {
                        id: 102,
                        title: `另一首关于 ${query} 的歌`,
                        artist: "另一位歌手",
                        duration: 210,
                        cover: "https://picsum.photos/200/200?random=102",
                        preview: "https://cdns-preview-1.dzcdn.net/stream/c-1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e-3.mp3"
                    }
                ];
                
                displaySearchResults(mockResults);
            }, 800);
        }

        // 显示搜索结果
        function displaySearchResults(results) {
            if (results.length === 0) {
                elements.searchResults.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">未找到相关歌曲</div>';
                return;
            }
            
            let html = '';
            results.forEach((song, index) => {
                html += `
                    <div class="song-item" data-search-index="${index}">
                        <div class="song-index">${index + 1}</div>
                        <div class="song-info-small">
                            <div class="song-title-small">${song.title}</div>
                            <div class="song-artist-small">${song.artist}</div>
                        </div>
                        <div class="song-duration">${formatTime(song.duration)}</div>
                    </div>
                `;
            });
            
            elements.searchResults.innerHTML = html;
            
            // 为搜索结果添加点击事件
            document.querySelectorAll('.search-results .song-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.dataset.searchIndex);
                    const song = results[index];
                    
                    // 添加到播放列表并播放
                    state.playlist.unshift(song);
                    updatePlaylistUI();
                    loadSong(0);
                    play();
                    
                    // 关闭搜索
                    toggleSearch();
                    elements.searchInput.value = '';
                });
            });
        }

        // 防抖函数
        function debounce(func, delay) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // 预加载下一首歌曲
        function preloadNextSong() {
            const nextIndex = (state.currentSongIndex + 1) % state.playlist.length;
            const nextSong = state.playlist[nextIndex];
            
            if (nextSong && nextSong.preview) {
                // 创建临时音频元素预加载
                const tempAudio = new Audio();
                tempAudio.src = nextSong.preview;
                tempAudio.preload = 'metadata';
            }
        }

        // 显示歌词
        function showLyrics() {
            // 在实际应用中，这里应该从API获取歌词
            // 这里使用模拟歌词
            const lyrics = [
                "这是第一句歌词",
                "这是第二句歌词",
                "这是当前播放的歌词",
                "这是第四句歌词",
                "这是第五句歌词",
                "这是第六句歌词",
                "这是第七句歌词",
                "这是第八句歌词"
            ];
            
            let lyricsHTML = '';
            lyrics.forEach((line, index) => {
                const activeClass = index === 2 ? 'active' : '';
                lyricsHTML += `<div class="lyric-line ${activeClass}">${line}</div>`;
            });
            
            elements.lyricsContent.innerHTML = lyricsHTML;
            elements.lyricsContainer.style.display = 'block';
        }

        // 隐藏歌词
        function hideLyrics() {
            elements.lyricsContainer.style.display = 'none';
        }

        // 处理音频错误
        function handleAudioError() {
            showError('无法加载音频。可能的原因：网络问题、音频文件损坏或浏览器不支持该格式。');
            pause();
        }

        // 显示错误信息
        function showError(message) {
            elements.errorMessage.textContent = message;
            elements.errorMessage.style.display = 'block';
            
            setTimeout(() => {
                elements.errorMessage.style.display = 'none';
            }, 5000);
        }

        // 格式化时间 (秒 -> 分:秒)
        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
