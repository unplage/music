<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="AIäººä½“æ£€æµ‹å™¨ - åŸºäºYOLO11æ·±åº¦å­¦ä¹ ">
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoi8J+nqOWwgeW4uOacuuWKqOeUuOaWryIsInNob3J0X25hbWUiOiLwn6eo5bCB5bi45py65Yqo55S4Iiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwZjE3MmEiLCJ0aGVtZV9jb2xvciI6IiMzYjgyZjYifQ==">
    <title>AIäººä½“æ£€æµ‹å™¨ Â· YOLO11ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.16.3/dist/ort.min.js"></script>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #06b6d4;
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --person-color: #00ff88;
            --person-bg: rgba(0, 255, 136, 0.2);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }
        
        /* Splash Screen */
        .splash { position: fixed; inset: 0; background: linear-gradient(135deg, #1e3a8a 0%, #0f172a 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s; }
        .splash.hidden { opacity: 0; pointer-events: none; }
        .splash-icon { font-size: 100px; margin-bottom: 20px; animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.1)} }
        .splash-text { font-size: 1.8rem; font-weight: 700; margin-bottom: 10px; }
        .splash-subtitle { color: var(--text-muted); margin-bottom: 30px; max-width: 80%; text-align: center; }
        .loading-bar { width: 280px; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; overflow: hidden; margin-bottom: 20px; }
        .loading-progress { height: 100%; background: linear-gradient(90deg, var(--primary), var(--success)); width: 0%; transition: width 0.3s; }
        .splash-actions { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin-top: 20px; }
        .splash-btn { padding: 14px 28px; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .splash-btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
        .splash-btn-secondary { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); }
        .model-selector { background: var(--card); border-radius: 16px; padding: 24px; margin-top: 20px; max-width: 500px; width: 90%; }
        .model-selector-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 16px; color: var(--text); }
        .model-option { display: flex; align-items: center; gap: 12px; padding: 14px; background: var(--bg); border-radius: 10px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .model-option:hover { border-color: var(--primary); }
        .model-option.selected { border-color: var(--primary); background: rgba(59, 130, 246, 0.15); }
        .model-option-icon { font-size: 1.8rem; }
        .model-option-info { flex: 1; text-align: left; }
        .model-option-name { font-weight: 600; font-size: 0.95rem; }
        .model-option-desc { font-size: 0.85rem; color: var(--text-muted); margin-top: 4px; }
        
        /* Main App */
        .app { max-width: 100vw; min-height: 100vh; display: flex; flex-direction: column; }
        header { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); padding: 20px; text-align: center; box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3); position: sticky; top: 0; z-index: 100; }
        h1 { font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .version-badge { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; }
        .header-stats { display: flex; justify-content: center; gap: 20px; margin-top: 12px; flex-wrap: wrap; }
        .header-stat { display: flex; align-items: center; gap: 6px; font-size: 0.9rem; background: rgba(0,0,0,0.2); padding: 6px 12px; border-radius: 20px; }
        
        main { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 20px; max-width: 1200px; margin: 0 auto; width: 100%; }
        
        /* Upload Section */
        .upload-card { background: var(--card); border-radius: 24px; padding: 40px 30px; text-align: center; border: 2px dashed var(--secondary); transition: all 0.3s; cursor: pointer; }
        .upload-card:hover, .upload-card.active { border-color: var(--primary); background: rgba(59, 130, 246, 0.1); transform: translateY(-2px); }
        .upload-icon { font-size: 72px; margin-bottom: 20px; }
        .upload-title { font-size: 1.4rem; margin-bottom: 10px; font-weight: 600; }
        .upload-subtitle { color: var(--text-muted); margin-bottom: 30px; font-size: 0.95rem; }
        .upload-features { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin-bottom: 25px; }
        .feature-item { display: flex; align-items: center; gap: 6px; font-size: 0.85rem; color: var(--text-muted); background: var(--bg); padding: 8px 14px; border-radius: 20px; }
        .btn-group { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .btn { padding: 14px 28px; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-success { background: var(--success); color: white; }
        input[type="file"] { display: none; }
        
        /* Viewer Section */
        .viewer { display: none; flex-direction: column; gap: 20px; animation: fadeIn 0.5s; }
        .viewer.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Control Panel */
        .control-panel { background: var(--card); border-radius: 20px; padding: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .control-section { display: flex; flex-direction: column; gap: 12px; }
        .section-title { font-size: 0.9rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px; }
        .slider-group { display: flex; flex-direction: column; gap: 8px; }
        .slider-header { display: flex; justify-content: space-between; align-items: center; }
        .slider-label { font-size: 0.9rem; }
        .slider-value { background: var(--bg); padding: 4px 12px; border-radius: 6px; font-size: 0.85rem; font-weight: 600; color: var(--primary); min-width: 50px; text-align: center; }
        input[type="range"] { width: 100%; height: 6px; -webkit-appearance: none; background: var(--bg); border-radius: 3px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: var(--primary); border-radius: 50%; cursor: pointer; transition: transform 0.2s; }
        input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.2); }
        .action-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn-small { padding: 10px 16px; font-size: 0.85rem; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--secondary); color: var(--text); }
        
        /* Image Viewer */
        .image-wrapper { position: relative; background: var(--card); border-radius: 20px; overflow: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.4); max-height: 70vh; }
        .canvas-container { position: relative; display: inline-block; min-width: 100%; }
        #mainCanvas { display: block; width: auto; height: auto; background: #1e293b; max-width: none; }
        .overlay-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* Person Detection Box */
        .person-box { position: absolute; border: 3px solid var(--person-color); background: var(--person-bg); pointer-events: auto; cursor: pointer; z-index: 10; transition: all 0.2s; display: flex; flex-direction: column; }
        .person-box:hover { z-index: 20; border-color: #fff; background: rgba(0, 255, 136, 0.3); transform: scale(1.02); }
        .person-label { position: absolute; top: -28px; left: 0; background: var(--person-color); color: #000; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 700; white-space: nowrap; }
        .person-confidence { position: absolute; bottom: 4px; right: 4px; background: rgba(0,0,0,0.7); color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 11px; }
        
        /* Stats Panel */
        .stats-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .stat-box { background: var(--card); border-radius: 16px; padding: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.1); transition: transform 0.2s; }
        .stat-box:hover { transform: translateY(-2px); border-color: var(--primary); }
        .stat-number { font-size: 2.5rem; font-weight: 700; color: var(--primary); display: block; line-height: 1; }
        .stat-label { font-size: 0.85rem; color: var(--text-muted); margin-top: 8px; }
        .stat-box.success .stat-number { color: var(--success); }
        .stat-box.warning .stat-number { color: var(--warning); }
        .stat-box.info .stat-number { color: var(--info); }
        
        /* Loading Overlay */
        .loading-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); display: none; justify-content: center; align-items: center; flex-direction: column; z-index: 9998; }
        .loading-overlay.active { display: flex; }
        .spinner { width: 60px; height: 60px; border: 4px solid rgba(59, 130, 246, 0.2); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 20px; font-size: 1.2rem; color: var(--text); font-weight: 600; }
        .loading-subtext { margin-top: 10px; font-size: 0.9rem; color: var(--text-muted); }
        
        /* Toast */
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--card); color: var(--text); padding: 16px 24px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); opacity: 0; transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); z-index: 10000; display: flex; align-items: center; gap: 10px; font-weight: 500; max-width: 90%; text-align: center; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        
        /* Install Button */
        .install-btn { position: fixed; bottom: 20px; right: 20px; background: var(--success); color: white; padding: 14px 24px; border-radius: 50px; border: none; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: none; z-index: 9999; animation: slideIn 0.3s ease; }
        .install-btn.show { display: block; }
        @keyframes slideIn { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* Responsive */
        @media (max-width: 768px) { 
            h1 { font-size: 1.2rem; } 
            .upload-title { font-size: 1.2rem; } 
            .control-panel { grid-template-columns: 1fr; } 
            .stats-panel { grid-template-columns: repeat(2, 1fr); }
            .header-stats { font-size: 0.8rem; }
        }
    </style>
</head>
<body>
    <!-- PWA Install Button -->
    <button class="install-btn" id="installBtn" onclick="installPWA()">ğŸ“² å®‰è£…åº”ç”¨</button>
    
    <!-- Splash Screen -->
    <div class="splash" id="splash">
        <div class="splash-icon">ğŸš¶</div>
        <div class="splash-text">AIäººä½“æ£€æµ‹å™¨</div>
        <div class="splash-subtitle">åŸºäºYOLO11æ·±åº¦å­¦ä¹  Â· å®æ—¶äººä½“è¯†åˆ«</div>
        
        <div class="loading-bar" id="loadingBar" style="display: none;">
            <div class="loading-progress" id="loadingProgress" style="width: 0%"></div>
        </div>
        
        <div class="model-selector" id="modelSelector">
            <div class="model-selector-title">ğŸ¤– é€‰æ‹©æ£€æµ‹æ¨¡å‹</div>
            
            <div class="model-option selected" onclick="selectModelSource('yolo11')" id="optionYolo11">
                <div class="model-option-icon">ğŸš€</div>
                <div class="model-option-info">
                    <div class="model-option-name">YOLO11nï¼ˆæ¨èï¼‰</div>
                    <div class="model-option-desc">å®˜æ–¹é¢„è®­ç»ƒæ¨¡å‹ï¼ŒCOCOæ•°æ®é›†ï¼Œä¸“æ³¨äººä½“æ£€æµ‹</div>
                </div>
            </div>
            
            <div class="model-option" onclick="selectModelSource('yolo11-face')" id="optionYoloFace">
                <div class="model-option-icon">ğŸ˜Š</div>
                <div class="model-option-info">
                    <div class="model-option-name">YOLO11n-Faceï¼ˆäººè„¸ï¼‰</div>
                    <div class="model-option-desc">ä¸“é—¨äººè„¸æ£€æµ‹æ¨¡å‹ï¼ˆéœ€é¢å¤–ä¸‹è½½ï¼‰</div>
                </div>
            </div>
            
            <div class="model-option" onclick="selectModelSource('local')" id="optionLocal">
                <div class="model-option-icon">ğŸ’»</div>
                <div class="model-option-info">
                    <div class="model-option-name">æœ¬åœ°ä¸Šä¼ </div>
                    <div class="model-option-desc">è‡ªå®šä¹‰è®­ç»ƒçš„ONNXæ¨¡å‹</div>
                </div>
            </div>
            
            <div class="splash-actions" style="margin-top: 24px;">
                <button class="splash-btn splash-btn-primary" onclick="confirmModelSource()">
                    <span>â¬‡ï¸</span><span id="primaryBtnText">åŠ è½½YOLO11n</span>
                </button>
                <button class="splash-btn splash-btn-secondary" onclick="skipToDemo()">
                    <span>â–¶ï¸</span><span>å…ˆè¯•ç”¨</span>
                </button>
            </div>
            
            <input type="file" id="modelFileInput" accept=".onnx" style="display: none;" onchange="handleModelFile(event)">
        </div>
        
        <div id="loadingStatus" style="display: none; margin-top: 20px; text-align: center;">
            <div class="model-status loading">
                <span>â³</span><span id="loadingText">æ­£åœ¨åŠ è½½æ¨¡å‹...</span>
            </div>
            <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 10px;" id="loadingDetail"></div>
        </div>
    </div>
    
    <!-- Main App -->
    <div class="app">
        <header>
            <h1><span>ğŸš¶</span><span>AIäººä½“æ£€æµ‹å™¨</span><span class="version-badge" id="versionBadge">å°±ç»ª</span></h1>
            <div class="header-stats">
                <span class="header-stat" id="modelStatus"><span>â³</span><span>ç­‰å¾…åŠ è½½</span></span>
                <span class="header-stat" id="personCount"><span>ğŸ‘¥</span><span>0äºº</span></span>
                <span class="header-stat" id="fpsStat"><span>âš¡</span><span>0 FPS</span></span>
            </div>
        </header>
        
        <main>
            <!-- Upload Section -->
            <div class="upload-card" id="uploadCard">
                <div class="upload-icon">ğŸ“¸</div>
                <div class="upload-title">æ‹–æ”¾ç…§ç‰‡æˆ–ç‚¹å‡»ä¸Šä¼ </div>
                <div class="upload-subtitle">JPG / PNG / WEBP Â· è‡ªåŠ¨æ£€æµ‹äººä½“</div>
                <div class="upload-features">
                    <div class="feature-item"><span>ğŸ¯</span><span>äººä½“æ£€æµ‹</span></div>
                    <div class="feature-item"><span>ğŸ“Š</span><span>ç½®ä¿¡åº¦æ˜¾ç¤º</span></div>
                    <div class="feature-item"><span>ğŸ”’</span><span>æœ¬åœ°å¤„ç†</span></div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                        <span>ğŸ“</span><span>é€‰æ‹©ç…§ç‰‡</span>
                    </button>
                    <button class="btn btn-secondary" onclick="document.getElementById('cameraInput').click()">
                        <span>ğŸ“·</span><span>æ‹ç…§</span>
                    </button>
                    <button class="btn btn-success" onclick="startRealtimeDetection()" id="realtimeBtn" style="display: none;">
                        <span>ğŸ“¹</span><span>å®æ—¶æ£€æµ‹</span>
                    </button>
                </div>
                <input type="file" id="fileInput" accept="image/*">
                <input type="file" id="cameraInput" accept="image/*" capture="environment">
            </div>
            
            <!-- Viewer Section -->
            <div class="viewer" id="viewer">
                <div class="control-panel">
                    <div class="control-section">
                        <div class="section-title">âš™ï¸ æ£€æµ‹å‚æ•°</div>
                        <div class="slider-group">
                            <div class="slider-header">
                                <span class="slider-label">ç½®ä¿¡åº¦é˜ˆå€¼</span>
                                <span class="slider-value" id="confValue">0.25</span>
                            </div>
                            <input type="range" id="confThreshold" min="0.1" max="0.9" value="0.25" step="0.05">
                        </div>
                        <div class="slider-group">
                            <div class="slider-header">
                                <span class="slider-label">IoUé˜ˆå€¼ï¼ˆNMSï¼‰</span>
                                <span class="slider-value" id="iouValue">0.45</span>
                            </div>
                            <input type="range" id="iouThreshold" min="0.1" max="0.9" value="0.45" step="0.05">
                        </div>
                        <div class="slider-group">
                            <div class="slider-header">
                                <span class="slider-label">è¾“å…¥å°ºå¯¸</span>
                                <span class="slider-value" id="inputSizeValue">640</span>
                            </div>
                            <select id="inputSize" style="width: 100%; padding: 8px; border-radius: 6px; background: var(--bg); color: var(--text); border: 1px solid var(--secondary);">
                                <option value="320">320Ã—320ï¼ˆæœ€å¿«ï¼‰</option>
                                <option value="640" selected>640Ã—640ï¼ˆæ¨èï¼‰</option>
                                <option value="1280">1280Ã—1280ï¼ˆæœ€å‡†ï¼‰</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="control-section">
                        <div class="section-title">ğŸ¨ æ˜¾ç¤ºé€‰é¡¹</div>
                        <div class="slider-group">
                            <div class="slider-header">
                                <span class="slider-label">æ˜¾ç¤ºæ ‡ç­¾</span>
                            </div>
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="showLabels" checked style="width: 18px; height: 18px;">
                                <span>æ˜¾ç¤º"person"æ ‡ç­¾</span>
                            </label>
                        </div>
                        <div class="slider-group">
                            <div class="slider-header">
                                <span class="slider-label">æ˜¾ç¤ºç½®ä¿¡åº¦</span>
                            </div>
                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                <input type="checkbox" id="showConfidence" checked style="width: 18px; height: 18px;">
                                <span>æ˜¾ç¤ºç½®ä¿¡åº¦ç™¾åˆ†æ¯”</span>
                            </label>
                        </div>
                        <div class="slider-group">
                            <div class="slider-header">
                                <span class="slider-label">å›¾åƒç¼©æ”¾</span>
                                <span class="slider-value" id="zoomValue">1.0</span>
                            </div>
                            <input type="range" id="zoomSlider" min="0.1" max="3.0" value="1.0" step="0.1">
                        </div>
                    </div>
                    
                    <div class="control-section">
                        <div class="section-title">ğŸ› ï¸ æ“ä½œ</div>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-small" onclick="reanalyze()">
                                <span>ğŸ”„</span><span>é‡æ–°æ£€æµ‹</span>
                            </button>
                            <button class="btn btn-warning btn-small" onclick="saveResult()">
                                <span>ğŸ’¾</span><span>ä¿å­˜ç»“æœ</span>
                            </button>
                            <button class="btn btn-info btn-small" onclick="copyStats()">
                                <span>ğŸ“‹</span><span>å¤åˆ¶ç»Ÿè®¡</span>
                            </button>
                            <button class="btn btn-danger btn-small" onclick="resetApp()">
                                <span>ğŸ—‘ï¸</span><span>æ¸…ç©º</span>
                            </button>
                            <button class="btn btn-outline btn-small" onclick="switchModel()">
                                <span>ğŸ”„</span><span>åˆ‡æ¢æ¨¡å‹</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="image-wrapper" id="imageWrapper">
                    <div class="canvas-container" id="canvasContainer">
                        <canvas id="mainCanvas"></canvas>
                        <div class="overlay-layer" id="overlayLayer"></div>
                    </div>
                </div>
                
                <div class="stats-panel">
                    <div class="stat-box success">
                        <span class="stat-number" id="statPersonCount">0</span>
                        <div class="stat-label">æ£€æµ‹åˆ°çš„äººæ•°</div>
                    </div>
                    <div class="stat-box info">
                        <span class="stat-number" id="statAvgConfidence">0%</span>
                        <div class="stat-label">å¹³å‡ç½®ä¿¡åº¦</div>
                    </div>
                    <div class="stat-box warning">
                        <span class="stat-number" id="statProcessTime">0ms</span>
                        <div class="stat-label">å¤„ç†æ—¶é—´</div>
                    </div>
                    <div class="stat-box">
                        <span class="stat-number" id="statImageSize">-</span>
                        <div class="stat-label">å›¾åƒå°ºå¯¸</div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text" id="overlayLoadingText">æ£€æµ‹ä¸­...</div>
        <div class="loading-subtext" id="overlayLoadingSub">æ­£åœ¨åˆ†æå›¾åƒ</div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ==================== PWAæ”¯æŒ ====================
        let deferredPrompt;
        
        // æ³¨å†ŒService Worker
        if ('serviceWorker' in navigator) {
            const swCode = `
                self.addEventListener('install', e => self.skipWaiting());
                self.addEventListener('activate', e => e.waitUntil(clients.claim()));
                self.addEventListener('fetch', e => e.respondWith(
                    fetch(e.request).catch(() => caches.match(e.request))
                ));
            `;
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            navigator.serviceWorker.register(swUrl).then(() => {
                console.log('SW registered');
            });
        }
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBtn').classList.add('show');
        });
        
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choice) => {
                    if (choice.outcome === 'accepted') {
                        showToast('âœ… åº”ç”¨å·²å®‰è£…åˆ°æ¡Œé¢');
                    }
                    deferredPrompt = null;
                    document.getElementById('installBtn').classList.remove('show');
                });
            }
        }
        
        // ==================== æ¨¡å‹é…ç½® ====================
        const MODEL_SOURCES = {
            yolo11: {
                name: 'YOLO11n',
                url: 'https://github.com/ultralytics/assets/releases/download/v8.3.0/yolo11n.onnx',
                size: '5.4MB',
                type: 'person', // äººä½“æ£€æµ‹
                classes: ['person'],
                personClassId: 0 // COCOä¸­personæ˜¯ç¬¬0ç±»
            },
            'yolo11-face': {
                name: 'YOLO11n-Face',
                url: null, // éœ€è¦ç”¨æˆ·è‡ªå·±æä¾›
                size: '5.4MB',
                type: 'face',
                classes: ['face'],
                personClassId: 0
            },
            local: {
                name: 'è‡ªå®šä¹‰æ¨¡å‹',
                type: 'custom'
            }
        };
        
        let currentModelSource = 'yolo11';
        let session = null;
        let modelLoaded = false;
        let currentModelConfig = null;
        
        // ==================== å…¨å±€çŠ¶æ€ ====================
        let currentImage = null;
        let detections = []; // å­˜å‚¨æ£€æµ‹ç»“æœ
        let isRealtime = false;
        let videoStream = null;
        
        const uploadCard = document.getElementById('uploadCard');
        const viewer = document.getElementById('viewer');
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const overlayLayer = document.getElementById('overlayLayer');
        
        // ==================== æ¨¡å‹é€‰æ‹© ====================
        function selectModelSource(source) {
            currentModelSource = source;
            document.querySelectorAll('.model-option').forEach(el => el.classList.remove('selected'));
            document.getElementById('option' + source.charAt(0).toUpperCase() + source.slice(1).replace('-', '')).classList.add('selected');
            
            const btnText = document.getElementById('primaryBtnText');
            if (source === 'yolo11') btnText.textContent = 'åŠ è½½YOLO11n';
            else if (source === 'yolo11-face') {
                btnText.textContent = 'ä¸Šä¼ äººè„¸æ¨¡å‹';
                setTimeout(() => document.getElementById('modelFileInput').click(), 100);
            } else {
                btnText.textContent = 'é€‰æ‹©æ¨¡å‹æ–‡ä»¶';
                setTimeout(() => document.getElementById('modelFileInput').click(), 100);
            }
        }
        
        function confirmModelSource() {
            if (currentModelSource === 'local' || currentModelSource === 'yolo11-face') {
                document.getElementById('modelFileInput').click();
            } else {
                loadModel();
            }
        }
        
        function skipToDemo() {
            document.getElementById('splash').classList.add('hidden');
            showToast('ğŸ‘‹ è¯·å…ˆåŠ è½½æ¨¡å‹ä»¥å¼€å§‹æ£€æµ‹');
        }
        
        async function loadModel() {
            const source = MODEL_SOURCES[currentModelSource];
            currentModelConfig = source;
            
            document.getElementById('modelSelector').style.display = 'none';
            document.getElementById('loadingStatus').style.display = 'block';
            document.getElementById('loadingBar').style.display = 'block';
            
            try {
                // æ£€æŸ¥ç¼“å­˜
                const cached = await getModelFromCache(source.name);
                if (cached) {
                    await initializeModel(cached, source);
                    return;
                }
                
                // ä¸‹è½½æ¨¡å‹
                document.getElementById('loadingText').textContent = 'æ­£åœ¨ä¸‹è½½æ¨¡å‹...';
                
                const response = await fetch(source.url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const contentLength = response.headers.get('content-length');
                const total = contentLength ? parseInt(contentLength) : 0;
                const reader = response.body.getReader();
                const chunks = [];
                let received = 0;
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    chunks.push(value);
                    received += value.length;
                    
                    if (total > 0) {
                        const percent = ((received / total) * 100).toFixed(0);
                        document.getElementById('loadingProgress').style.width = percent + '%';
                        document.getElementById('loadingDetail').textContent = 
                            `å·²ä¸‹è½½ ${(received/1024/1024).toFixed(1)}MB / ${(total/1024/1024).toFixed(1)}MB`;
                    }
                }
                
                const arrayBuffer = new Uint8Array(received);
                let position = 0;
                for (const chunk of chunks) {
                    arrayBuffer.set(chunk, position);
                    position += chunk.length;
                }
                
                await initializeModel(arrayBuffer.buffer, source);
                
            } catch (error) {
                handleError(error);
            }
        }
        
        async function handleModelFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.onnx')) {
                showToast('âŒ è¯·é€‰æ‹© .onnx æ ¼å¼çš„æ¨¡å‹æ–‡ä»¶');
                return;
            }
            
            document.getElementById('modelSelector').style.display = 'none';
            document.getElementById('loadingStatus').style.display = 'block';
            document.getElementById('loadingBar').style.display = 'block';
            document.getElementById('loadingText').textContent = 'æ­£åœ¨åŠ è½½æ¨¡å‹...';
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const config = {
                    name: file.name,
                    type: 'custom',
                    classes: ['person'],
                    personClassId: 0
                };
                await initializeModel(arrayBuffer, config);
            } catch (error) {
                handleError(error);
            }
        }
        
        async function initializeModel(arrayBuffer, config) {
            document.getElementById('loadingText').textContent = 'æ­£åœ¨åˆå§‹åŒ–æ¨¡å‹...';
            document.getElementById('loadingDetail').textContent = 'è¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ';
            document.getElementById('loadingProgress').style.width = '100%';
            
            const ortConfig = {
                executionProviders: ['wasm'],
                graphOptimizationLevel: 'all',
                wasmOptions: { 
                    numThreads: Math.min(navigator.hardwareConcurrency || 4, 4),
                    simd: true 
                }
            };
            
            session = await ort.InferenceSession.create(arrayBuffer, ortConfig);
            modelLoaded = true;
            currentModelConfig = config;
            
            // ç¼“å­˜æ¨¡å‹
            await saveModelToCache(config.name, arrayBuffer);
            
            // æ›´æ–°UI
            document.getElementById('splash').classList.add('hidden');
            document.getElementById('versionBadge').textContent = config.name;
            document.getElementById('modelStatus').innerHTML = `<span>âœ…</span><span>${config.name}å°±ç»ª</span>`;
            document.getElementById('realtimeBtn').style.display = 'inline-flex';
            
            showToast(`âœ… ${config.name}åŠ è½½æˆåŠŸï¼`);
        }
        
        // ==================== IndexedDBç¼“å­˜ ====================
        async function saveModelToCache(name, data) {
            return new Promise((resolve) => {
                const request = indexedDB.open('PersonDetectorDB', 1);
                request.onupgradeneeded = (e) => {
                    e.target.result.createObjectStore('models', { keyPath: 'name' });
                };
                request.onsuccess = (e) => {
                    const db = e.target.result;
                    const tx = db.transaction('models', 'readwrite');
                    const store = tx.objectStore('models');
                    store.put({ name, data, timestamp: Date.now() });
                    resolve();
                };
                request.onerror = () => resolve();
            });
        }
        
        async function getModelFromCache(name) {
            return new Promise((resolve) => {
                const request = indexedDB.open('PersonDetectorDB', 1);
                request.onupgradeneeded = (e) => {
                    e.target.result.createObjectStore('models', { keyPath: 'name' });
                };
                request.onsuccess = (e) => {
                    const db = e.target.result;
                    const tx = db.transaction('models', 'readonly');
                    const store = tx.objectStore('models');
                    const getReq = store.get(name);
                    getReq.onsuccess = () => resolve(getReq.result?.data);
                    getReq.onerror = () => resolve(null);
                };
                request.onerror = () => resolve(null);
            });
        }
        
        function handleError(error) {
            console.error(error);
            document.getElementById('loadingText').textContent = 'åŠ è½½å¤±è´¥';
            document.getElementById('loadingDetail').textContent = error.message;
            
            setTimeout(() => {
                document.getElementById('modelSelector').style.display = 'block';
                document.getElementById('loadingStatus').style.display = 'none';
                document.getElementById('loadingBar').style.display = 'none';
                document.getElementById('loadingProgress').style.width = '0%';
            }, 2000);
        }
        
        // ==================== å›¾åƒå¤„ç† ====================
        document.getElementById('fileInput').addEventListener('change', handleFile);
        document.getElementById('cameraInput').addEventListener('change', handleFile);
        
        uploadCard.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadCard.classList.add('active');
        });
        uploadCard.addEventListener('dragleave', () => uploadCard.classList.remove('active'));
        uploadCard.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadCard.classList.remove('active');
            if (e.dataTransfer.files.length) processFile(e.dataTransfer.files[0]);
        });
        
        function handleFile(e) {
            if (e.target.files.length) processFile(e.target.files[0]);
        }
        
        function processFile(file) {
            if (!file.type.startsWith('image/')) {
                showToast('âŒ è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    currentImage = img;
                    displayImage(img);
                    detectPersons(img);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
            
            uploadCard.style.display = 'none';
            viewer.classList.add('active');
        }
        
        function displayImage(img) {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            
            document.getElementById('statImageSize').textContent = `${img.width}Ã—${img.height}`;
            
            // è‡ªåŠ¨ç¼©æ”¾é€‚åº”å±å¹•
            const containerWidth = document.getElementById('imageWrapper').clientWidth;
            const scale = Math.min(1, containerWidth / img.width);
            document.getElementById('zoomSlider').value = scale;
            applyZoom();
        }
        
        function applyZoom() {
            const zoom = parseFloat(document.getElementById('zoomSlider').value);
            canvas.style.width = (canvas.width * zoom) + 'px';
            canvas.style.height = (canvas.height * zoom) + 'px';
            renderDetections();
        }
        
        // ==================== äººä½“æ£€æµ‹æ ¸å¿ƒ ====================
        async function detectPersons(img) {
            if (!modelLoaded || !session) {
                showToast('â³ æ¨¡å‹æœªåŠ è½½ï¼Œè¯·å…ˆåŠ è½½æ¨¡å‹');
                return;
            }
            
            document.getElementById('loadingOverlay').classList.add('active');
            const startTime = performance.now();
            
            try {
                const confThreshold = parseFloat(document.getElementById('confThreshold').value);
                const iouThreshold = parseFloat(document.getElementById('iouThreshold').value);
                const inputSize = parseInt(document.getElementById('inputSize').value);
                
                // é¢„å¤„ç†
                const tensor = await preprocessImage(img, inputSize);
                const feeds = {};
                feeds[session.inputNames[0]] = tensor;
                
                // æ¨ç†
                const results = await session.run(feeds);
                const output = results[session.outputNames[0]];
                
                // è§£æç»“æœ - åªä¿ç•™personç±»ï¼ˆç¬¬0ç±»ï¼‰
                const allDetections = parseYOLOOutput(output, confThreshold, iouThreshold, inputSize);
                
                // è¿‡æ»¤åªä¿ç•™personç±»
                detections = allDetections.filter(d => d.classId === 0).map((d, idx) => ({
                    ...d,
                    id: idx,
                    label: 'person',
                    displayLabel: 'äºº'
                }));
                
                tensor.dispose();
                
                const processTime = Math.round(performance.now() - startTime);
                
                // æ›´æ–°ç»Ÿè®¡
                updateStats(processTime);
                
                // æ¸²æŸ“ç»“æœ
                renderDetections();
                
                showToast(`âœ… æ£€æµ‹åˆ° ${detections.length} ä¸ªäºº`);
                
            } catch (error) {
                console.error(error);
                showToast('âŒ æ£€æµ‹å¤±è´¥: ' + error.message);
            }
            
            document.getElementById('loadingOverlay').classList.remove('active');
        }
        
        async function preprocessImage(img, inputSize) {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = inputSize;
            tempCanvas.height = inputSize;
            const tCtx = tempCanvas.getContext('2d');
            
            // å¡«å……ç°è‰²èƒŒæ™¯
            tCtx.fillStyle = '#808080';
            tCtx.fillRect(0, 0, inputSize, inputSize);
            
            // è®¡ç®—ç¼©æ”¾
            const scale = Math.min(inputSize / img.width, inputSize / img.height);
            const newWidth = img.width * scale;
            const newHeight = img.height * scale;
            const padX = (inputSize - newWidth) / 2;
            const padY = (inputSize - newHeight) / 2;
            
            tCtx.drawImage(img, padX, padY, newWidth, newHeight);
            
            const imageData = tCtx.getImageData(0, 0, inputSize, inputSize);
            const data = imageData.data;
            
            // è½¬æ¢ä¸ºCHWæ ¼å¼
            const red = [], green = [], blue = [];
            for (let i = 0; i < data.length; i += 4) {
                red.push(data[i] / 255);
                green.push(data[i + 1] / 255);
                blue.push(data[i + 2] / 255);
            }
            
            const inputData = new Float32Array(red.concat(green).concat(blue));
            return new ort.Tensor('float32', inputData, [1, 3, inputSize, inputSize]);
        }
        
        function parseYOLOOutput(output, confThreshold, iouThreshold, inputSize) {
            const data = output.data;
            const dims = output.dims;
            const boxes = [];
            
            if (dims.length === 3) {
                // [1, 84, 8400] æ ¼å¼
                const numClasses = dims[1] - 4;
                const numBoxes = dims[2];
                
                for (let i = 0; i < numBoxes; i++) {
                    const cx = data[i];
                    const cy = data[numBoxes + i];
                    const w = data[2 * numBoxes + i];
                    const h = data[3 * numBoxes + i];
                    
                    // æ‰¾åˆ°ç½®ä¿¡åº¦æœ€é«˜çš„ç±»åˆ«
                    let maxConf = 0;
                    let classId = 0;
                    for (let c = 0; c < numClasses; c++) {
                        const conf = data[(4 + c) * numBoxes + i];
                        if (conf > maxConf) {
                            maxConf = conf;
                            classId = c;
                        }
                    }
                    
                    if (maxConf > confThreshold) {
                        const x1 = (cx - w / 2) * inputSize;
                        const y1 = (cy - h / 2) * inputSize;
                        const x2 = (cx + w / 2) * inputSize;
                        const y2 = (cy + h / 2) * inputSize;
                        boxes.push({ x1, y1, x2, y2, confidence: maxConf, classId });
                    }
                }
            }
            
            // NMS
            return applyNMS(boxes, iouThreshold);
        }
        
        function applyNMS(boxes, iouThreshold) {
            if (boxes.length === 0) return [];
            boxes.sort((a, b) => b.confidence - a.confidence);
            
            const picked = [];
            const suppressed = new Array(boxes.length).fill(false);
            
            for (let i = 0; i < boxes.length; i++) {
                if (suppressed[i]) continue;
                picked.push(boxes[i]);
                
                for (let j = i + 1; j < boxes.length; j++) {
                    if (suppressed[j]) continue;
                    
                    const x1 = Math.max(boxes[i].x1, boxes[j].x1);
                    const y1 = Math.max(boxes[i].y1, boxes[j].y1);
                    const x2 = Math.min(boxes[i].x2, boxes[j].x2);
                    const y2 = Math.min(boxes[i].y2, boxes[j].y2);
                    
                    const intersection = Math.max(0, x2 - x1) * Math.max(0, y2 - y1);
                    const area1 = (boxes[i].x2 - boxes[i].x1) * (boxes[i].y2 - boxes[i].y1);
                    const area2 = (boxes[j].x2 - boxes[j].x1) * (boxes[j].y2 - boxes[j].y1);
                    const union = area1 + area2 - intersection;
                    
                    if (union > 0 && intersection / union > iouThreshold) {
                        suppressed[j] = true;
                    }
                }
            }
            return picked;
        }
        
        // ==================== æ¸²æŸ“æ£€æµ‹ç»“æœ ====================
        function renderDetections() {
            overlayLayer.innerHTML = '';
            
            const zoom = parseFloat(document.getElementById('zoomSlider').value);
            const showLabels = document.getElementById('showLabels').checked;
            const showConfidence = document.getElementById('showConfidence').checked;
            
            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼ˆä»æ¨¡å‹è¾“å…¥åæ ‡åˆ°åŸå§‹å›¾åƒåæ ‡ï¼‰
            const inputSize = parseInt(document.getElementById('inputSize').value);
            const scaleX = canvas.width / inputSize;
            const scaleY = canvas.height / inputSize;
            
            detections.forEach((det, idx) => {
                // è½¬æ¢åˆ°åŸå§‹å›¾åƒåæ ‡
                const x1 = det.x1 * scaleX;
                const y1 = det.y1 * scaleY;
                const x2 = det.x2 * scaleX;
                const y2 = det.y2 * scaleY;
                
                const width = x2 - x1;
                const height = y2 - y1;
                
                const box = document.createElement('div');
                box.className = 'person-box';
                box.style.left = (x1 * zoom) + 'px';
                box.style.top = (y1 * zoom) + 'px';
                box.style.width = (width * zoom) + 'px';
                box.style.height = (height * zoom) + 'px';
                
                // æ ‡ç­¾
                if (showLabels) {
                    const label = document.createElement('div');
                    label.className = 'person-label';
                    label.textContent = `${idx + 1}. ${det.displayLabel}`;
                    box.appendChild(label);
                }
                
                // ç½®ä¿¡åº¦
                if (showConfidence) {
                    const conf = document.createElement('div');
                    conf.className = 'person-confidence';
                    conf.textContent = `${(det.confidence * 100).toFixed(0)}%`;
                    box.appendChild(conf);
                }
                
                // ç‚¹å‡»äº‹ä»¶
                box.onclick = () => {
                    showToast(`ğŸ‘¤ äººå‘˜ #${idx + 1} | ç½®ä¿¡åº¦: ${(det.confidence * 100).toFixed(1)}%`);
                };
                
                overlayLayer.appendChild(box);
            });
        }
        
        function updateStats(processTime) {
            document.getElementById('statPersonCount').textContent = detections.length;
            document.getElementById('personCount').innerHTML = `<span>ğŸ‘¥</span><span>${detections.length}äºº</span>`;
            
            const avgConf = detections.length > 0 
                ? (detections.reduce((sum, d) => sum + d.confidence, 0) / detections.length * 100).toFixed(0)
                : 0;
            document.getElementById('statAvgConfidence').textContent = avgConf + '%';
            document.getElementById('statProcessTime').textContent = processTime + 'ms';
            
            // è®¡ç®—FPS
            const fps = Math.round(1000 / (processTime || 1));
            document.getElementById('fpsStat').innerHTML = `<span>âš¡</span><span>${fps} FPS</span>`;
        }
        
        // ==================== æ§åˆ¶åŠŸèƒ½ ====================
        document.getElementById('confThreshold').addEventListener('input', (e) => {
            document.getElementById('confValue').textContent = e.target.value;
        });
        
        document.getElementById('iouThreshold').addEventListener('input', (e) => {
            document.getElementById('iouValue').textContent = e.target.value;
        });
        
        document.getElementById('zoomSlider').addEventListener('input', (e) => {
            document.getElementById('zoomValue').textContent = e.target.value;
            applyZoom();
        });
        
        document.getElementById('showLabels').addEventListener('change', renderDetections);
        document.getElementById('showConfidence').addEventListener('change', renderDetections);
        
        function reanalyze() {
            if (currentImage) detectPersons(currentImage);
        }
        
        function saveResult() {
            if (!currentImage || detections.length === 0) {
                showToast('âŒ æ²¡æœ‰å¯ä¿å­˜çš„ç»“æœ');
                return;
            }
            
            const exportCanvas = document.createElement('canvas');
            exportCanvas.width = currentImage.width;
            exportCanvas.height = currentImage.height;
            const eCtx = exportCanvas.getContext('2d');
            
            // ç»˜åˆ¶åŸå›¾
            eCtx.drawImage(currentImage, 0, 0);
            
            // ç»˜åˆ¶æ£€æµ‹æ¡†
            const inputSize = parseInt(document.getElementById('inputSize').value);
            const scaleX = currentImage.width / inputSize;
            const scaleY = currentImage.height / inputSize;
            
            eCtx.strokeStyle = '#00ff88';
            eCtx.lineWidth = 3;
            eCtx.font = 'bold 16px Arial';
            
            detections.forEach((det, idx) => {
                const x1 = det.x1 * scaleX;
                const y1 = det.y1 * scaleY;
                const x2 = det.x2 * scaleX;
                const y2 = det.y2 * scaleY;
                const width = x2 - x1;
                const height = y2 - y1;
                
                // æ¡†
                eCtx.strokeRect(x1, y1, width, height);
                
                // æ ‡ç­¾èƒŒæ™¯
                const label = `${idx + 1}. person ${(det.confidence * 100).toFixed(0)}%`;
                const metrics = eCtx.measureText(label);
                eCtx.fillStyle = 'rgba(0, 255, 136, 0.8)';
                eCtx.fillRect(x1, y1 - 25, metrics.width + 10, 25);
                
                // æ ‡ç­¾æ–‡å­—
                eCtx.fillStyle = '#000';
                eCtx.fillText(label, x1 + 5, y1 - 7);
            });
            
            // ä¸‹è½½
            const link = document.createElement('a');
            link.download = `person_detection_${Date.now()}.png`;
            link.href = exportCanvas.toDataURL('image/png');
            link.click();
            
            showToast('ğŸ’¾ ç»“æœå·²ä¿å­˜');
        }
        
        function copyStats() {
            const stats = `äººä½“æ£€æµ‹ç»“æœï¼š
æ£€æµ‹åˆ°äººæ•°ï¼š${detections.length}
å¹³å‡ç½®ä¿¡åº¦ï¼š${document.getElementById('statAvgConfidence').textContent}
å¤„ç†æ—¶é—´ï¼š${document.getElementById('statProcessTime').textContent}
å›¾åƒå°ºå¯¸ï¼š${document.getElementById('statImageSize').textContent}`;
            
            navigator.clipboard.writeText(stats).then(() => {
                showToast('ğŸ“‹ ç»Ÿè®¡ä¿¡æ¯å·²å¤åˆ¶');
            });
        }
        
        function resetApp() {
            if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰å†…å®¹ï¼Ÿ')) {
                currentImage = null;
                detections = [];
                uploadCard.style.display = 'block';
                viewer.classList.remove('active');
                overlayLayer.innerHTML = '';
                document.getElementById('personCount').innerHTML = '<span>ğŸ‘¥</span><span>0äºº</span>';
            }
        }
        
        function switchModel() {
            document.getElementById('splash').classList.remove('hidden');
            document.getElementById('modelSelector').style.display = 'block';
            document.getElementById('loadingStatus').style.display = 'none';
            document.getElementById('loadingBar').style.display = 'none';
        }
        
        // ==================== å®æ—¶æ£€æµ‹ï¼ˆå¯é€‰ï¼‰ ====================
        async function startRealtimeDetection() {
            if (!modelLoaded) {
                showToast('â³ è¯·å…ˆåŠ è½½æ¨¡å‹');
                return;
            }
            
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: 640, height: 480 } 
                });
                
                const video = document.createElement('video');
                video.srcObject = videoStream;
                video.autoplay = true;
                
                video.onloadedmetadata = () => {
                    isRealtime = true;
                    uploadCard.style.display = 'none';
                    viewer.classList.add('active');
                    
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    const realtimeLoop = async () => {
                        if (!isRealtime) return;
                        
                        ctx.drawImage(video, 0, 0);
                        
                        // æ¯3å¸§æ£€æµ‹ä¸€æ¬¡ä»¥èŠ‚çœæ€§èƒ½
                        if (Date.now() % 3 === 0) {
                            await detectPersonsRealtime(video);
                        }
                        
                        requestAnimationFrame(realtimeLoop);
                    };
                    
                    realtimeLoop();
                };
                
            } catch (error) {
                showToast('âŒ æ— æ³•è®¿é—®æ‘„åƒå¤´: ' + error.message);
            }
        }
        
        async function detectPersonsRealtime(video) {
            // ç®€åŒ–ç‰ˆå®æ—¶æ£€æµ‹ï¼ˆé™ä½åˆ†è¾¨ç‡ä»¥æé«˜é€Ÿåº¦ï¼‰
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = 320;
            tempCanvas.height = 320;
            const tCtx = tempCanvas.getContext('2d');
            tCtx.drawImage(video, 0, 0, 320, 320);
            
            const imgData = tCtx.getImageData(0, 0, 320, 320);
            // è¿™é‡Œå¯ä»¥æ·»åŠ å®æ—¶æ¨ç†é€»è¾‘ï¼Œä½†ä¸ºæ€§èƒ½è€ƒè™‘å»ºè®®é™ä½é¢‘ç‡
        }
        
        function stopRealtime() {
            isRealtime = false;
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
        }
        
        // ==================== å·¥å…·å‡½æ•° ====================
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°ç¼©æ”¾
        window.addEventListener('resize', () => {
            if (currentImage) applyZoom();
        });
    </script>
</body>
</html>
